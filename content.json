{"posts":[{"title":"Spring Security åŸºäºæ•°æ®åº“ &amp; åŠ¨æ€é…ç½®æƒé™","text":"[TOC] RBACæƒé™è®¾è®¡æ€æƒ³ä¸ºäº†è¾¾æˆä¸åŒè´¦å·(å‘˜å·¥ï¼Œç»ç†ï¼ŒBOSS)ç™»å½•ç³»ç»Ÿåèƒ½çœ‹åˆ°ä¸åŒé¡µé¢ï¼Œæ‰§è¡Œä¸åŒçš„åŠŸèƒ½ï¼ŒRBAC(Role-Based-Access-Control)æƒé™æ¨¡å‹ï¼Œå°±æ˜¯æ ¹æ®è§’è‰²çš„æƒé™ï¼Œåˆ†é…å¯è§†é¡µé¢ã€‚ ä¸‰ä¸ªå…³é”®ç‚¹ï¼šç”¨æˆ·:ä½¿ç”¨ç³»ç»Ÿçš„äººè§’è‰²ï¼šä½¿ç”¨ç³»ç»Ÿçš„äººæ˜¯ä»€ä¹ˆèŒä½(å‘˜å·¥ï¼Œç»ç†ï¼ŒBOSS)æƒé™ç‚¹ï¼šèŒä½å¯ä»¥åšçš„äº‹æƒ…(å·¦ä¾§èœå•æ ä¸­çš„åŠŸèƒ½æ¨¡å—â€”â€”&gt;å¢åˆ æ”¹æŸ¥) æµ‹è¯•æµç¨‹ï¼šâ‘ åœ¨å‘˜å·¥ç®¡ç†é¡µæ–°å¢å‘˜å·¥è¿™æ˜¯ä¸‰è¦ç´ ä¸­çš„ç”¨æˆ·â‘¡ä¸ºæ–°å¢çš„å‘˜å·¥åˆ†é…è§’è‰²â‘¢åœ¨å…¬å¸è®¾ç½®é‡Œä¸ºè§’è‰²åˆ†é…æƒé™ ğŸ’¢ç³»ç»Ÿä¸­çš„æƒé™ä¸èƒ½éšæ„æ·»åŠ ï¼Œå¿…é¡»æ˜¯ä»¥å¼€å‘å‡ºæ¥çš„æƒé™ï¼ˆå·¦ä¾§èœå•æ é‡Œå¯å®ç°çš„é¡µé¢ï¼‰ğŸ’¢ç”¨æˆ·å’Œè§’è‰²ä¹‹é—´æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œä¸€ä¸ªäººèº«å…¼æ•°èŒã€‚ æ•°æ®åº“è®¾è®¡ï¼šæœ¬æ¡ˆä¾‹æ•°æ®åº“è®¾è®¡å…±æ¶‰åŠäº”å¼ è¡¨ï¼šuser role user_role menu menu_role 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109/* Navicat Premium Data Transfer Source Server : æœ¬åœ° Source Server Type : MySQL Source Server Version : 50734 Source Host : localhost:3306 Source Schema : security Target Server Type : MySQL Target Server Version : 50734 File Encoding : 65001 Date: 24/08/2022 15:36:45*/SET NAMES utf8mb4;SET FOREIGN_KEY_CHECKS = 0;-- ------------------------------ Table structure for menu-- ----------------------------DROP TABLE IF EXISTS `menu`;CREATE TABLE `menu` ( `id` int(8) NOT NULL AUTO_INCREMENT, `pattern` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL, PRIMARY KEY (`id`) USING BTREE) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;-- ------------------------------ Records of menu-- ------------------------------ ------------------------------ Table structure for menu_role-- ----------------------------DROP TABLE IF EXISTS `menu_role`;CREATE TABLE `menu_role` ( `id` int(11) NOT NULL AUTO_INCREMENT, `mid` int(11) NOT NULL, `rid` int(11) NOT NULL, PRIMARY KEY (`id`) USING BTREE) ENGINE = InnoDB AUTO_INCREMENT = 4 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;-- ------------------------------ Records of menu_role-- ----------------------------INSERT INTO `menu_role` VALUES (1, 1, 1);INSERT INTO `menu_role` VALUES (2, 2, 2);INSERT INTO `menu_role` VALUES (3, 3, 3);-- ------------------------------ Table structure for role-- ----------------------------DROP TABLE IF EXISTS `role`;CREATE TABLE `role` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL, `nameZh` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL, PRIMARY KEY (`id`) USING BTREE) ENGINE = InnoDB AUTO_INCREMENT = 4 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;-- ------------------------------ Records of role-- ----------------------------INSERT INTO `role` VALUES (1, 'ROLE_dba', 'æ•°æ®åº“ç®¡ç†å‘˜');INSERT INTO `role` VALUES (2, 'ROLE_admin', 'ç³»ç»Ÿç®¡ç†å‘˜');INSERT INTO `role` VALUES (3, 'ROLE_user', 'ç”¨æˆ·');-- ------------------------------ Table structure for user-- ----------------------------DROP TABLE IF EXISTS `user`;CREATE TABLE `user` ( `id` int(11) NOT NULL AUTO_INCREMENT, `username` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL, `password` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL, `enabled` tinyint(1) NULL DEFAULT NULL, `locked` tinyint(1) NULL DEFAULT NULL, PRIMARY KEY (`id`) USING BTREE) ENGINE = InnoDB AUTO_INCREMENT = 4 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;-- ------------------------------ Records of user-- ----------------------------INSERT INTO `user` VALUES (1, 'root', '$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq', 1, 0);INSERT INTO `user` VALUES (2, 'admin', '$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq', 1, 0);INSERT INTO `user` VALUES (3, 'sang', '$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq', 1, 0);-- ------------------------------ Table structure for user_role-- ----------------------------DROP TABLE IF EXISTS `user_role`;CREATE TABLE `user_role` ( `id` int(11) NOT NULL AUTO_INCREMENT, `uid` int(11) NULL DEFAULT NULL, `rid` int(11) NULL DEFAULT NULL, PRIMARY KEY (`id`) USING BTREE) ENGINE = InnoDB AUTO_INCREMENT = 5 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;-- ------------------------------ Records of user_role-- ----------------------------INSERT INTO `user_role` VALUES (1, 1, 1);INSERT INTO `user_role` VALUES (2, 1, 2);INSERT INTO `user_role` VALUES (3, 2, 2);INSERT INTO `user_role` VALUES (4, 3, 3);SET FOREIGN_KEY_CHECKS = 1; é¡¹ç›®åˆ›å»ºä»£ç ä¿®æ”¹ç›¸è¾ƒäºä¸Šä¸€ä¸ªé¡¹ç›®æ·»åŠ äº†ä¸€ä¸ªå®ä½“ç±»ç›¸å…³ä»£ç  Menu.java 12345678910111213@Data@NoArgsConstructor@AllArgsConstructor@Accessors(chain = true)@ToString(callSuper = true)@TableName(value = &quot;menu&quot;,resultMap = &quot;menuWithRolesMap&quot;)public class Menu { @TableId(type = IdType.AUTO) private Integer id; private String pattern; private List&lt;Role&gt; roles;} MenuMapper 123456789&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;&lt;mapper namespace=&quot;com.wenx.security.dynamic.mapper.MenuMapper&quot;&gt; &lt;resultMap id=&quot;menuWithRolesMap&quot; type=&quot;com.wenx.security.dynamic.bean.Menu&quot;&gt; &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt; &lt;result column=&quot;pattern&quot; property=&quot;pattern&quot;/&gt; &lt;collection property=&quot;roles&quot; column=&quot;id&quot; select=&quot;com.wenx.security.dynamic.mapper.RoleMapper.selectRolesByMid&quot;/&gt; &lt;/resultMap&gt;&lt;/mapper&gt; ä¿®æ”¹RoleMapper.xml 123456789101112&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;&lt;mapper namespace=&quot;com.wenx.security.dynamic.mapper.RoleMapper&quot;&gt; &lt;select id=&quot;selectRolesByUid&quot; resultType=&quot;com.wenx.security.dynamic.bean.Role&quot;&gt; select r.* from role r,user u,user_role ur where u.id=ur.uid and r.id=ur.rid and u.id = #{uid} &lt;/select&gt; &lt;select id=&quot;selectRolesByMid&quot; resultType=&quot;com.wenx.security.dynamic.bean.Role&quot;&gt; select r.* from role r,menu m,menu_role mr where m.id=mr.mid and r.id=mr.rid and m.id = #{mid} &lt;/select&gt;&lt;/mapper&gt; é‡å†™ FilterInvocationSecurityMetadataSourceMyFiletr.java 12345678910111213141516171819202122232425262728293031323334353637383940/** * @author æ¸©ç¬™ */@Componentpublic class MyFilter implements FilterInvocationSecurityMetadataSource { // è·¯å¾„è§„åˆ™åŒ¹é…å™¨ AntPathMatcher antPathMatcher = new AntPathMatcher(); @Autowired MenuMapper menuMapper; @Override public Collection&lt;ConfigAttribute&gt; getAttributes(Object object) throws IllegalArgumentException { String requestUrl = ((FilterInvocation) object).getRequestUrl(); List&lt;Menu&gt; menus = menuMapper.selectList(null); for (Menu menu : menus) { if(antPathMatcher.match(menu.getPattern(),requestUrl)){ List&lt;Role&gt; roles = menu.getRoles(); String[] rolesStr = new String[roles.size()]; for (int i = 0; i &lt; roles.size(); i++) { rolesStr[i]=roles.get(i).getName(); } return SecurityConfig.createList(rolesStr); } } return SecurityConfig.createList(&quot;ROLE_login&quot;); } @Override public Collection&lt;ConfigAttribute&gt; getAllConfigAttributes() { return null; } @Override public boolean supports(Class&lt;?&gt; clazz) { return false; }} ç”¨æˆ·æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šè¿›å…¥getAttributesè¿™ä¸ªæ–¹æ³•ä¸­ï¼Œé€šè¿‡è·¯å¾„åŒ¹é…å™¨è¿›è¡ŒåŒ¹é…ï¼Œå°†å¯¹åº”çš„æƒé™å­—ç¬¦ä¸²è¿›è¡Œè¿”å›ï¼Œå¦‚æœåŒ¹é…ä¸åˆ°å°±è¿”å›ä¸€ä¸ªROLE_loginæ ‡å¿—ç¬¦ï¼Œåç»­è¿›è¡Œåˆ¤æ–­æ”¾è¡Œã€‚ é‡å†™å†³ç­–ç®¡ç†å™¨AccessDecisionManager1234567891011121314151617181920212223242526272829303132333435@Componentpublic class MyAccessDecisionManager implements AccessDecisionManager { @Override public void decide(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; configAttributes) throws AccessDeniedException, InsufficientAuthenticationException { for (ConfigAttribute attribute : configAttributes) { if(&quot;ROLE_login&quot;.equals(attribute.getAttribute())){ if(authentication instanceof AnonymousAuthenticationToken){ throw new AccessDeniedException(&quot;éæ³•è¯·æ±‚&quot;); }else{ return; } } Collection&lt;? extends GrantedAuthority&gt; authorities = authentication.getAuthorities(); for (GrantedAuthority authority : authorities) { if(authority.getAuthority().equals(attribute.getAttribute())){ return; } } } throw new AccessDeniedException(&quot;éæ³•è¯·æ±‚&quot;); } @Override public boolean supports(ConfigAttribute attribute) { return true; } @Override public boolean supports(Class&lt;?&gt; clazz) { return true; }} é…ç½®ç±»12345678910111213141516171819202122232425262728293031323334353637383940@EnableWebSecuritypublic class SecurityConfig extends WebSecurityConfigurerAdapter { @Resource UserService userService; @Autowired MyFilter myFilter; @Autowired MyAccessDecisionManager myAccessDecisionManager; @Bean PasswordEncoder passwordEncoder(){ return new BCryptPasswordEncoder(); } @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { auth.userDetailsService(userService); } @Override protected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .withObjectPostProcessor(new ObjectPostProcessor&lt;FilterSecurityInterceptor&gt;() { @Override public &lt;O extends FilterSecurityInterceptor&gt; O postProcess(O object) { object.setAccessDecisionManager(myAccessDecisionManager); object.setSecurityMetadataSource(myFilter); return object; } }) .and() .formLogin() .permitAll() .and() .csrf().disable(); }} æºç åˆ†æé¦–å…ˆåœ¨ Spring Security ä¸­çš„æƒé™æ§åˆ¶æœ‰ä¸¤ç§ä¸åŒçš„æ–¹å¼ï¼š é€šè¿‡ URL è¯·æ±‚åœ°å€è¿›è¡Œæ§åˆ¶ã€‚ é€šè¿‡æ–¹æ³•è¿›è¡Œæ§åˆ¶ã€‚ å¦‚æœé€šè¿‡ URL è¯·æ±‚åœ°å€è¿›è¡Œæ§åˆ¶ï¼Œè´Ÿè´£æ§åˆ¶ç±»é…ç½®çš„æ˜¯ AbstractInterceptUrlConfigurerï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„å­ç±»ï¼š 123# AbstractInterceptUrlConfigurer## UrlAuthorizationConfigurer## ExpressionUrlAuthorizationConfigurer å¯ä»¥çœ‹åˆ°å®ƒæœ‰ä¸¤ä¸ªå­ç±»ï¼š ExpressionUrlAuthorizationConfigurer UrlAuthorizationConfigurer ä¸¤ä¸ªéƒ½å¯ä»¥å¤„ç†åŸºäº URL è¯·æ±‚åœ°å€çš„æƒé™æ§åˆ¶ã€‚ä¸åŒçš„æ˜¯ï¼Œç¬¬ä¸€ä¸ª ExpressionUrlAuthorizationConfigureræ”¯æŒæƒé™è¡¨è¾¾å¼ï¼Œç¬¬äºŒä¸ªä¸æ”¯æŒã€‚ UrlAuthorizationConfigurer ä¸æ”¯æŒæƒé™è¡¨è¾¾å¼ï¼Œæ˜¯å› ä¸ºå®ƒä½¿ç”¨çš„æŠ•ç¥¨å™¨æ˜¯ RoleVoter å’Œ AuthenticatedVoterï¼Œè¿™ä¸¤è€…å¯ä»¥ç”¨æ¥å¤„ç†è§’è‰²æˆ–è€…æƒé™ï¼Œä½†æ˜¯æ²¡æ³•å¤„ç†æƒé™è¡¨è¾¾å¼ã€‚ ä¸Šé¢è¯´çš„éƒ½æ˜¯é»˜è®¤è¡Œä¸ºï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®ï¼Œè®© UrlAuthorizationConfigurer æ”¯æŒæƒé™è¡¨è¾¾å¼ï¼Œä¸è¿‡ä¸€èˆ¬æ¥è¯´æ²¡å¿…è¦è¿™æ ·åšï¼Œå¦‚æœéœ€è¦æ”¯æŒæƒé™è¡¨è¾¾å¼ï¼Œç›´æ¥ç”¨ ExpressionUrlAuthorizationConfigurer å³å¯ã€‚ å½“æˆ‘ä»¬è°ƒç”¨å¦‚ä¸‹è¿™è¡Œä»£ç æ—¶ï¼š 1http.authorizeRequests() å®é™…ä¸Šå°±æ˜¯é€šè¿‡ ExpressionUrlAuthorizationConfigurer å»é…ç½®åŸºäº URL è¯·æ±‚åœ°å€çš„æƒé™æ§åˆ¶ï¼Œæ‰€ä»¥å®ƒæ˜¯æ”¯æŒæƒé™è¡¨è¾¾å¼çš„ã€‚ä¾‹å¦‚ä¸‹é¢è¿™æ®µå¤§å®¶å†ç†Ÿæ‚‰ä¸è¿‡çš„ä»£ç ï¼š 1234http.authorizeRequests() .antMatchers(&quot;/admin/**&quot;).hasRole(&quot;ADMIN&quot;) .antMatchers(&quot;/user/**&quot;).access(&quot;hasRole('USER')&quot;) åœ¨ ExpressionUrlAuthorizationConfigurer ä¸­åˆ›å»º SecurityMetadataSource æ—¶ï¼Œå°±ä¼šæ£€æŸ¥æ˜ å°„å…³ç³»ï¼Œå¦‚æœ requestMap ä¸ºç©ºå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š 123456789101112@OverrideExpressionBasedFilterInvocationSecurityMetadataSource createMetadataSource( H http) { LinkedHashMap&lt;RequestMatcher, Collection&lt;ConfigAttribute&gt;&gt; requestMap = REGISTRY .createRequestMap(); if (requestMap.isEmpty()) { throw new IllegalStateException( &quot;At least one mapping is required (i.e. authorizeRequests().anyRequest().authenticated())&quot;); } return new ExpressionBasedFilterInvocationSecurityMetadataSource(requestMap, getExpressionHandler(http));} UrlAuthorizationConfigurer ä¸­ä¹Ÿæœ‰ createMetadataSource æ–¹æ³•ï¼Œä½†æ˜¯å´æ˜¯å¦å¤–ä¸€å¥—å®ç°æ–¹æ¡ˆï¼š 12345@OverrideFilterInvocationSecurityMetadataSource createMetadataSource(H http) { return new DefaultFilterInvocationSecurityMetadataSource( REGISTRY.createRequestMap());} UrlAuthorizationConfigurer å¹¶ä¸ä¼šæ£€æŸ¥ requestMap æ˜¯å¦ä¸ºç©ºï¼Œä½†æ˜¯å®ƒä¼šåœ¨ createRequestMap æ–¹æ³•ä¸­æ£€æŸ¥ä¸€ä¸‹æ˜ å°„å…³ç³»æ˜¯å¦å®Œæ•´ï¼Œä¾‹å¦‚ä¸‹é¢è¿™æ ·ï¼š 123.antMatchers(&quot;/admin/**&quot;).access(&quot;ROLE_ADMIN&quot;).mvcMatchers(&quot;/user/**&quot;).access(&quot;ROLE_USER&quot;).antMatchers(&quot;/getinfo&quot;); æœ€åçš„ /getinfo æ²¡æœ‰æŒ‡å®šéœ€è¦çš„æƒé™ï¼Œè¿™ç§å°±æ˜¯ä¸å®Œæ•´ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ ExpressionUrlAuthorizationConfigurer ä¼šè¦æ±‚è‡³å°‘é…ç½®ä¸€ä¸ªæ˜ å°„å…³ç³»ï¼ŒUrlAuthorizationConfigurer åˆ™æ— æ­¤è¦æ±‚ã€‚","link":"/2022/08/24/03-security-%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E6%9D%83%E9%99%90/"},{"title":"Spring Security åŸºæœ¬é…ç½®","text":"1.æ–°å»ºé¡¹ç›®é¦–å…ˆæ–°å»ºä¸€ä¸ª Spring Boot é¡¹ç›®ï¼Œåˆ›å»ºæ—¶å¼•å…¥ Spring Security ä¾èµ–å’Œ web ä¾èµ– 12345678910&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt;&lt;/dependencies&gt; é¡¹ç›®åˆ›å»ºæˆåŠŸåï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæµ‹è¯•çš„ HelloControllerï¼Œå†…å®¹å¦‚ä¸‹ï¼š 12345678@RestControllerpublic class HelloController { @GetMapping(&quot;/hello&quot;) public String hello(){ return &quot;SECURITY&quot;; }} æ¥ä¸‹æ¥ä»€ä¹ˆäº‹æƒ…éƒ½ä¸ç”¨åšï¼Œæˆ‘ä»¬ç›´æ¥æ¥å¯åŠ¨é¡¹ç›®ã€‚ åœ¨é¡¹ç›®å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°å¦‚ä¸‹ä¸€è¡Œæ—¥å¿—ï¼š 1Using generated security password: 30abfb1f-36e1-446a-a79b-f70024f589ab è¿™å°±æ˜¯ Spring Security ä¸ºé»˜è®¤ç”¨æˆ· user ç”Ÿæˆçš„ä¸´æ—¶å¯†ç ï¼Œæ˜¯ä¸€ä¸ª UUID å­—ç¬¦ä¸²ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬å»è®¿é—® http://localhost:8080/hello æ¥å£ï¼Œå°±å¯ä»¥çœ‹åˆ°è‡ªåŠ¨é‡å®šå‘åˆ°ç™»å½•é¡µé¢äº† åœ¨ç™»å½•é¡µé¢ï¼Œé»˜è®¤çš„ç”¨æˆ·åå°±æ˜¯ userï¼Œé»˜è®¤çš„ç™»å½•å¯†ç åˆ™æ˜¯é¡¹ç›®å¯åŠ¨æ—¶æ§åˆ¶å°æ‰“å°å‡ºæ¥çš„å¯†ç ï¼Œè¾“å…¥ç”¨æˆ·åå¯†ç ä¹‹åï¼Œå°±ç™»å½•æˆåŠŸäº†ï¼Œç™»å½•æˆåŠŸåï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¿é—®åˆ° /hello æ¥å£äº†ã€‚ åœ¨ Spring Security ä¸­ï¼Œé»˜è®¤çš„ç™»å½•é¡µé¢å’Œç™»å½•æ¥å£ï¼Œéƒ½æ˜¯ /login ï¼Œåªä¸è¿‡ä¸€ä¸ªæ˜¯ get è¯·æ±‚ï¼ˆç™»å½•é¡µé¢ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯ post è¯·æ±‚ï¼ˆç™»å½•æ¥å£ï¼‰ã€‚ å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œéå¸¸æ–¹ä¾¿ï¼Œä¸€ä¸ªä¾èµ–å°±ä¿æŠ¤äº†æ‰€æœ‰æ¥å£ã€‚ æœ‰äººè¯´ï¼Œä½ æ€ä¹ˆçŸ¥é“çŸ¥é“ç”Ÿæˆçš„é»˜è®¤å¯†ç æ˜¯ä¸€ä¸ª UUID å‘¢ï¼Ÿ è¿™ä¸ªå…¶å®å¾ˆå¥½åˆ¤æ–­ã€‚ å’Œç”¨æˆ·ç›¸å…³çš„è‡ªåŠ¨åŒ–é…ç½®ç±»åœ¨ UserDetailsServiceAutoConfiguration é‡Œè¾¹ï¼Œåœ¨è¯¥ç±»çš„ getOrDeducePassword æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°å¦‚ä¸‹ä¸€è¡Œæ—¥å¿—ï¼š 123if (user.isPasswordGenerated()) { logger.info(String.format(&quot;%n%nUsing generated security password: %s%n&quot;, user.getPassword()));} æ¯«æ— ç–‘é—®ï¼Œæˆ‘ä»¬åœ¨æ§åˆ¶å°çœ‹åˆ°çš„æ—¥å¿—å°±æ˜¯ä»è¿™é‡Œæ‰“å°å‡ºæ¥çš„ã€‚æ‰“å°çš„æ¡ä»¶æ˜¯ isPasswordGenerated æ–¹æ³•è¿”å› trueï¼Œå³å¯†ç æ˜¯é»˜è®¤ç”Ÿæˆçš„ã€‚ è¿›è€Œæˆ‘ä»¬å‘ç°ï¼Œuser.getPassword å‡ºç°åœ¨ SecurityProperties ä¸­ï¼Œåœ¨ SecurityProperties ä¸­æˆ‘ä»¬çœ‹åˆ°å¦‚ä¸‹å®šä¹‰ï¼š 123456789/** * Default user name. */private String name = &quot;user&quot;;/** * Password for the default user name. */private String password = UUID.randomUUID().toString();private boolean passwordGenerated = true; å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤çš„ç”¨æˆ·åå°±æ˜¯ userï¼Œé»˜è®¤çš„å¯†ç åˆ™æ˜¯ UUIDï¼Œè€Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒpasswordGenerated ä¹Ÿä¸º trueã€‚ 2.ç”¨æˆ·é…ç½®é»˜è®¤çš„å¯†ç æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ¯æ¬¡é‡å¯é¡¹ç›®éƒ½ä¼šå˜ï¼Œè¿™å¾ˆä¸æ–¹ä¾¿ã€‚ åœ¨æ­£å¼ä»‹ç»æ•°æ®åº“è¿æ¥ä¹‹å‰ï¼Œæ¾å“¥å…ˆå’Œå¤§å®¶ä»‹ç»ä¸¤ç§éä¸»æµçš„ç”¨æˆ·å/å¯†ç é…ç½®æ–¹æ¡ˆã€‚ 2.1 é…ç½®æ–‡ä»¶æˆ‘ä»¬å¯ä»¥åœ¨ application.properties ä¸­é…ç½®é»˜è®¤çš„ç”¨æˆ·åå¯†ç ã€‚ æ€ä¹ˆé…ç½®å‘¢ï¼Ÿå¤§å®¶è¿˜è®°å¾—ä¸Šä¸€å°èŠ‚æˆ‘ä»¬è¯´çš„ SecurityPropertiesï¼Œé»˜è®¤çš„ç”¨æˆ·å°±å®šä¹‰åœ¨å®ƒé‡Œè¾¹ï¼Œæ˜¯ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œæˆ‘ä»¬å¦‚æœè¦å®šä¹‰è‡ªå·±çš„ç”¨æˆ·åå¯†ç ï¼Œå¿…ç„¶æ˜¯è¦å»è¦†ç›–é»˜è®¤é…ç½®ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ SecurityProperties çš„å®šä¹‰ï¼š 12@ConfigurationProperties(prefix = &quot;spring.security&quot;)public class SecurityProperties { è¿™å°±å¾ˆæ¸…æ™°äº†ï¼Œæˆ‘ä»¬åªéœ€è¦ä»¥ spring.security.user ä¸ºå‰ç¼€ï¼Œå»å®šä¹‰ç”¨æˆ·åå¯†ç å³å¯ï¼š 123spring.security.user.name=userspring.security.user.password=123spring.security.user.roles=admin è¿™å°±æ˜¯æˆ‘ä»¬æ–°å®šä¹‰çš„ç”¨æˆ·åå¯†ç ã€‚ åœ¨ properties ä¸­å®šä¹‰çš„ç”¨æˆ·åå¯†ç æœ€ç»ˆæ˜¯é€šè¿‡ set æ–¹æ³•æ³¨å…¥åˆ°å±æ€§ä¸­å»çš„ï¼Œè¿™é‡Œæˆ‘ä»¬é¡ºä¾¿æ¥çœ‹ä¸‹ SecurityProperties.User#setPassword æ–¹æ³•: ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œapplication.properties ä¸­å®šä¹‰çš„å¯†ç åœ¨æ³¨å…¥è¿›æ¥ä¹‹åï¼Œè¿˜é¡ºä¾¿è®¾ç½®äº† passwordGenerated å±æ€§ä¸º falseï¼Œè¿™ä¸ªå±æ€§è®¾ç½®ä¸º false ä¹‹åï¼Œæ§åˆ¶å°å°±ä¸ä¼šæ‰“å°é»˜è®¤çš„å¯†ç äº†ã€‚ æ­¤æ—¶é‡å¯é¡¹ç›®ï¼Œå°±å¯ä»¥ä½¿ç”¨è‡ªå·±å®šä¹‰çš„ç”¨æˆ·å/å¯†ç ç™»å½•äº†ã€‚ 2.2 é…ç½®ç±»é™¤äº†ä¸Šé¢çš„é…ç½®æ–‡ä»¶è¿™ç§æ–¹å¼ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨é…ç½®ç±»ä¸­é…ç½®ç”¨æˆ·å/å¯†ç ã€‚ åœ¨é…ç½®ç±»ä¸­é…ç½®ï¼Œæˆ‘ä»¬å°±è¦æŒ‡å®š PasswordEncoder äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„ä¸œè¥¿ã€‚ è€ƒè™‘åˆ°æœ‰çš„å°ä¼™ä¼´å¯¹äº PasswordEncoder è¿˜ä¸å¤ªç†Ÿæ‚‰ï¼Œå› æ­¤ï¼Œæˆ‘è¿™é‡Œå…ˆç¨å¾®ç»™å¤§å®¶ä»‹ç»ä¸€ä¸‹ PasswordEncoder åˆ°åº•æ˜¯å¹²å˜›ç”¨çš„ã€‚è¦è¯´ PasswordEncoder ï¼Œå°±å¾—å…ˆè¯´å¯†ç åŠ å¯†ã€‚ 2.2.1 ä¸ºä»€ä¹ˆè¦åŠ å¯†2011 å¹´ 12 æœˆ 21 æ—¥ï¼Œæœ‰äººåœ¨ç½‘ç»œä¸Šå…¬å¼€äº†ä¸€ä¸ªåŒ…å« 600 ä¸‡ä¸ª CSDN ç”¨æˆ·èµ„æ–™çš„æ•°æ®åº“ï¼Œæ•°æ®å…¨éƒ¨ä¸ºæ˜æ–‡å‚¨å­˜ï¼ŒåŒ…å«ç”¨æˆ·åã€å¯†ç ä»¥åŠæ³¨å†Œé‚®ç®±ã€‚äº‹ä»¶å‘ç”Ÿå CSDN åœ¨å¾®åšã€å®˜æ–¹ç½‘ç«™ç­‰æ¸ é“å‘å‡ºäº†å£°æ˜ï¼Œè§£é‡Šè¯´æ­¤æ•°æ®åº“ç³» 2009 å¹´å¤‡ä»½æ‰€ç”¨ï¼Œå› ä¸æ˜åŸå› æ³„éœ²ï¼Œå·²ç»å‘è­¦æ–¹æŠ¥æ¡ˆï¼Œååˆåœ¨å®˜ç½‘å‘å‡ºäº†å…¬å¼€é“æ­‰ä¿¡ã€‚åœ¨æ¥ä¸‹æ¥çš„åå¤šå¤©é‡Œï¼Œé‡‘å±±ã€ç½‘æ˜“ã€äº¬ä¸œã€å½“å½“ã€æ–°æµªç­‰å¤šå®¶å…¬å¸è¢«å·å…¥åˆ°è¿™æ¬¡äº‹ä»¶ä¸­ã€‚æ•´ä¸ªäº‹ä»¶ä¸­æœ€è§¦ç›®æƒŠå¿ƒçš„è«è¿‡äº CSDN æŠŠç”¨æˆ·å¯†ç æ˜æ–‡å­˜å‚¨ï¼Œç”±äºå¾ˆå¤šç”¨æˆ·æ˜¯å¤šä¸ªç½‘ç«™å…±ç”¨ä¸€ä¸ªå¯†ç ï¼Œå› æ­¤ä¸€ä¸ªç½‘ç«™å¯†ç æ³„éœ²å°±ä¼šé€ æˆå¾ˆå¤§çš„å®‰å…¨éšæ‚£ã€‚ç”±äºæœ‰äº†è¿™ä¹ˆå¤šå‰è½¦ä¹‹é‰´ï¼Œæˆ‘ä»¬ç°åœ¨åšç³»ç»Ÿæ—¶ï¼Œå¯†ç éƒ½è¦åŠ å¯†å¤„ç†ã€‚ è¿™æ¬¡æ³„å¯†ï¼Œä¹Ÿç•™ä¸‹äº†ä¸€äº›æœ‰è¶£çš„äº‹æƒ…ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå¹¿å¤§ç¨‹åºå‘˜è®¾ç½®å¯†ç è¿™ä¸€é¡¹ã€‚äººä»¬ä» CSDN æ³„å¯†çš„æ–‡ä»¶ä¸­ï¼Œå‘ç°äº†ä¸€äº›å¥½ç©çš„å¯†ç ï¼Œä¾‹å¦‚å¦‚ä¸‹è¿™äº›ï¼š ppnn13%dkstFeb.1st è¿™æ®µå¯†ç çš„ä¸­æ–‡è§£ææ˜¯ï¼šå¨‰å¨‰è¢…è¢…åä¸‰ä½™ï¼Œè±†è”»æ¢¢å¤´äºŒæœˆåˆã€‚ csbt34.ydhl12s è¿™æ®µå¯†ç çš„ä¸­æ–‡è§£ææ˜¯ï¼šæ± ä¸Šç¢§è‹”ä¸‰å››ç‚¹ï¼Œå¶åº•é»„é¹‚ä¸€ä¸¤å£° â€¦ ç­‰ç­‰ä¸ä¸€è€Œè¶³ï¼Œä½ ä¼šå‘ç°å¾ˆå¤šç¨‹åºå‘˜çš„äººæ–‡ç´ å…»è¿˜æ˜¯éå¸¸é«˜çš„ï¼Œè®©äººå•§å•§ç§°å¥‡ã€‚ 2.2.2 åŠ å¯†æ–¹æ¡ˆå¯†ç åŠ å¯†æˆ‘ä»¬ä¸€èˆ¬ä¼šç”¨åˆ°æ•£åˆ—å‡½æ•°ï¼Œåˆç§°æ•£åˆ—ç®—æ³•ã€å“ˆå¸Œå‡½æ•°ï¼Œè¿™æ˜¯ä¸€ç§ä»ä»»ä½•æ•°æ®ä¸­åˆ›å»ºæ•°å­—â€œæŒ‡çº¹â€çš„æ–¹æ³•ã€‚æ•£åˆ—å‡½æ•°æŠŠæ¶ˆæ¯æˆ–æ•°æ®å‹ç¼©æˆæ‘˜è¦ï¼Œä½¿å¾—æ•°æ®é‡å˜å°ï¼Œå°†æ•°æ®çš„æ ¼å¼å›ºå®šä¸‹æ¥ï¼Œç„¶åå°†æ•°æ®æ‰“ä¹±æ··åˆï¼Œé‡æ–°åˆ›å»ºä¸€ä¸ªæ•£åˆ—å€¼ã€‚æ•£åˆ—å€¼é€šå¸¸ç”¨ä¸€ä¸ªçŸ­çš„éšæœºå­—æ¯å’Œæ•°å­—ç»„æˆçš„å­—ç¬¦ä¸²æ¥ä»£è¡¨ã€‚å¥½çš„æ•£åˆ—å‡½æ•°åœ¨è¾“å…¥åŸŸä¸­å¾ˆå°‘å‡ºç°æ•£åˆ—å†²çªã€‚åœ¨æ•£åˆ—è¡¨å’Œæ•°æ®å¤„ç†ä¸­ï¼Œä¸æŠ‘åˆ¶å†²çªæ¥åŒºåˆ«æ•°æ®ï¼Œä¼šä½¿å¾—æ•°æ®åº“è®°å½•æ›´éš¾æ‰¾åˆ°ã€‚æˆ‘ä»¬å¸¸ç”¨çš„æ•£åˆ—å‡½æ•°æœ‰ MD5 æ¶ˆæ¯æ‘˜è¦ç®—æ³•ã€å®‰å…¨æ•£åˆ—ç®—æ³•ï¼ˆSecure Hash Algorithmï¼‰ã€‚ ä½†æ˜¯ä»…ä»…ä½¿ç”¨æ•£åˆ—å‡½æ•°è¿˜ä¸å¤Ÿï¼Œä¸ºäº†å¢åŠ å¯†ç çš„å®‰å…¨æ€§ï¼Œä¸€èˆ¬åœ¨å¯†ç åŠ å¯†è¿‡ç¨‹ä¸­è¿˜éœ€è¦åŠ ç›ï¼Œæ‰€è°“çš„ç›å¯ä»¥æ˜¯ä¸€ä¸ªéšæœºæ•°ä¹Ÿå¯ä»¥æ˜¯ç”¨æˆ·åï¼ŒåŠ ç›ä¹‹åï¼Œå³ä½¿å¯†ç æ˜æ–‡ç›¸åŒçš„ç”¨æˆ·ç”Ÿæˆçš„å¯†ç å¯†æ–‡ä¹Ÿä¸ç›¸åŒï¼Œè¿™å¯ä»¥æå¤§çš„æé«˜å¯†ç çš„å®‰å…¨æ€§ã€‚ä½†æ˜¯ä¼ ç»Ÿçš„åŠ ç›æ–¹å¼éœ€è¦åœ¨æ•°æ®åº“ä¸­æœ‰ä¸“é—¨çš„å­—æ®µæ¥è®°å½•ç›å€¼ï¼Œè¿™ä¸ªå­—æ®µå¯èƒ½æ˜¯ç”¨æˆ·åå­—æ®µï¼ˆå› ä¸ºç”¨æˆ·åå”¯ä¸€ï¼‰ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªä¸“é—¨è®°å½•ç›å€¼çš„å­—æ®µï¼Œè¿™æ ·çš„é…ç½®æ¯”è¾ƒç¹çã€‚ Spring Security æä¾›äº†å¤šç§å¯†ç åŠ å¯†æ–¹æ¡ˆï¼Œå®˜æ–¹æ¨èä½¿ç”¨ BCryptPasswordEncoderï¼ŒBCryptPasswordEncoder ä½¿ç”¨ BCrypt å¼ºå“ˆå¸Œå‡½æ•°ï¼Œå¼€å‘è€…åœ¨ä½¿ç”¨æ—¶å¯ä»¥é€‰æ‹©æä¾› strength å’Œ SecureRandom å®ä¾‹ã€‚strength è¶Šå¤§ï¼Œå¯†é’¥çš„è¿­ä»£æ¬¡æ•°è¶Šå¤šï¼Œå¯†é’¥è¿­ä»£æ¬¡æ•°ä¸º 2^strengthã€‚strength å–å€¼åœ¨ 4~31 ä¹‹é—´ï¼Œé»˜è®¤ä¸º 10ã€‚ ä¸åŒäº Shiro ä¸­éœ€è¦è‡ªå·±å¤„ç†å¯†ç åŠ ç›ï¼Œåœ¨ Spring Security ä¸­ï¼ŒBCryptPasswordEncoder å°±è‡ªå¸¦äº†ç›ï¼Œå¤„ç†èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚ è€Œ BCryptPasswordEncoder å°±æ˜¯ PasswordEncoder æ¥å£çš„å®ç°ç±»ã€‚ 2.2.3 PasswordEncoderPasswordEncoder è¿™ä¸ªæ¥å£ä¸­å°±å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š 1234567public interface PasswordEncoder { String encode(CharSequence rawPassword); boolean matches(CharSequence rawPassword, String encodedPassword); default boolean upgradeEncoding(String encodedPassword) { return false; }} encode æ–¹æ³•ç”¨æ¥å¯¹æ˜æ–‡å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œè¿”å›åŠ å¯†ä¹‹åçš„å¯†æ–‡ã€‚ matches æ–¹æ³•æ˜¯ä¸€ä¸ªå¯†ç æ ¡å¯¹æ–¹æ³•ï¼Œåœ¨ç”¨æˆ·ç™»å½•çš„æ—¶å€™ï¼Œå°†ç”¨æˆ·ä¼ æ¥çš„æ˜æ–‡å¯†ç å’Œæ•°æ®åº“ä¸­ä¿å­˜çš„å¯†æ–‡å¯†ç ä½œä¸ºå‚æ•°ï¼Œä¼ å…¥åˆ°è¿™ä¸ªæ–¹æ³•ä¸­å»ï¼Œæ ¹æ®è¿”å›çš„ Boolean å€¼åˆ¤æ–­ç”¨æˆ·å¯†ç æ˜¯å¦è¾“å…¥æ­£ç¡®ã€‚ upgradeEncoding æ˜¯å¦è¿˜è¦è¿›è¡Œå†æ¬¡åŠ å¯†ï¼Œè¿™ä¸ªä¸€èˆ¬æ¥è¯´å°±ä¸ç”¨äº†ã€‚ 2.2.4 é…ç½®é¢„å¤‡çŸ¥è¯†è®²å®Œåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹å…·ä½“å¦‚ä½•é…ç½®ï¼š @EnableWebSecurity:æ‰å¯ç”Ÿæ•ˆ @Configurable ä¸ç”Ÿæ•ˆ 12345678910111213@EnableWebSecuritypublic class SecurityConfig extends WebSecurityConfigurerAdapter { @Bean public PasswordEncoder passwordEncoder() { return NoOpPasswordEncoder.getInstance(); } @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { auth.inMemoryAuthentication().withUser(&quot;admin&quot;).password(passwordEncoder().encode(&quot;123&quot;)).roles(&quot;admin&quot;).authorities(&quot;index&quot;,&quot;detail&quot;); auth.inMemoryAuthentication().withUser(&quot;user&quot;).password(passwordEncoder().encode(&quot;123&quot;)).roles(&quot;user&quot;).authorities(&quot;index&quot;); }} é¦–å…ˆæˆ‘ä»¬è‡ªå®šä¹‰ SecurityConfig ç»§æ‰¿è‡ª WebSecurityConfigurerAdapterï¼Œé‡å†™é‡Œè¾¹çš„ configure æ–¹æ³•ã€‚ é¦–å…ˆæˆ‘ä»¬æä¾›äº†ä¸€ä¸ª PasswordEncoder çš„å®ä¾‹ï¼Œå› ä¸ºç›®å‰çš„æ¡ˆä¾‹è¿˜æ¯”è¾ƒç®€å•ï¼Œå› æ­¤æˆ‘æš‚æ—¶å…ˆä¸ç»™å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œæ‰€ä»¥è¿”å› NoOpPasswordEncoder çš„å®ä¾‹å³å¯ã€‚ configure æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ inMemoryAuthentication æ¥å¼€å¯åœ¨å†…å­˜ä¸­å®šä¹‰ç”¨æˆ·ï¼ŒwithUser ä¸­æ˜¯ç”¨æˆ·åï¼Œpassword ä¸­åˆ™æ˜¯ç”¨æˆ·å¯†ç ï¼Œroles ä¸­æ˜¯ç”¨æˆ·è§’è‰²ã€‚ å¦‚æœéœ€è¦é…ç½®å¤šä¸ªç”¨æˆ·ï¼Œç”¨ and ç›¸è¿ã€‚ ä¸ºä»€ä¹ˆç”¨ and ç›¸è¿å‘¢ï¼Ÿ åœ¨æ²¡æœ‰ Spring Boot çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½æ˜¯ SSM ä¸­ä½¿ç”¨ Spring Securityï¼Œè¿™ç§æ—¶å€™éƒ½æ˜¯åœ¨ XML æ–‡ä»¶ä¸­é…ç½® Spring Securityï¼Œæ—¢ç„¶æ˜¯ XML æ–‡ä»¶ï¼Œæ ‡ç­¾å°±æœ‰å¼€å§‹æœ‰ç»“æŸï¼Œç°åœ¨çš„ and ç¬¦å·ç›¸å½“äºå°±æ˜¯ XML æ ‡ç­¾çš„ç»“æŸç¬¦ï¼Œè¡¨ç¤ºç»“æŸå½“å‰æ ‡ç­¾ï¼Œè¿™æ˜¯ä¸ªæ—¶å€™ä¸Šä¸‹æ–‡ä¼šå›åˆ° inMemoryAuthentication æ–¹æ³•ä¸­ï¼Œç„¶åå¼€å¯æ–°ç”¨æˆ·çš„é…ç½®ã€‚ é…ç½®å®Œæˆåï¼Œå†æ¬¡å¯åŠ¨é¡¹ç›®ï¼ŒJava ä»£ç ä¸­çš„é…ç½®ä¼šè¦†ç›–æ‰ XML æ–‡ä»¶ä¸­çš„é…ç½®ï¼Œæ­¤æ—¶å†å»è®¿é—® /hello æ¥å£ï¼Œå°±ä¼šå‘ç°åªæœ‰ Java ä»£ç ä¸­çš„ç”¨æˆ·å/å¯†ç æ‰èƒ½è®¿é—®æˆåŠŸã€‚ 3.HttpSecurity é…ç½®12345678910111213141516171819@Overrideprotected void configure(HttpSecurity http) throws Exception { // è¯·æ±‚è§„åˆ™ http.authorizeRequests() .antMatchers(&quot;/admin/**&quot;).hasRole(&quot;admin&quot;) .antMatchers(&quot;/user/**&quot;).hasAnyRole(&quot;user&quot;,&quot;admin&quot;) // æ‰€æœ‰è¯·æ±‚éƒ½è¿›è¡Œè®¤è¯ .anyRequest().authenticated() .and() // å¼€å¯è¡¨å•ç™»é™† .formLogin() // ç”¨æˆ·ç™»å½• URL .loginProcessingUrl(&quot;/doLogin&quot;) // ç™»å½•è¯·æ±‚éƒ½æ”¾è¡Œ .permitAll() .and() //å…³é—­ CSRF æ”»å‡» .csrf().disable();} åˆ›å»ºä¸¤ä¸ªç”¨æˆ·è¯·æ±‚æ¥å£ 123456789@GetMapping(&quot;/admin/hello&quot;)String helloAdmin(){ return &quot;hello admin&quot;;}@GetMapping(&quot;/user/hello&quot;)String userAdmin(){ return &quot;hello user&quot;;} é€šè¿‡ postman è¿›è¡Œè®¿é—®çš„æ—¶å€™ï¼Œè®¿é—® /admin/userçš„æ—¶å€™ï¼Œä¼šè·³è½¬åˆ°loginé¡µé¢è®©ä½ å»ç™»å½•ï¼Œæ­¤æ—¶å‘é€ /doLoginã€ä¸Šé¢é…ç½®çš„ç™»å½•è¯·æ±‚URLã€‘æ‹¼æ¥?username=admin&amp;password=123å°±ä¼šé‡å®šå‘åˆ° /admin/userï¼Œæ­¤æ—¶å·²ç»æˆåŠŸç™»å½•ï¼Œsecurityå°±ä¼šæ”¾è¡Œè¯·æ±‚ã€‚ 4.è¡¨å•ç™»é™†è¯¦ç»†é…ç½®123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263@Overrideprotected void configure(HttpSecurity http) throws Exception { // è¯·æ±‚è§„åˆ™ http.authorizeRequests() .antMatchers(&quot;/admin/**&quot;).hasRole(&quot;admin&quot;) .antMatchers(&quot;/user/**&quot;).hasAnyRole(&quot;user&quot;,&quot;admin&quot;) // æ‰€æœ‰è¯·æ±‚éƒ½è¿›è¡Œè®¤è¯ .anyRequest().authenticated() .and() // å¼€å¯è¡¨å•ç™»é™† .formLogin() // ç”¨æˆ·ç™»å½•è¯·æ±‚ URL .loginProcessingUrl(&quot;/doLogin&quot;) // ç™»å½•é¡µé¢ URL .loginPage(&quot;/login&quot;) // è‡ªå®šä¹‰ç”¨æˆ·åå‚æ•° .usernameParameter(&quot;uname&quot;) // è‡ªå®šä¹‰å¯†ç å‚æ•° .passwordParameter(&quot;passwd&quot;) // ç™»é™†æˆåŠŸè·³è½¬çš„è¯·æ±‚ //.successForwardUrl(&quot;/success/toPage&quot;) // ç™»é™†æˆåŠŸå¤„ç†å™¨[å‰åç«¯åˆ†ç¦»] .successHandler((req,resp,auth)-&gt;{ resp.setContentType(&quot;application/json;charset=utf-8&quot;); PrintWriter writer = resp.getWriter(); HashMap&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;status&quot;,200); map.put(&quot;message&quot;,auth.getPrincipal()); writer.write(new ObjectMapper().writeValueAsString(map)); writer.flush(); writer.close(); }) // ç™»å½•å¤±è´¥é¡µé¢è·³è½¬é¡µé¢ //.failureForwardUrl(&quot;/fail/toPage&quot;) // ç™»é™†å¤±è´¥å¤„ç†å™¨[å‰åç«¯åˆ†ç¦»] .failureHandler((req,resp,e)-&gt;{ resp.setContentType(&quot;application/json;charset=utf-8&quot;); PrintWriter writer = resp.getWriter(); HashMap&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;status&quot;,401); if(e instanceof LockedException){ map.put(&quot;message&quot;,&quot;è´¦æˆ·è¢«é”å®š&quot;); }else if(e instanceof BadCredentialsException){ map.put(&quot;message&quot;,&quot;ç”¨æˆ·åæˆ–å¯†ç è¾“å…¥é”™è¯¯&quot;); }else if(e instanceof DisabledException){ map.put(&quot;message&quot;,&quot;è´¦æˆ·è¢«ç¦ç”¨&quot;); }else if(e instanceof AccountExpiredException){ map.put(&quot;message&quot;,&quot;è´¦æˆ·è¿‡æœŸ&quot;); }else if(e instanceof CredentialsExpiredException){ map.put(&quot;message&quot;,&quot;å¯†ç è¿‡æœŸ&quot;); }else { map.put(&quot;message&quot;,&quot;ç™»å½•å¤±è´¥&quot;); } writer.write(new ObjectMapper().writeValueAsString(map)); writer.flush(); writer.close(); }) // ç™»å½•è¯·æ±‚éƒ½æ”¾è¡Œ .permitAll() .and() //å…³é—­ CSRF æ”»å‡» .csrf().disable();} è‡ªå®šä¹‰ç™»å½•é¡µé¢çš„æ¥å£ 1234@GetMapping(&quot;/login&quot;)String userLogin(){ return &quot;è¯·ç™»å½•&quot;;} postman å‘é€è¯·æ±‚ http://localhost:8080/admin/hello é¡µé¢ä¼šè¿”å› è¯·ç™»å½•,è¿™æ˜¯å› ä¸ºè‡ªå®šä¹‰äº†å‰å¾€ç™»å½•é¡µçš„è¯·æ±‚/login å‘é€è¯·æ±‚ http://localhost:8080/doLogin?uname=admin&amp;passwd=123 é¡µé¢è¿”å› JSON æ•°æ® 12345678910111213141516{ &quot;message&quot;: { &quot;password&quot;: null, &quot;username&quot;: &quot;admin&quot;, &quot;authorities&quot;: [ { &quot;authority&quot;: &quot;ROLE_admin&quot; } ], &quot;accountNonExpired&quot;: true, &quot;accountNonLocked&quot;: true, &quot;credentialsNonExpired&quot;: true, &quot;enabled&quot;: true }, &quot;status&quot;: 200} å†æ¬¡è®¿é—®http://localhost:8080/admin/hello 1hello admin 4.1 ç™»é™†æˆåŠŸå›è°ƒåœ¨ Spring Security ä¸­ï¼Œå’Œç™»å½•æˆåŠŸé‡å®šå‘ URL ç›¸å…³çš„æ–¹æ³•æœ‰ä¸¤ä¸ªï¼š defaultSuccessUrl successForwardUrl è¿™ä¸¤ä¸ªå’‹çœ‹æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œå®é™…ä¸Šå†…è—ä¹¾å¤ã€‚ é¦–å…ˆæˆ‘ä»¬åœ¨é…ç½®çš„æ—¶å€™ï¼ŒdefaultSuccessUrl å’Œ successForwardUrl åªéœ€è¦é…ç½®ä¸€ä¸ªå³å¯ï¼Œå…·ä½“é…ç½®å“ªä¸ªï¼Œåˆ™è¦çœ‹ä½ çš„éœ€æ±‚ï¼Œä¸¤ä¸ªçš„åŒºåˆ«å¦‚ä¸‹ï¼š defaultSuccessUrl æœ‰ä¸€ä¸ªé‡è½½çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆè¯´ä¸€ä¸ªå‚æ•°çš„ defaultSuccessUrl æ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬åœ¨ defaultSuccessUrl ä¸­æŒ‡å®šç™»å½•æˆåŠŸçš„è·³è½¬é¡µé¢ä¸º /indexï¼Œæ­¤æ—¶åˆ†ä¸¤ç§æƒ…å†µï¼Œå¦‚æœä½ æ˜¯ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¾“å…¥çš„ç™»å½•åœ°å€ï¼Œç™»å½•æˆåŠŸåï¼Œå°±ç›´æ¥è·³è½¬åˆ° /indexï¼Œå¦‚æœä½ æ˜¯åœ¨æµè§ˆå™¨ä¸­è¾“å…¥äº†å…¶ä»–åœ°å€ï¼Œä¾‹å¦‚ http://localhost:8080/helloï¼Œç»“æœå› ä¸ºæ²¡æœ‰ç™»å½•ï¼Œåˆé‡å®šå‘åˆ°ç™»å½•é¡µé¢ï¼Œæ­¤æ—¶ç™»å½•æˆåŠŸåï¼Œå°±ä¸ä¼šæ¥åˆ° /index ï¼Œè€Œæ˜¯æ¥åˆ° /hello é¡µé¢ã€‚ defaultSuccessUrl è¿˜æœ‰ä¸€ä¸ªé‡è½½çš„æ–¹æ³•ï¼Œç¬¬äºŒä¸ªå‚æ•°å¦‚æœä¸è®¾ç½®é»˜è®¤ä¸º falseï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢çš„çš„æƒ…å†µï¼Œå¦‚æœæ‰‹åŠ¨è®¾ç½®ç¬¬äºŒä¸ªå‚æ•°ä¸º trueï¼Œåˆ™ defaultSuccessUrl çš„æ•ˆæœå’Œ successForwardUrl ä¸€è‡´ã€‚ successForwardUrl è¡¨ç¤ºä¸ç®¡ä½ æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Œç™»å½•åä¸€å¾‹è·³è½¬åˆ° successForwardUrl æŒ‡å®šçš„åœ°å€ã€‚ä¾‹å¦‚ successForwardUrl æŒ‡å®šçš„åœ°å€ä¸º /index ï¼Œä½ åœ¨æµè§ˆå™¨åœ°å€æ è¾“å…¥ http://localhost:8080/helloï¼Œç»“æœå› ä¸ºæ²¡æœ‰ç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢ï¼Œå½“ä½ ç™»å½•æˆåŠŸä¹‹åï¼Œå°±ä¼šæœåŠ¡ç«¯è·³è½¬åˆ° /index é¡µé¢ï¼›æˆ–è€…ä½ ç›´æ¥å°±åœ¨æµè§ˆå™¨è¾“å…¥äº†ç™»å½•é¡µé¢åœ°å€ï¼Œç™»å½•æˆåŠŸåä¹Ÿæ˜¯æ¥åˆ° /indexã€‚ 12345678910.and().formLogin().loginPage(&quot;/login.html&quot;).loginProcessingUrl(&quot;/doLogin&quot;).usernameParameter(&quot;name&quot;).passwordParameter(&quot;passwd&quot;).defaultSuccessUrl(&quot;/index&quot;).successForwardUrl(&quot;/index&quot;).permitAll().and() ã€Œæ³¨æ„ï¼šå®é™…æ“ä½œä¸­ï¼ŒdefaultSuccessUrl å’Œ successForwardUrl åªéœ€è¦é…ç½®ä¸€ä¸ªå³å¯ã€‚ã€ 4.2 ç™»å½•å¤±è´¥å›è°ƒä¸ç™»å½•æˆåŠŸç›¸ä¼¼ï¼Œç™»å½•å¤±è´¥ä¹Ÿæ˜¯æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š failureForwardUrl failureUrl ã€Œè¿™ä¸¤ä¸ªæ–¹æ³•åœ¨è®¾ç½®çš„æ—¶å€™ä¹Ÿæ˜¯è®¾ç½®ä¸€ä¸ªå³å¯ã€ã€‚failureForwardUrl æ˜¯ç™»å½•å¤±è´¥ä¹‹åä¼šå‘ç”ŸæœåŠ¡ç«¯è·³è½¬ï¼ŒfailureUrl åˆ™åœ¨ç™»å½•å¤±è´¥ä¹‹åï¼Œä¼šå‘ç”Ÿé‡å®šå‘ã€‚ 4.3 æ³¨é”€ç™»å½•æ³¨é”€ç™»å½•çš„é»˜è®¤æ¥å£æ˜¯ /logoutï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é…ç½®ã€‚ 12345678910.and().logout().logoutUrl(&quot;/logout&quot;).logoutRequestMatcher(new AntPathRequestMatcher(&quot;/logout&quot;,&quot;POST&quot;)).logoutSuccessUrl(&quot;/index&quot;).deleteCookies().clearAuthentication(true).invalidateHttpSession(true).permitAll().and() æ³¨é”€ç™»å½•çš„é…ç½®æˆ‘æ¥è¯´ä¸€ä¸‹ï¼š é»˜è®¤æ³¨é”€çš„ URL æ˜¯ /logoutï¼Œæ˜¯ä¸€ä¸ª GET è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ logoutUrl æ–¹æ³•æ¥ä¿®æ”¹é»˜è®¤çš„æ³¨é”€ URLã€‚ logoutRequestMatcher æ–¹æ³•ä¸ä»…å¯ä»¥ä¿®æ”¹æ³¨é”€ URLï¼Œè¿˜å¯ä»¥ä¿®æ”¹è¯·æ±‚æ–¹å¼ï¼Œå®é™…é¡¹ç›®ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•å’Œ logoutUrl ä»»æ„è®¾ç½®ä¸€ä¸ªå³å¯ã€‚ logoutSuccessUrl è¡¨ç¤ºæ³¨é”€æˆåŠŸåè¦è·³è½¬çš„é¡µé¢ã€‚ deleteCookies ç”¨æ¥æ¸…é™¤ cookieã€‚ clearAuthentication å’Œ invalidateHttpSession åˆ†åˆ«è¡¨ç¤ºæ¸…é™¤è®¤è¯ä¿¡æ¯å’Œä½¿ HttpSession å¤±æ•ˆï¼Œé»˜è®¤å¯ä»¥ä¸ç”¨é…ç½®ï¼Œé»˜è®¤å°±ä¼šæ¸…é™¤ã€‚ 4.4 å‰åç«¯åˆ†ç¦»ç™»å½•æ— çŠ¶æ€ç™»å½•ä»€ä¹ˆæ˜¯æœ‰çŠ¶æ€æœ‰çŠ¶æ€æœåŠ¡ï¼Œå³æœåŠ¡ç«¯éœ€è¦è®°å½•æ¯æ¬¡ä¼šè¯çš„å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œä»è€Œè¯†åˆ«å®¢æˆ·ç«¯èº«ä»½ï¼Œæ ¹æ®ç”¨æˆ·èº«ä»½è¿›è¡Œè¯·æ±‚çš„å¤„ç†ï¼Œå…¸å‹çš„è®¾è®¡å¦‚ Tomcat ä¸­çš„ Sessionã€‚ä¾‹å¦‚ç™»å½•ï¼šç”¨æˆ·ç™»å½•åï¼Œæˆ‘ä»¬æŠŠç”¨æˆ·çš„ä¿¡æ¯ä¿å­˜åœ¨æœåŠ¡ç«¯ session ä¸­ï¼Œå¹¶ä¸”ç»™ç”¨æˆ·ä¸€ä¸ª cookie å€¼ï¼Œè®°å½•å¯¹åº”çš„ sessionï¼Œç„¶åä¸‹æ¬¡è¯·æ±‚ï¼Œç”¨æˆ·æºå¸¦ cookie å€¼æ¥ï¼ˆè¿™ä¸€æ­¥æœ‰æµè§ˆå™¨è‡ªåŠ¨å®Œæˆï¼‰ï¼Œæˆ‘ä»¬å°±èƒ½è¯†åˆ«åˆ°å¯¹åº” sessionï¼Œä»è€Œæ‰¾åˆ°ç”¨æˆ·çš„ä¿¡æ¯ã€‚è¿™ç§æ–¹å¼ç›®å‰æ¥çœ‹æœ€æ–¹ä¾¿ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›ç¼ºé™·ï¼Œå¦‚ä¸‹ï¼š æœåŠ¡ç«¯ä¿å­˜å¤§é‡æ•°æ®ï¼Œå¢åŠ æœåŠ¡ç«¯å‹åŠ› æœåŠ¡ç«¯ä¿å­˜ç”¨æˆ·çŠ¶æ€ï¼Œä¸æ”¯æŒé›†ç¾¤åŒ–éƒ¨ç½² ä»€ä¹ˆæ˜¯æ— çŠ¶æ€å¾®æœåŠ¡é›†ç¾¤ä¸­çš„æ¯ä¸ªæœåŠ¡ï¼Œå¯¹å¤–æä¾›çš„éƒ½ä½¿ç”¨ RESTful é£æ ¼çš„æ¥å£ã€‚è€Œ RESTful é£æ ¼çš„ä¸€ä¸ªæœ€é‡è¦çš„è§„èŒƒå°±æ˜¯ï¼šæœåŠ¡çš„æ— çŠ¶æ€æ€§ï¼Œå³ï¼š æœåŠ¡ç«¯ä¸ä¿å­˜ä»»ä½•å®¢æˆ·ç«¯è¯·æ±‚è€…ä¿¡æ¯ å®¢æˆ·ç«¯çš„æ¯æ¬¡è¯·æ±‚å¿…é¡»å…·å¤‡è‡ªæè¿°ä¿¡æ¯ï¼Œé€šè¿‡è¿™äº›ä¿¡æ¯è¯†åˆ«å®¢æˆ·ç«¯èº«ä»½ é‚£ä¹ˆè¿™ç§æ— çŠ¶æ€æ€§æœ‰å“ªäº›å¥½å¤„å‘¢ï¼Ÿ å®¢æˆ·ç«¯è¯·æ±‚ä¸ä¾èµ–æœåŠ¡ç«¯çš„ä¿¡æ¯ï¼Œå¤šæ¬¡è¯·æ±‚ä¸éœ€è¦å¿…é¡»è®¿é—®åˆ°åŒä¸€å°æœåŠ¡å™¨ æœåŠ¡ç«¯çš„é›†ç¾¤å’ŒçŠ¶æ€å¯¹å®¢æˆ·ç«¯é€æ˜ æœåŠ¡ç«¯å¯ä»¥ä»»æ„çš„è¿ç§»å’Œä¼¸ç¼©ï¼ˆå¯ä»¥æ–¹ä¾¿çš„è¿›è¡Œé›†ç¾¤åŒ–éƒ¨ç½²ï¼‰ å‡å°æœåŠ¡ç«¯å­˜å‚¨å‹åŠ› å¦‚ä½•å®ç°æ— çŠ¶æ€æ— çŠ¶æ€ç™»å½•çš„æµç¨‹ï¼š é¦–å…ˆå®¢æˆ·ç«¯å‘é€è´¦æˆ·å/å¯†ç åˆ°æœåŠ¡ç«¯è¿›è¡Œè®¤è¯ è®¤è¯é€šè¿‡åï¼ŒæœåŠ¡ç«¯å°†ç”¨æˆ·ä¿¡æ¯åŠ å¯†å¹¶ä¸”ç¼–ç æˆä¸€ä¸ª tokenï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ ä»¥åå®¢æˆ·ç«¯æ¯æ¬¡å‘é€è¯·æ±‚ï¼Œéƒ½éœ€è¦æºå¸¦è®¤è¯çš„ token æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯å‘é€æ¥çš„ token è¿›è¡Œè§£å¯†ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ•ˆï¼Œå¹¶ä¸”è·å–ç”¨æˆ·ç™»å½•ä¿¡æ¯ å„è‡ªä¼˜ç¼ºç‚¹ä½¿ç”¨ session æœ€å¤§çš„ä¼˜ç‚¹åœ¨äºæ–¹ä¾¿ã€‚ä½ ä¸ç”¨åšè¿‡å¤šçš„å¤„ç†ï¼Œä¸€åˆ‡éƒ½æ˜¯é»˜è®¤çš„å³å¯ã€‚ ä½†æ˜¯ä½¿ç”¨ session æœ‰å¦å¤–ä¸€ä¸ªè‡´å‘½çš„é—®é¢˜å°±æ˜¯å¦‚æœä½ çš„å‰ç«¯æ˜¯ Androidã€iOSã€å°ç¨‹åºç­‰ï¼Œè¿™äº› App å¤©ç„¶çš„å°±æ²¡æœ‰ cookieï¼Œå¦‚æœéè¦ç”¨ sessionï¼Œå°±éœ€è¦è¿™äº›å·¥ç¨‹å¸ˆåœ¨å„è‡ªçš„è®¾å¤‡ä¸Šåšé€‚é…ï¼Œä¸€èˆ¬æ˜¯æ¨¡æ‹Ÿ cookieï¼Œä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œåœ¨ç§»åŠ¨ App éåœ°å¼€èŠ±çš„ä»Šå¤©ï¼Œæˆ‘ä»¬å•çº¯çš„ä¾èµ– session æ¥åšå®‰å…¨ç®¡ç†ï¼Œä¼¼ä¹ä¹Ÿä¸æ˜¯ç‰¹åˆ«ç†æƒ³ã€‚ è¿™ä¸ªæ—¶å€™ JWT è¿™æ ·çš„æ— çŠ¶æ€ç™»å½•å°±å±•ç¤ºå‡ºè‡ªå·±çš„ä¼˜åŠ¿äº†ï¼Œè¿™äº›ç™»å½•æ–¹å¼æ‰€ä¾èµ–çš„ token ä½ å¯ä»¥é€šè¿‡æ™®é€šå‚æ•°ä¼ é€’ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¯·æ±‚å¤´ä¼ é€’ï¼Œæ€ä¹ˆæ ·éƒ½è¡Œï¼Œå…·æœ‰å¾ˆå¼ºçš„çµæ´»æ€§ã€‚ ä¸è¿‡è¯è¯´å›æ¥ï¼Œå¦‚æœä½ çš„å‰åç«¯åˆ†ç¦»åªæ˜¯ç½‘é¡µ+æœåŠ¡ç«¯ï¼Œå…¶å®æ²¡å¿…è¦ä¸Šæ— çŠ¶æ€ç™»å½•ï¼ŒåŸºäº session æ¥åšå°±å¯ä»¥äº†ï¼Œçœäº‹åˆæ–¹ä¾¿ã€‚ ç™»å½•äº¤äº’å‰åç«¯åˆ†ç¦»çš„æ•°æ®äº¤äº’åœ¨å‰åç«¯åˆ†ç¦»è¿™æ ·çš„å¼€å‘æ¶æ„ä¸‹ï¼Œå‰åç«¯çš„äº¤äº’éƒ½æ˜¯é€šè¿‡ JSON æ¥è¿›è¡Œï¼Œæ— è®ºç™»å½•æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½ä¸ä¼šæœ‰ä»€ä¹ˆæœåŠ¡ç«¯è·³è½¬æˆ–è€…å®¢æˆ·ç«¯è·³è½¬ä¹‹ç±»ã€‚ ç™»å½•æˆåŠŸäº†ï¼ŒæœåŠ¡ç«¯å°±è¿”å›ä¸€æ®µç™»å½•æˆåŠŸçš„æç¤º JSON ç»™å‰ç«¯ï¼Œå‰ç«¯æ”¶åˆ°ä¹‹åï¼Œè¯¥è·³è½¬è¯¥å±•ç¤ºï¼Œç”±å‰ç«¯è‡ªå·±å†³å®šï¼Œå°±å’Œåç«¯æ²¡æœ‰å…³ç³»äº†ã€‚ ç™»å½•å¤±è´¥äº†ï¼ŒæœåŠ¡ç«¯å°±è¿”å›ä¸€æ®µç™»å½•å¤±è´¥çš„æç¤º JSON ç»™å‰ç«¯ï¼Œå‰ç«¯æ”¶åˆ°ä¹‹åï¼Œè¯¥è·³è½¬è¯¥å±•ç¤ºï¼Œç”±å‰ç«¯è‡ªå·±å†³å®šï¼Œä¹Ÿå’Œåç«¯æ²¡æœ‰å…³ç³»äº†ã€‚ é¦–å…ˆæŠŠè¿™æ ·çš„æ€è·¯ç¡®å®šäº†ï¼ŒåŸºäºè¿™æ ·çš„æ€è·¯ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç™»å½•é…ç½®ã€‚ ç™»å½•æˆåŠŸä¹‹å‰æˆ‘ä»¬é…ç½®ç™»å½•æˆåŠŸçš„å¤„ç†æ˜¯é€šè¿‡å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•æ¥é…ç½®çš„ï¼š defaultSuccessUrl successForwardUrl è¿™ä¸¤ä¸ªéƒ½æ˜¯é…ç½®è·³è½¬åœ°å€çš„ï¼Œé€‚ç”¨äºå‰åç«¯ä¸åˆ†çš„å¼€å‘ã€‚é™¤äº†è¿™ä¸¤ä¸ªæ–¹æ³•ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå¿…æ€æŠ€ï¼Œé‚£å°±æ˜¯ successHandlerã€‚ successHandler çš„åŠŸèƒ½ååˆ†å¼ºå¤§ï¼Œç”šè‡³å·²ç»å›Šæ‹¬äº† defaultSuccessUrl å’Œ successForwardUrl çš„åŠŸèƒ½ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼š 12345678.successHandler((req, resp, authentication) -&gt; { Object principal = authentication.getPrincipal(); resp.setContentType(&quot;application/json;charset=utf-8&quot;); PrintWriter out = resp.getWriter(); out.write(new ObjectMapper().writeValueAsString(principal)); out.flush(); out.close();}) successHandler æ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ª AuthenticationSuccessHandler å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¸­æˆ‘ä»¬è¦å®ç°çš„æ–¹æ³•æ˜¯ onAuthenticationSuccessã€‚ onAuthenticationSuccess æ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼š HttpServletRequest HttpServletResponse Authentication æœ‰äº†å‰ä¸¤ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨è¿™é‡Œéšå¿ƒæ‰€æ¬²çš„è¿”å›æ•°æ®äº†ã€‚åˆ©ç”¨ HttpServletRequest æˆ‘ä»¬å¯ä»¥åšæœåŠ¡ç«¯è·³è½¬ï¼Œåˆ©ç”¨ HttpServletResponse æˆ‘ä»¬å¯ä»¥åšå®¢æˆ·ç«¯è·³è½¬ï¼Œå½“ç„¶ï¼Œä¹Ÿå¯ä»¥è¿”å› JSON æ•°æ®ã€‚ ç¬¬ä¸‰ä¸ª Authentication å‚æ•°åˆ™ä¿å­˜äº†æˆ‘ä»¬åˆšåˆšç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ã€‚ é…ç½®å®Œæˆåï¼Œæˆ‘ä»¬å†å»ç™»å½•ï¼Œå°±å¯ä»¥çœ‹åˆ°ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯é€šè¿‡ JSON è¿”å›åˆ°å‰ç«¯äº†ï¼Œå¦‚ä¸‹ï¼š 12345678910111213{ &quot;password&quot;: null, &quot;username&quot;: &quot;admin&quot;, &quot;authorities&quot;: [ { &quot;authority&quot;: &quot;ROLE_admin&quot; } ], &quot;accountNonExpired&quot;: true, &quot;accountNonLocked&quot;: true, &quot;credentialsNonExpired&quot;: true, &quot;enabled&quot;: true} ç™»å½•å¤±è´¥ç™»å½•å¤±è´¥ä¹Ÿæœ‰ä¸€ä¸ªç±»ä¼¼çš„å›è°ƒï¼Œå¦‚ä¸‹ï¼š 1234567.failureHandler((req, resp, e) -&gt; { resp.setContentType(&quot;application/json;charset=utf-8&quot;); PrintWriter out = resp.getWriter(); out.write(e.getMessage()); out.flush(); out.close();}) å¤±è´¥çš„å›è°ƒä¹Ÿæ˜¯ä¸‰ä¸ªå‚æ•°ï¼Œå‰ä¸¤ä¸ªå°±ä¸ç”¨è¯´äº†ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ä¸€ä¸ª Exceptionï¼Œå¯¹äºç™»å½•å¤±è´¥ï¼Œä¼šæœ‰ä¸åŒçš„åŸå› ï¼ŒException ä¸­åˆ™ä¿å­˜äº†ç™»å½•å¤±è´¥çš„åŸå› ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¹‹é€šè¿‡ JSON è¿”å›åˆ°å‰ç«¯ã€‚ å½“ç„¶å¤§å®¶ä¹Ÿçœ‹åˆ°ï¼Œåœ¨å¾®äººäº‹ä¸­ï¼Œæˆ‘è¿˜æŒ¨ä¸ªå»è¯†åˆ«äº†ä¸€ä¸‹å¼‚å¸¸çš„ç±»å‹ï¼Œæ ¹æ®ä¸åŒçš„å¼‚å¸¸ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ç»™ç”¨æˆ·ä¸€ä¸ªæ›´åŠ æ˜ç¡®çš„æç¤ºï¼š 1234567891011121314151617resp.setContentType(&quot;application/json;charset=utf-8&quot;);PrintWriter out = resp.getWriter();RespBean respBean = RespBean.error(e.getMessage());if (e instanceof LockedException) { respBean.setMsg(&quot;è´¦æˆ·è¢«é”å®šï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;);} elseif (e instanceof CredentialsExpiredException) { respBean.setMsg(&quot;å¯†ç è¿‡æœŸï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;);} elseif (e instanceof AccountExpiredException) { respBean.setMsg(&quot;è´¦æˆ·è¿‡æœŸï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;);} elseif (e instanceof DisabledException) { respBean.setMsg(&quot;è´¦æˆ·è¢«ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;);} elseif (e instanceof BadCredentialsException) { respBean.setMsg(&quot;ç”¨æˆ·åæˆ–è€…å¯†ç è¾“å…¥é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥!&quot;);}out.write(new ObjectMapper().writeValueAsString(respBean));out.flush();out.close(); è¿™é‡Œæœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ã€‚ æˆ‘ä»¬çŸ¥é“ï¼Œå½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œç”¨æˆ·åæˆ–è€…å¯†ç è¾“å…¥é”™è¯¯ï¼Œæˆ‘ä»¬ä¸€èˆ¬åªç»™ä¸€ä¸ªæ¨¡ç³Šçš„æç¤ºï¼Œå³ã€Œç”¨æˆ·åæˆ–è€…å¯†ç è¾“å…¥é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ã€ï¼Œè€Œä¸ä¼šç»™ä¸€ä¸ªæ˜ç¡®çš„è¯¸å¦‚â€œç”¨æˆ·åè¾“å…¥é”™è¯¯â€æˆ–â€œå¯†ç è¾“å…¥é”™è¯¯â€è¿™æ ·ç²¾ç¡®çš„æç¤ºï¼Œä½†æ˜¯å¯¹äºå¾ˆå¤šä¸æ‡‚è¡Œçš„æ–°æ‰‹å°ä¼™ä¼´ï¼Œä»–å¯èƒ½å°±ä¼šç»™ä¸€ä¸ªæ˜ç¡®çš„é”™è¯¯æç¤ºï¼Œè¿™ä¼šç»™ç³»ç»Ÿå¸¦æ¥é£é™©ã€‚ ä½†æ˜¯ä½¿ç”¨äº† Spring Security è¿™æ ·çš„å®‰å…¨ç®¡ç†æ¡†æ¶ä¹‹åï¼Œå³ä½¿ä½ æ˜¯ä¸€ä¸ªæ–°æ‰‹ï¼Œä¹Ÿä¸ä¼šçŠ¯è¿™æ ·çš„é”™è¯¯ã€‚ åœ¨ Spring Security ä¸­ï¼Œç”¨æˆ·åæŸ¥æ‰¾å¤±è´¥å¯¹åº”çš„å¼‚å¸¸æ˜¯ï¼š UsernameNotFoundException å¯†ç åŒ¹é…å¤±è´¥å¯¹åº”çš„å¼‚å¸¸æ˜¯ï¼š BadCredentialsException ä½†æ˜¯æˆ‘ä»¬åœ¨ç™»å½•å¤±è´¥çš„å›è°ƒä¸­ï¼Œå´æ€»æ˜¯çœ‹ä¸åˆ° UsernameNotFoundException å¼‚å¸¸ï¼Œæ— è®ºç”¨æˆ·åè¿˜æ˜¯å¯†ç è¾“å…¥é”™è¯¯ï¼ŒæŠ›å‡ºçš„å¼‚å¸¸éƒ½æ˜¯ BadCredentialsExceptionã€‚ åœ¨ç™»å½•ä¸­æœ‰ä¸€ä¸ªå…³é”®çš„æ­¥éª¤ï¼Œå°±æ˜¯å»åŠ è½½ç”¨æˆ·æ•°æ®ï¼Œæˆ‘ä»¬å†æ¥æŠŠè¿™ä¸ªæ–¹æ³•æ‹å‡ºæ¥çœ‹ä¸€ä¸‹ï¼ˆéƒ¨åˆ†ï¼‰ï¼š 123456789101112131415161718public Authentication authenticate(Authentication authentication) throws AuthenticationException { try { user = retrieveUser(username, (UsernamePasswordAuthenticationToken) authentication); } catch (UsernameNotFoundException notFound) { logger.debug(&quot;User '&quot; + username + &quot;' not found&quot;); if (hideUserNotFoundExceptions) { thrownew BadCredentialsException(messages.getMessage( &quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;, &quot;Bad credentials&quot;)); } else { throw notFound; } }} ä»è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬çœ‹å‡ºï¼Œåœ¨æŸ¥æ‰¾ç”¨æˆ·æ—¶ï¼Œå¦‚æœæŠ›å‡ºäº† UsernameNotFoundExceptionï¼Œè¿™ä¸ªå¼‚å¸¸ä¼šè¢«æ•è·ï¼Œæ•è·ä¹‹åï¼Œå¦‚æœ hideUserNotFoundExceptions å±æ€§çš„å€¼ä¸º trueï¼Œå°±æŠ›å‡ºä¸€ä¸ª BadCredentialsExceptionã€‚ç›¸å½“äºå°† UsernameNotFoundException å¼‚å¸¸éšè—äº†ï¼Œè€Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒhideUserNotFoundExceptions çš„å€¼å°±ä¸º trueã€‚ çœ‹åˆ°è¿™é‡Œå¤§å®¶å°±æ˜ç™½äº†ä¸ºä»€ä¹ˆæ— è®ºç”¨æˆ·è¿˜æ˜¯å¯†ç å†™é”™ï¼Œä½ æ”¶åˆ°çš„éƒ½æ˜¯ BadCredentialsException å¼‚å¸¸ã€‚ ä¸€èˆ¬æ¥è¯´è¿™ä¸ªé…ç½®æ˜¯ä¸éœ€è¦ä¿®æ”¹çš„ï¼Œå¦‚æœä½ ä¸€å®šè¦åŒºåˆ«å‡ºæ¥ UsernameNotFoundException å’Œ BadCredentialsExceptionï¼Œæˆ‘è¿™é‡Œç»™å¤§å®¶æä¾›ä¸‰ç§æ€è·¯ï¼š è‡ªå·±å®šä¹‰ DaoAuthenticationProvider ä»£æ›¿ç³»ç»Ÿé»˜è®¤çš„ï¼Œåœ¨å®šä¹‰æ—¶å°† hideUserNotFoundExceptions å±æ€§è®¾ç½®ä¸º falseã€‚ å½“ç”¨æˆ·åæŸ¥æ‰¾å¤±è´¥æ—¶ï¼Œä¸æŠ›å‡º UsernameNotFoundException å¼‚å¸¸ï¼Œè€Œæ˜¯æŠ›å‡ºä¸€ä¸ªè‡ªå®šä¹‰å¼‚å¸¸ï¼Œè¿™æ ·è‡ªå®šä¹‰å¼‚å¸¸å°±ä¸ä¼šè¢«éšè—ï¼Œè¿›è€Œåœ¨ç™»å½•å¤±è´¥çš„å›è°ƒä¸­æ ¹æ®è‡ªå®šä¹‰å¼‚å¸¸ä¿¡æ¯ç»™å‰ç«¯ç”¨æˆ·ä¸€ä¸ªæç¤ºã€‚ å½“ç”¨æˆ·åæŸ¥æ‰¾å¤±è´¥æ—¶ï¼Œç›´æ¥æŠ›å‡º BadCredentialsExceptionï¼Œä½†æ˜¯å¼‚å¸¸ä¿¡æ¯ä¸º â€œç”¨æˆ·åä¸å­˜åœ¨â€ã€‚ é™¤éæƒ…å†µç‰¹æ®Šï¼Œä¸€èˆ¬ä¸ç”¨ä¿®æ”¹è¿™ä¸€å—çš„é»˜è®¤è¡Œä¸ºã€‚ å®˜æ–¹è¿™æ ·åšçš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¾ˆæ˜æ˜¾å¯ä»¥å¼ºè¿«å¼€å‘è€…ç»™ä¸€ä¸ªæ¨¡ç³Šçš„å¼‚å¸¸æç¤ºï¼Œè¿™æ ·å³ä½¿æ˜¯ä¸æ‡‚è¡Œçš„æ–°æ‰‹ï¼Œä¹Ÿä¸ä¼šå°†ç³»ç»Ÿç½®äºå±é™©ä¹‹ä¸­ã€‚ å¥½äº†ï¼Œè¿™æ ·é…ç½®å®Œæˆåï¼Œæ— è®ºæ˜¯ç™»å½•æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œåç«¯éƒ½å°†åªè¿”å› JSON ç»™å‰ç«¯äº†ã€‚ æœªè®¤è¯å¤„ç†æ–¹æ¡ˆé‚£æœªè®¤è¯åˆæ€ä¹ˆåŠå‘¢ï¼Ÿ æœ‰äººè¯´ï¼Œé‚£è¿˜ä¸ç®€å•ï¼Œæ²¡æœ‰è®¤è¯å°±è®¿é—®æ•°æ®ï¼Œç›´æ¥é‡å®šå‘åˆ°ç™»å½•é¡µé¢å°±è¡Œäº†ï¼Œè¿™æ²¡é”™ï¼Œç³»ç»Ÿé»˜è®¤çš„è¡Œä¸ºä¹Ÿæ˜¯è¿™æ ·ã€‚ ä½†æ˜¯åœ¨å‰åç«¯åˆ†ç¦»ä¸­ï¼Œè¿™ä¸ªé€»è¾‘æ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ç™»å½•å°±è®¿é—®ä¸€ä¸ªéœ€è¦è®¤è¯åæ‰èƒ½è®¿é—®çš„é¡µé¢ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬ä¸åº”è¯¥è®©ç”¨æˆ·é‡å®šå‘åˆ°ç™»å½•é¡µé¢ï¼Œè€Œæ˜¯ç»™ç”¨æˆ·ä¸€ä¸ªå°šæœªç™»å½•çš„æç¤ºï¼Œå‰ç«¯æ”¶åˆ°æç¤ºä¹‹åï¼Œå†è‡ªè¡Œå†³å®šé¡µé¢è·³è½¬ã€‚ è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±æ¶‰åŠåˆ° Spring Security ä¸­çš„ä¸€ä¸ªæ¥å£ AuthenticationEntryPoint ï¼Œè¯¥æ¥å£æœ‰ä¸€ä¸ªå®ç°ç±»ï¼šLoginUrlAuthenticationEntryPoint ï¼Œè¯¥ç±»ä¸­æœ‰ä¸€ä¸ªæ–¹æ³• commenceï¼Œå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526/** * Performs the redirect (or forward) to the login form URL. */public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) { String redirectUrl = null; if (useForward) { if (forceHttps &amp;&amp; &quot;http&quot;.equals(request.getScheme())) { redirectUrl = buildHttpsRedirectUrlForRequest(request); } if (redirectUrl == null) { String loginForm = determineUrlToUseForThisRequest(request, response, authException); if (logger.isDebugEnabled()) { logger.debug(&quot;Server side forward to: &quot; + loginForm); } RequestDispatcher dispatcher = request.getRequestDispatcher(loginForm); dispatcher.forward(request, response); return; } } else { redirectUrl = buildRedirectUrlToLoginPage(request, response, authException); } redirectStrategy.sendRedirect(request, response, redirectUrl);} é¦–å…ˆæˆ‘ä»¬ä»è¿™ä¸ªæ–¹æ³•çš„æ³¨é‡Šä¸­å°±å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥å†³å®šåˆ°åº•æ˜¯è¦é‡å®šå‘è¿˜æ˜¯è¦ forwardï¼Œé€šè¿‡ Debug è¿½è¸ªï¼Œæˆ‘ä»¬å‘ç°é»˜è®¤æƒ…å†µä¸‹ useForward çš„å€¼ä¸º falseï¼Œæ‰€ä»¥è¯·æ±‚èµ°è¿›äº†é‡å®šå‘ã€‚ é‚£ä¹ˆæˆ‘ä»¬è§£å†³é—®é¢˜çš„æ€è·¯å¾ˆç®€å•ï¼Œç›´æ¥é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­è¿”å› JSON å³å¯ï¼Œä¸å†åšé‡å®šå‘æ“ä½œï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š 123456789.csrf().disable().exceptionHandling().authenticationEntryPoint((req, resp, authException) -&gt; { resp.setContentType(&quot;application/json;charset=utf-8&quot;); PrintWriter out = resp.getWriter(); out.write(&quot;å°šæœªç™»å½•ï¼Œè¯·å…ˆç™»å½•&quot;); out.flush(); out.close(); }); åœ¨ Spring Security çš„é…ç½®ä¸­åŠ ä¸Šè‡ªå®šä¹‰çš„ AuthenticationEntryPoint å¤„ç†æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­ç›´æ¥è¿”å›ç›¸åº”çš„ JSON æç¤ºå³å¯ã€‚è¿™æ ·ï¼Œå¦‚æœç”¨æˆ·å†å»ç›´æ¥è®¿é—®ä¸€ä¸ªéœ€è¦è®¤è¯ä¹‹åæ‰å¯ä»¥è®¿é—®çš„è¯·æ±‚ï¼Œå°±ä¸ä¼šå‘ç”Ÿé‡å®šå‘æ“ä½œäº†ï¼ŒæœåŠ¡ç«¯ä¼šç›´æ¥ç»™æµè§ˆå™¨ä¸€ä¸ª JSON æç¤ºï¼Œæµè§ˆå™¨æ”¶åˆ° JSON ä¹‹åï¼Œè¯¥å¹²å˜›å¹²å˜›ã€‚ æ³¨é”€ç™»å½•æœ€åæˆ‘ä»¬å†æ¥çœ‹çœ‹æ³¨é”€ç™»å½•çš„å¤„ç†æ–¹æ¡ˆã€‚ æ³¨é”€ç™»å½•æˆ‘ä»¬å‰é¢è¯´è¿‡ï¼ŒæŒ‰ç…§å‰é¢çš„é…ç½®ï¼Œæ³¨é”€ç™»å½•ä¹‹åï¼Œç³»ç»Ÿè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œè¿™ä¹Ÿæ˜¯ä¸åˆé€‚çš„ï¼Œå¦‚æœæ˜¯å‰åç«¯åˆ†ç¦»é¡¹ç›®ï¼Œæ³¨é”€ç™»å½•æˆåŠŸåè¿”å› JSON å³å¯ï¼Œé…ç½®å¦‚ä¸‹ï¼š 123456789101112.and().logout().logoutUrl(&quot;/logout&quot;).logoutSuccessHandler((req, resp, authentication) -&gt; { resp.setContentType(&quot;application/json;charset=utf-8&quot;); PrintWriter out = resp.getWriter(); out.write(&quot;æ³¨é”€æˆåŠŸ&quot;); out.flush(); out.close();}).permitAll().and() è¿™æ ·ï¼Œæ³¨é”€æˆåŠŸä¹‹åï¼Œå‰ç«¯æ”¶åˆ°çš„ä¹Ÿæ˜¯ JSON äº†ï¼š 5.å¤šä¸ª HttpSecurity12345678910111213141516171819202122232425262728293031323334353637383940414243444546@EnableWebSecuritypublic class MultiHttpSecurityConfig { @Bean public PasswordEncoder passwordEncoder() { return NoOpPasswordEncoder.getInstance(); } @Autowired protected void configure(AuthenticationManagerBuilder auth) throws Exception { auth.inMemoryAuthentication().withUser(&quot;admin&quot;).password(passwordEncoder().encode(&quot;123&quot;)).roles(&quot;admin&quot;); auth.inMemoryAuthentication().withUser(&quot;user&quot;).password(passwordEncoder().encode(&quot;123&quot;)).roles(&quot;user&quot;); } @EnableWebSecurity @Order(1) public static class AdminSecurityConfig extends WebSecurityConfigurerAdapter { @Override protected void configure(HttpSecurity http) throws Exception { http.antMatcher(&quot;/admin/**&quot;) .authorizeRequests() .anyRequest().hasAnyRole(&quot;admin&quot;); } } @EnableWebSecurity @Order(2) public static class OtherSecurityConfig extends WebSecurityConfigurerAdapter { @Override protected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .anyRequest() .authenticated() .and() .formLogin() .loginProcessingUrl(&quot;/doLogin&quot;) .permitAll() .and() .csrf().disable(); } }} ç”¨æˆ·å‘é€è¯·æ±‚ï¼Œä¼šå…ˆå» AdminSecurityConfigåŒ¹é…ï¼Œåœ¨è¿™ä¸ªç±»åªæ˜¯æ‹¦æˆª /admin/**çš„è¯·æ±‚ï¼Œå¦‚æœåŒ¹é…ä¸åˆ°å°±ä¼šå»OtherSecurityConfigç±»ä¸­è¿›è¡Œé…ç½®ï¼Œåœ¨è¿™ä¸ªç±»ä¸­ä¼šæ‹¦æˆªæ‰€æœ‰çš„è¯·æ±‚ã€‚ 6.æ–¹æ³•çº§åˆ«çš„å®‰å…¨åœ¨é…ç½®ç±»ä¸Šæ–¹æ·»åŠ æ³¨è§£ @EnableGlobalMethodSecurity(prePostEnabled = true,securedEnabled = true) 123@EnableWebSecurity@EnableGlobalMethodSecurity(prePostEnabled = true,securedEnabled = true)public class SecurityConfig extends WebSecurityConfigurerAdapter { åˆ›å»º service æ–¹æ³• 123456789101112131415161718192021@Servicepublic class MethodService { @PreAuthorize(&quot;hasRole('admin')&quot;) public String admin(){ return &quot;method admin&quot;; } @Secured(&quot;ROLE_user&quot;) public String user(){ return &quot;method user&quot;; } @PreAuthorize(&quot;hasAnyRole('admin','user')&quot;) public String hello(){ return &quot;method hello&quot;; }}","link":"/2022/08/23/01-security%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/"},{"title":"Spring Security åŸºäºæ•°æ®åº“ &amp; è§’è‰²ç»§æ‰¿","text":"æˆæƒæ‰€è°“çš„æˆæƒï¼Œå°±æ˜¯ç”¨æˆ·å¦‚æœè¦è®¿é—®æŸä¸€ä¸ªèµ„æºï¼Œæˆ‘ä»¬è¦å»æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·å¤‡è¿™æ ·çš„æƒé™ï¼Œå¦‚æœå…·å¤‡å°±å…è®¸è®¿é—®ï¼Œå¦‚æœä¸å…·å¤‡ï¼Œåˆ™ä¸å…è®¸è®¿é—®ã€‚ å‡†å¤‡æ•°æ®åº“è„šæœ¬1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071/*Navicat MySQL Data TransferSource Server : localhostSource Server Version : 50717Source Host : localhost:3306Source Database : securityTarget Server Type : MYSQLTarget Server Version : 50717File Encoding : 65001Date: 2018-07-28 15:26:51*/SET FOREIGN_KEY_CHECKS=0;-- ------------------------------ Table structure for role-- ----------------------------DROP TABLE IF EXISTS `role`;CREATE TABLE `role` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(32) DEFAULT NULL, `nameZh` varchar(32) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;-- ------------------------------ Records of role-- ----------------------------INSERT INTO `role` VALUES ('1', 'dba', 'æ•°æ®åº“ç®¡ç†å‘˜');INSERT INTO `role` VALUES ('2', 'admin', 'ç³»ç»Ÿç®¡ç†å‘˜');INSERT INTO `role` VALUES ('3', 'user', 'ç”¨æˆ·');-- ------------------------------ Table structure for user-- ----------------------------DROP TABLE IF EXISTS `user`;CREATE TABLE `user` ( `id` int(11) NOT NULL AUTO_INCREMENT, `username` varchar(32) DEFAULT NULL, `password` varchar(255) DEFAULT NULL, `enabled` tinyint(1) DEFAULT NULL, `locked` tinyint(1) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;-- ------------------------------ Records of user-- ----------------------------INSERT INTO `user` VALUES ('1', 'root', '$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq', '1', '0');INSERT INTO `user` VALUES ('2', 'admin', '$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq', '1', '0');INSERT INTO `user` VALUES ('3', 'sang', '$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq', '1', '0');-- ------------------------------ Table structure for user_role-- ----------------------------DROP TABLE IF EXISTS `user_role`;CREATE TABLE `user_role` ( `id` int(11) NOT NULL AUTO_INCREMENT, `uid` int(11) DEFAULT NULL, `rid` int(11) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;-- ------------------------------ Records of user_role-- ----------------------------INSERT INTO `user_role` VALUES ('1', '1', '1');INSERT INTO `user_role` VALUES ('2', '1', '2');INSERT INTO `user_role` VALUES ('3', '2', '2');INSERT INTO `user_role` VALUES ('4', '3', '3');SET FOREIGN_KEY_CHECKS=1; å®ä½“ç±» User ç±» å®ç° UserDetail æ¥å£ä¸­çš„æ–¹æ³• 123456789101112131415161718192021222324252627282930313233343536373839404142434445@Data@NoArgsConstructor@AllArgsConstructor@Accessors(chain = true)@ToString(callSuper = true)@TableName(value = &quot;user&quot;,resultMap = &quot;userWithRolesMap&quot;)public class User implements UserDetails { @TableId(type = IdType.AUTO) private Integer id; private String username; private String password; private Boolean enabled; private Boolean locked; private List&lt;Role&gt; roles; @Override public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() { List&lt;SimpleGrantedAuthority&gt; authorities = new ArrayList&lt;&gt;(); roles.forEach(r-&gt;{ authorities.add(new SimpleGrantedAuthority(&quot;ROLE_&quot;+r.getName())); }); return authorities; } @Override public boolean isAccountNonExpired() { return true; } @Override public boolean isAccountNonLocked() { return !locked; } @Override public boolean isCredentialsNonExpired() { return true; } @Override public boolean isEnabled() { return enabled; }} Role ç±» 1234567@Data@TableName(&quot;role&quot;)public class Role { private Integer id; private String name; private String nameZh;} UserService ç±»å®ç° UserDetailService ç±» 123456789101112131415161718192021222324@Servicepublic class UserServiceImpl implements UserService , UserDetailsService { @Autowired UserMapper userMapper; /** * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ· * @param username the username identifying the user whose data is required. * @return UserDetails * @throws UsernameNotFoundException */ @Override public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException { User user = userMapper.selectOne( new LambdaQueryWrapper&lt;User&gt;().eq(User::getUsername, username) ); if(user==null){ throw new UsernameNotFoundException(&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;); } return user; }} UserMapper æ¥å£ 123@Mapperpublic interface UserMapper extends BaseMapper&lt;User&gt; {} UserMapper.xml 12345678910&lt;mapper namespace=&quot;com.wenx.security.security.mapper.UserMapper&quot;&gt; &lt;resultMap id=&quot;userWithRolesMap&quot; type=&quot;com.wenx.security.security.bean.User&quot;&gt; &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt; &lt;result column=&quot;username&quot; property=&quot;username&quot;/&gt; &lt;result column=&quot;password&quot; property=&quot;password&quot;/&gt; &lt;result column=&quot;enabled&quot; property=&quot;enabled&quot;/&gt; &lt;result column=&quot;locked&quot; property=&quot;locked&quot;/&gt; &lt;collection property=&quot;roles&quot; column=&quot;id&quot; select=&quot;com.wenx.security.security.mapper.RoleMapper.selectRolesByUid&quot;/&gt; &lt;/resultMap&gt;&lt;/mapper&gt; RoleMapper.xml 12345&lt;mapper namespace=&quot;com.wenx.security.security.mapper.RoleMapper&quot;&gt; &lt;select id=&quot;selectRolesByUid&quot; resultType=&quot;com.wenx.security.security.bean.Role&quot;&gt; select r.* from role r,user u,user_role ur where u.id=ur.uid and r.id=ur.rid and u.id = #{uid} &lt;/select&gt;&lt;/mapper&gt; é…ç½®ç±»12345678910111213141516171819202122232425262728293031323334353637383940414243444546package com.wenx.security.security.config;import com.wenx.security.security.service.UserService;import com.wenx.security.security.service.impl.UserServiceImpl;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.annotation.Bean;import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;import org.springframework.security.config.annotation.web.builders.HttpSecurity;import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;import org.springframework.security.core.userdetails.UserDetails;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;import org.springframework.security.crypto.password.PasswordEncoder;import javax.annotation.Resource;@EnableWebSecuritypublic class SecurityConfig extends WebSecurityConfigurerAdapter { @Resource UserServiceImpl userService; @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { auth.userDetailsService(userService); } @Bean PasswordEncoder passwordEncoder(){ return new BCryptPasswordEncoder(); } @Override protected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .antMatchers(&quot;/dba/**&quot;).hasRole(&quot;dba&quot;) .antMatchers(&quot;/user/**&quot;).hasRole(&quot;user&quot;) .antMatchers(&quot;/admin/**&quot;).hasRole(&quot;admin&quot;) .anyRequest().authenticated() .and() .formLogin() .permitAll() .and() .csrf().disable(); }} å‡†å¤‡æ¥å£1234567891011121314151617181920@GetMapping(&quot;/hello&quot;)String hello(){ return &quot;hello&quot;;}@GetMapping(&quot;/dba/hello&quot;)String dbaHello(){ return &quot;DBA hello&quot;;}@GetMapping(&quot;/admin/hello&quot;)String adminHello(){ return &quot;admin hello&quot;;}@GetMapping(&quot;/user/hello&quot;)String userHello(){ return &quot;user hello&quot;;} å½“æˆ‘ä»¬ä½¿ç”¨ root ç”¨æˆ·è¿›è¡Œç™»å½•ï¼Œ/dba/hello /admin/helloæ˜¯å¯ä»¥è¿›è¡Œè®¿é—®çš„ /user/helloæ²¡æœ‰æƒé™è®¿é—® è§’è‰²ç»§æ‰¿è§’è‰²ç»§æ‰¿å®é™…ä¸Šæ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„éœ€æ±‚ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å…¬å¸æ²»ç†å¯èƒ½éƒ½æ˜¯é‡‘å­—å¡”å½¢çš„ï¼Œä¸Šå¸å¯èƒ½å…·å¤‡ä¸‹å±çš„éƒ¨åˆ†ç”šè‡³æ‰€æœ‰æƒé™ï¼Œè¿™ä¸€ç°å®åœºæ™¯ï¼Œåæ˜ åˆ°æˆ‘ä»¬çš„ä»£ç ä¸­ï¼Œå°±æ˜¯è§’è‰²ç»§æ‰¿äº†ã€‚ Spring Security ä¸­ä¸ºå¼€å‘è€…æä¾›äº†ç›¸å…³çš„è§’è‰²ç»§æ‰¿è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯è¿™ä¸€è§£å†³æ–¹æ¡ˆåœ¨æœ€è¿‘çš„ Spring Security ç‰ˆæœ¬å˜è¿ä¸­ï¼Œä½¿ç”¨æ–¹æ³•æœ‰æ‰€å˜åŒ–ã€‚ pringSecurity åœ¨è§’è‰²ç»§æ‰¿ä¸Šæœ‰ä¸¤ç§ä¸åŒçš„å†™æ³•ï¼Œåœ¨ Spring Boot2.0.8ï¼ˆå¯¹åº” Spring Security ä¹Ÿæ˜¯ 5.0.11ï¼‰ä¸Šé¢æ˜¯ä¸€ç§å†™æ³•ï¼Œä» Spring Boot2.1.0ï¼ˆå¯¹åº” Spring Security5.1.1ï¼‰åˆæ˜¯å¦å¤–ä¸€ç§å†™æ³• ä»¥å‰çš„å†™æ³•è¿™é‡Œè¯´çš„ä»¥å‰å†™æ³•ï¼Œå°±æ˜¯æŒ‡ SpringBoot2.0.8ï¼ˆå«ï¼‰ä¹‹å‰çš„å†™æ³•ï¼Œåœ¨ä¹‹å‰çš„å†™æ³•ä¸­ï¼Œè§’è‰²ç»§æ‰¿åªéœ€è¦å¼€å‘è€…æä¾›ä¸€ä¸ª RoleHierarchy æ¥å£çš„å®ä¾‹å³å¯ï¼Œä¾‹å¦‚ä¸‹é¢è¿™æ ·ï¼š 1234567@BeanRoleHierarchy roleHierarchy() { RoleHierarchyImpl roleHierarchy = new RoleHierarchyImpl(); String hierarchy = &quot;ROLE_dba &gt; ROLE_admin ROLE_admin &gt; ROLE_user&quot;; roleHierarchy.setHierarchy(hierarchy); return roleHierarchy;} åœ¨è¿™é‡Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ª RoleHierarchy æ¥å£çš„å®ä¾‹ï¼Œä½¿ç”¨å­—ç¬¦ä¸²æ¥æè¿°äº†è§’è‰²ä¹‹é—´çš„ç»§æ‰¿å…³ç³»ï¼Œ ROLE_dba å…·å¤‡ ROLE_admin çš„æ‰€æœ‰æƒé™ï¼Œè€Œ ROLE_admin åˆ™å…·å¤‡ ROLE_user çš„æ‰€æœ‰æƒé™ï¼Œç»§æ‰¿ä¸ç»§æ‰¿ä¹‹é—´ç”¨ä¸€ä¸ªç©ºæ ¼éš”å¼€ã€‚æä¾›äº†è¿™ä¸ª Bean ä¹‹åï¼Œä»¥åæ‰€æœ‰å…·å¤‡ ROLE_user è§’è‰²æ‰èƒ½è®¿é—®çš„èµ„æºï¼Œ ROLE_dba å’Œ ROLE_admin ä¹Ÿéƒ½èƒ½è®¿é—®ï¼Œå…·å¤‡ ROLE_amdin è§’è‰²æ‰èƒ½è®¿é—®çš„èµ„æºï¼Œ ROLE_dba ä¹Ÿèƒ½è®¿é—®ã€‚ ç°åœ¨çš„å†™æ³•ä½†æ˜¯ä¸Šé¢è¿™ç§å†™æ³•ä»…é™äº Spring Boot2.0.8ï¼ˆå«ï¼‰ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œåœ¨ä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œè¿™ç§å†™æ³•åˆ™ä¸è¢«æ”¯æŒï¼Œæ–°ç‰ˆçš„å†™æ³•æ˜¯ä¸‹é¢è¿™æ ·ï¼š 1234567@BeanRoleHierarchy roleHierarchy() { RoleHierarchyImpl roleHierarchy = new RoleHierarchyImpl(); String hierarchy = &quot;ROLE_dba &gt; ROLE_admin \\n ROLE_admin &gt; ROLE_user&quot;; roleHierarchy.setHierarchy(hierarchy); return roleHierarchy;} å˜åŒ–ä¸»è¦å°±æ˜¯åˆ†éš”ç¬¦ï¼Œå°†åŸæ¥ç”¨ç©ºæ ¼éš”å¼€çš„åœ°æ–¹ï¼Œç°åœ¨ç”¨æ¢è¡Œç¬¦äº†ã€‚è¿™é‡Œè¡¨è¾¾å¼çš„å«ä¹‰ä¾ç„¶å’Œä¸Šé¢ä¸€æ ·ï¼Œä¸å†èµ˜è¿°ã€‚ ä¸Šé¢ä¸¤ç§ä¸åŒå†™æ³•éƒ½æ˜¯é…ç½®è§’è‰²çš„ç»§æ‰¿å…³ç³»ï¼Œé…ç½®å®Œæˆåï¼Œæ¥ä¸‹æ¥æŒ‡å®šè§’è‰²å’Œèµ„æºçš„å¯¹åº”å…³ç³»å³å¯ï¼Œå¦‚ä¸‹ï¼š 123456789101112131415@Overrideprotected void configure(HttpSecurity http) throws Exception { http.authorizeRequests().antMatchers(&quot;/admin/**&quot;) .hasRole(&quot;admin&quot;) .antMatchers(&quot;/db/**&quot;) .hasRole(&quot;dba&quot;) .antMatchers(&quot;/user/**&quot;) .hasRole(&quot;user&quot;) .and() .formLogin() .loginProcessingUrl(&quot;/doLogin&quot;) .permitAll() .and() .csrf().disable();} è¿™ä¸ªè¡¨ç¤º /db/** æ ¼å¼çš„è·¯å¾„éœ€è¦å…·å¤‡ dba è§’è‰²æ‰èƒ½è®¿é—®ï¼Œ /admin/** æ ¼å¼çš„è·¯å¾„åˆ™éœ€è¦å…·å¤‡ admin è§’è‰²æ‰èƒ½è®¿é—®ï¼Œ /user/** æ ¼å¼çš„è·¯å¾„ï¼Œåˆ™éœ€è¦å…·å¤‡ user è§’è‰²æ‰èƒ½è®¿é—®ï¼Œæ­¤æ—¶æä¾›ç›¸å…³æ¥å£ï¼Œä¼šå‘ç°ï¼Œdba é™¤äº†è®¿é—® /db/** ï¼Œä¹Ÿèƒ½è®¿é—® /admin/** å’Œ /user/** ï¼Œadmin è§’è‰²é™¤äº†è®¿é—® /admin/** ï¼Œä¹Ÿèƒ½è®¿é—® /user/** ï¼Œuser è§’è‰²åˆ™åªèƒ½è®¿é—® /user/** ã€‚ æºç åˆ†æè¿™æ ·ä¸¤ç§ä¸åŒçš„å†™æ³•ï¼Œå…¶å®ä¹Ÿå¯¹åº”äº†ä¸¤ç§ä¸åŒçš„è§£æç­–ç•¥ï¼Œè§’è‰²ç»§æ‰¿å…³ç³»çš„è§£æåœ¨ RoleHierarchyImpl ç±»çš„ buildRolesReachableInOneStepMap æ–¹æ³•ä¸­ï¼ŒSpring Boot2.0.8ï¼ˆå«ï¼‰ä¹‹å‰è¯¥æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425private void buildRolesReachableInOneStepMap() { Pattern pattern = Pattern.compile(&quot;(\\\\s*([^\\\\s&gt;]+)\\\\s*&gt;\\\\s*([^\\\\s&gt;]+))&quot;); Matcher roleHierarchyMatcher = pattern .matcher(this.roleHierarchyStringRepresentation); this.rolesReachableInOneStepMap = new HashMap&lt;GrantedAuthority, Set&lt;GrantedAuthority&gt;&gt;(); while (roleHierarchyMatcher.find()) { GrantedAuthority higherRole = new SimpleGrantedAuthority( roleHierarchyMatcher.group(2)); GrantedAuthority lowerRole = new SimpleGrantedAuthority( roleHierarchyMatcher.group(3)); Set&lt;GrantedAuthority&gt; rolesReachableInOneStepSet; if (!this.rolesReachableInOneStepMap.containsKey(higherRole)) { rolesReachableInOneStepSet = new HashSet&lt;&gt;(); this.rolesReachableInOneStepMap.put(higherRole, rolesReachableInOneStepSet); } else { rolesReachableInOneStepSet = this.rolesReachableInOneStepMap .get(higherRole); } addReachableRoles(rolesReachableInOneStepSet, lowerRole); logger.debug(&quot;buildRolesReachableInOneStepMap() - From role &quot; + higherRole + &quot; one can reach role &quot; + lowerRole + &quot; in one step.&quot;); }} ä»è¿™æ®µæºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè§’è‰²çš„ç»§æ‰¿å…³ç³»æ˜¯é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œè§£æï¼Œé€šè¿‡ç©ºæ ¼è¿›è¡Œåˆ‡åˆ†ï¼Œç„¶åæ„å»ºç›¸åº”çš„ map å‡ºæ¥ã€‚ Spring Boot2.1.0ï¼ˆå«ï¼‰ä¹‹åè¯¥æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728private void buildRolesReachableInOneStepMap() { this.rolesReachableInOneStepMap = new HashMap&lt;GrantedAuthority, Set&lt;GrantedAuthority&gt;&gt;(); try (BufferedReader bufferedReader = new BufferedReader( new StringReader(this.roleHierarchyStringRepresentation))) { for (String readLine; (readLine = bufferedReader.readLine()) != null;) { String[] roles = readLine.split(&quot; &gt; &quot;); for (int i = 1; i &lt; roles.length; i++) { GrantedAuthority higherRole = new SimpleGrantedAuthority( roles[i - 1].replaceAll(&quot;^\\\\s+|\\\\s+$&quot;, &quot;&quot;)); GrantedAuthority lowerRole = new SimpleGrantedAuthority(roles[i].replaceAll(&quot;^\\\\s+|\\\\s+$ Set&lt;GrantedAuthority&gt; rolesReachableInOneStepSet; if (!this.rolesReachableInOneStepMap.containsKey(higherRole)) { rolesReachableInOneStepSet = new HashSet&lt;GrantedAuthority&gt;(); this.rolesReachableInOneStepMap.put(higherRole, rolesReachableInOneStepSet); } else { rolesReachableInOneStepSet = this.rolesReachableInOneStepMap.get(higherRole); } addReachableRoles(rolesReachableInOneStepSet, lowerRole); if (logger.isDebugEnabled()) { logger.debug(&quot;buildRolesReachableInOneStepMap() - From role &quot; + higherRole + &quot; one can reach role &quot; + lowerRole + &quot; in one step.&quot;); } } } } catch (IOException e) { throw new IllegalStateException(e); }} ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰ä¸€ä¸Šæ¥å°±æ˜¯ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œè€Œæ˜¯å…ˆå°†è§’è‰²ç»§æ‰¿å­—ç¬¦ä¸²è½¬ä¸ºä¸€ä¸ª BufferedReader ï¼Œç„¶åä¸€è¡Œä¸€è¡Œçš„è¯»å‡ºæ¥ï¼Œå†è¿›è¡Œè§£æï¼Œæœ€åå†æ„å»ºç›¸åº”çš„ mapã€‚ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºä¸ºä»€ä¹ˆå‰åç‰ˆæœ¬å¯¹æ­¤æœ‰ä¸åŒçš„å†™æ³•ã€‚","link":"/2022/08/24/02-security%E5%9F%BA%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"title":"Spring Security OAuth2 ä»‹ç»","text":"1. ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ OAuth2å…³äºæˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦ OAuth2 çš„é—®é¢˜ï¼Œç½‘ä¸Šçš„æ–‡ç« å¾ˆå¤šï¼Œæˆ‘ä»¬å¸¸è§çš„ç¬¬ä¸‰æ–¹ç™»å½•å°±æ˜¯ä¸€ä¸ª OAuth2 çš„å…¸å‹åº”ç”¨ï¼Œé˜®ä¸€å³°å¤§ä½¬ä¹‹å‰æœ‰ä¸€ç¯‡æ–‡ç« éå¸¸å½¢è±¡çš„è§£é‡Šäº†è¿™ä¸ªé—®é¢˜ï¼Œå†…å®¹å¦‚ä¸‹ï¼ˆåŸæ–‡åœ°å€ï¼šhttps://www.ruanyifeng.com/blog/2019/04/oauth_design.htmlï¼‰ï¼š 1.1 å¿«é€’å‘˜é—®é¢˜æˆ‘ä½åœ¨ä¸€ä¸ªå¤§å‹çš„å±…æ°‘å°åŒºã€‚ å°åŒºæœ‰é—¨ç¦ç³»ç»Ÿã€‚ è¿›å…¥çš„æ—¶å€™éœ€è¦è¾“å…¥å¯†ç ã€‚ æˆ‘ç»å¸¸ç½‘è´­å’Œå¤–å–ï¼Œæ¯å¤©éƒ½æœ‰å¿«é€’å‘˜æ¥é€è´§ã€‚æˆ‘å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªåŠæ³•ï¼Œè®©å¿«é€’å‘˜é€šè¿‡é—¨ç¦ç³»ç»Ÿï¼Œè¿›å…¥å°åŒºã€‚ å¦‚æœæˆ‘æŠŠè‡ªå·±çš„å¯†ç ï¼Œå‘Šè¯‰å¿«é€’å‘˜ï¼Œä»–å°±æ‹¥æœ‰äº†ä¸æˆ‘åŒæ ·çš„æƒé™ï¼Œè¿™æ ·å¥½åƒä¸å¤ªåˆé€‚ã€‚ä¸‡ä¸€æˆ‘æƒ³å–æ¶ˆä»–è¿›å…¥å°åŒºçš„æƒåŠ›ï¼Œä¹Ÿå¾ˆéº»çƒ¦ï¼Œæˆ‘è‡ªå·±çš„å¯†ç ä¹Ÿå¾—è·Ÿç€æ”¹äº†ï¼Œè¿˜å¾—é€šçŸ¥å…¶ä»–çš„å¿«é€’å‘˜ã€‚ æœ‰æ²¡æœ‰ä¸€ç§åŠæ³•ï¼Œè®©å¿«é€’å‘˜èƒ½å¤Ÿè‡ªç”±è¿›å…¥å°åŒºï¼Œåˆä¸å¿…çŸ¥é“å°åŒºå±…æ°‘çš„å¯†ç ï¼Œè€Œä¸”ä»–çš„å”¯ä¸€æƒé™å°±æ˜¯é€è´§ï¼Œå…¶ä»–éœ€è¦å¯†ç çš„åœºåˆï¼Œä»–éƒ½æ²¡æœ‰æƒé™ï¼Ÿ 1.2 æˆæƒæœºåˆ¶çš„è®¾è®¡äºæ˜¯ï¼Œæˆ‘è®¾è®¡äº†ä¸€å¥—æˆæƒæœºåˆ¶ã€‚ ç¬¬ä¸€æ­¥ï¼Œé—¨ç¦ç³»ç»Ÿçš„å¯†ç è¾“å…¥å™¨ä¸‹é¢ï¼Œå¢åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œå«åšâ€è·å–æˆæƒâ€ã€‚å¿«é€’å‘˜éœ€è¦é¦–å…ˆæŒ‰è¿™ä¸ªæŒ‰é’®ï¼Œå»ç”³è¯·æˆæƒã€‚ ç¬¬äºŒæ­¥ï¼Œä»–æŒ‰ä¸‹æŒ‰é’®ä»¥åï¼Œå±‹ä¸»ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ï¼‰çš„æ‰‹æœºå°±ä¼šè·³å‡ºå¯¹è¯æ¡†ï¼šæœ‰äººæ­£åœ¨è¦æ±‚æˆæƒã€‚ç³»ç»Ÿè¿˜ä¼šæ˜¾ç¤ºè¯¥å¿«é€’å‘˜çš„å§“åã€å·¥å·å’Œæ‰€å±çš„å¿«é€’å…¬å¸ã€‚ æˆ‘ç¡®è®¤è¯·æ±‚å±å®ï¼Œå°±ç‚¹å‡»æŒ‰é’®ï¼Œå‘Šè¯‰é—¨ç¦ç³»ç»Ÿï¼Œæˆ‘åŒæ„ç»™äºˆä»–è¿›å…¥å°åŒºçš„æˆæƒã€‚ ç¬¬ä¸‰æ­¥ï¼Œé—¨ç¦ç³»ç»Ÿå¾—åˆ°æˆ‘çš„ç¡®è®¤ä»¥åï¼Œå‘å¿«é€’å‘˜æ˜¾ç¤ºä¸€ä¸ªè¿›å…¥å°åŒºçš„ä»¤ç‰Œï¼ˆaccess tokenï¼‰ã€‚ä»¤ç‰Œå°±æ˜¯ç±»ä¼¼å¯†ç çš„ä¸€ä¸²æ•°å­—ï¼Œåªåœ¨çŸ­æœŸå†…ï¼ˆæ¯”å¦‚ä¸ƒå¤©ï¼‰æœ‰æ•ˆã€‚ ç¬¬å››æ­¥ï¼Œå¿«é€’å‘˜å‘é—¨ç¦ç³»ç»Ÿè¾“å…¥ä»¤ç‰Œï¼Œè¿›å…¥å°åŒºã€‚ æœ‰äººå¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯è¿œç¨‹ä¸ºå¿«é€’å‘˜å¼€é—¨ï¼Œè€Œè¦ä¸ºä»–å•ç‹¬ç”Ÿæˆä¸€ä¸ªä»¤ç‰Œï¼Ÿè¿™æ˜¯å› ä¸ºå¿«é€’å‘˜å¯èƒ½æ¯å¤©éƒ½ä¼šæ¥é€è´§ï¼Œç¬¬äºŒå¤©ä»–è¿˜å¯ä»¥å¤ç”¨è¿™ä¸ªä»¤ç‰Œã€‚å¦å¤–ï¼Œæœ‰çš„å°åŒºæœ‰å¤šé‡é—¨ç¦ï¼Œå¿«é€’å‘˜å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªä»¤ç‰Œé€šè¿‡å®ƒä»¬ã€‚ 1.3 äº’è”ç½‘åœºæ™¯æˆ‘ä»¬æŠŠä¸Šé¢çš„ä¾‹å­æ¬åˆ°äº’è”ç½‘ï¼Œå°±æ˜¯ OAuth çš„è®¾è®¡äº†ã€‚ é¦–å…ˆï¼Œå±…æ°‘å°åŒºå°±æ˜¯å‚¨å­˜ç”¨æˆ·æ•°æ®çš„ç½‘ç»œæœåŠ¡ã€‚æ¯”å¦‚ï¼Œå¾®ä¿¡å‚¨å­˜äº†æˆ‘çš„å¥½å‹ä¿¡æ¯ï¼Œè·å–è¿™äº›ä¿¡æ¯ï¼Œå°±å¿…é¡»ç»è¿‡å¾®ä¿¡çš„â€é—¨ç¦ç³»ç»Ÿâ€ã€‚ å…¶æ¬¡ï¼Œå¿«é€’å‘˜ï¼ˆæˆ–è€…è¯´å¿«é€’å…¬å¸ï¼‰å°±æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œæƒ³è¦ç©¿è¿‡é—¨ç¦ç³»ç»Ÿï¼Œè¿›å…¥å°åŒºã€‚ æœ€åï¼Œæˆ‘å°±æ˜¯ç”¨æˆ·æœ¬äººï¼ŒåŒæ„æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨è¿›å…¥å°åŒºï¼Œè·å–æˆ‘çš„æ•°æ®ã€‚ ç®€å•è¯´ï¼ŒOAuth å°±æ˜¯ä¸€ç§æˆæƒæœºåˆ¶ã€‚æ•°æ®çš„æ‰€æœ‰è€…å‘Šè¯‰ç³»ç»Ÿï¼ŒåŒæ„æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨è¿›å…¥ç³»ç»Ÿï¼Œè·å–è¿™äº›æ•°æ®ã€‚ç³»ç»Ÿä»è€Œäº§ç”Ÿä¸€ä¸ªçŸ­æœŸçš„è¿›å…¥ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œç”¨æ¥ä»£æ›¿å¯†ç ï¼Œä¾›ç¬¬ä¸‰æ–¹åº”ç”¨ä½¿ç”¨ã€‚ 1.4 ä»¤ç‰Œä¸å¯†ç ä»¤ç‰Œï¼ˆtokenï¼‰ä¸å¯†ç ï¼ˆpasswordï¼‰çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œéƒ½å¯ä»¥è¿›å…¥ç³»ç»Ÿï¼Œä½†æ˜¯æœ‰ä¸‰ç‚¹å·®å¼‚ã€‚ ï¼ˆ1ï¼‰ä»¤ç‰Œæ˜¯çŸ­æœŸçš„ï¼Œåˆ°æœŸä¼šè‡ªåŠ¨å¤±æ•ˆï¼Œç”¨æˆ·è‡ªå·±æ— æ³•ä¿®æ”¹ã€‚å¯†ç ä¸€èˆ¬é•¿æœŸæœ‰æ•ˆï¼Œç”¨æˆ·ä¸ä¿®æ”¹ï¼Œå°±ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚ ï¼ˆ2ï¼‰ä»¤ç‰Œå¯ä»¥è¢«æ•°æ®æ‰€æœ‰è€…æ’¤é”€ï¼Œä¼šç«‹å³å¤±æ•ˆã€‚ä»¥ä¸Šä¾‹è€Œè¨€ï¼Œå±‹ä¸»å¯ä»¥éšæ—¶å–æ¶ˆå¿«é€’å‘˜çš„ä»¤ç‰Œã€‚å¯†ç ä¸€èˆ¬ä¸å…è®¸è¢«ä»–äººæ’¤é”€ã€‚ ï¼ˆ3ï¼‰ä»¤ç‰Œæœ‰æƒé™èŒƒå›´ï¼ˆscopeï¼‰ï¼Œæ¯”å¦‚åªèƒ½è¿›å°åŒºçš„äºŒå·é—¨ã€‚å¯¹äºç½‘ç»œæœåŠ¡æ¥è¯´ï¼Œåªè¯»ä»¤ç‰Œå°±æ¯”è¯»å†™ä»¤ç‰Œæ›´å®‰å…¨ã€‚å¯†ç ä¸€èˆ¬æ˜¯å®Œæ•´æƒé™ã€‚ ä¸Šé¢è¿™äº›è®¾è®¡ï¼Œä¿è¯äº†ä»¤ç‰Œæ—¢å¯ä»¥è®©ç¬¬ä¸‰æ–¹åº”ç”¨è·å¾—æƒé™ï¼ŒåŒæ—¶åˆéšæ—¶å¯æ§ï¼Œä¸ä¼šå±åŠç³»ç»Ÿå®‰å…¨ã€‚è¿™å°±æ˜¯ OAuth2.0 çš„ä¼˜ç‚¹ã€‚ æ³¨æ„ï¼Œåªè¦çŸ¥é“äº†ä»¤ç‰Œï¼Œå°±èƒ½è¿›å…¥ç³»ç»Ÿã€‚ç³»ç»Ÿä¸€èˆ¬ä¸ä¼šå†æ¬¡ç¡®è®¤èº«ä»½ï¼Œæ‰€ä»¥ä»¤ç‰Œå¿…é¡»ä¿å¯†ï¼Œæ³„æ¼ä»¤ç‰Œä¸æ³„æ¼å¯†ç çš„åæœæ˜¯ä¸€æ ·çš„ã€‚ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä»¤ç‰Œçš„æœ‰æ•ˆæœŸï¼Œä¸€èˆ¬éƒ½è®¾ç½®å¾—å¾ˆçŸ­çš„åŸå› ã€‚ OAuth2.0 å¯¹äºå¦‚ä½•é¢å‘ä»¤ç‰Œçš„ç»†èŠ‚ï¼Œè§„å®šå¾—éå¸¸è¯¦ç»†ã€‚å…·ä½“æ¥è¯´ï¼Œä¸€å…±åˆ†æˆå››ç§æˆæƒç±»å‹ï¼ˆauthorization grantï¼‰ï¼Œå³å››ç§é¢å‘ä»¤ç‰Œçš„æ–¹å¼ï¼Œé€‚ç”¨äºä¸åŒçš„äº’è”ç½‘åœºæ™¯ã€‚ è¿™æ®µçœ‹å®Œï¼Œç›¸ä¿¡å¤§å®¶å·²ç»å¤§æ¦‚æ˜ç™½ OAuth2 çš„ä½œç”¨äº†ã€‚ 2. ä»€ä¹ˆæ˜¯ OAuth2OAuth æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œè¯¥æ ‡å‡†å…è®¸ç”¨æˆ·è®©ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®è¯¥ç”¨æˆ·åœ¨æŸä¸€ç½‘ç«™ä¸Šå­˜å‚¨çš„ç§å¯†èµ„æºï¼ˆå¦‚å¤´åƒã€ç…§ç‰‡ã€è§†é¢‘ç­‰ï¼‰ï¼Œè€Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ— éœ€å°†ç”¨æˆ·åå’Œå¯†ç æä¾›ç»™ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚å®ç°è¿™ä¸€åŠŸèƒ½æ˜¯é€šè¿‡æä¾›ä¸€ä¸ªä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œè€Œä¸æ˜¯ç”¨æˆ·åå’Œå¯†ç æ¥è®¿é—®ä»–ä»¬å­˜æ”¾åœ¨ç‰¹å®šæœåŠ¡æä¾›è€…çš„æ•°æ®ã€‚é‡‡ç”¨ä»¤ç‰Œï¼ˆtokenï¼‰çš„æ–¹å¼å¯ä»¥è®©ç”¨æˆ·çµæ´»çš„å¯¹ç¬¬ä¸‰æ–¹åº”ç”¨æˆæƒæˆ–è€…æ”¶å›æƒé™ã€‚ OAuth2 æ˜¯ OAuth åè®®çš„ä¸‹ä¸€ç‰ˆæœ¬ï¼Œä½†ä¸å‘ä¸‹å…¼å®¹ OAuth 1.0ã€‚ä¼ ç»Ÿçš„ Web å¼€å‘ç™»å½•è®¤è¯ä¸€èˆ¬éƒ½æ˜¯åŸºäº session çš„ï¼Œä½†æ˜¯åœ¨å‰åç«¯åˆ†ç¦»çš„æ¶æ„ä¸­ç»§ç»­ä½¿ç”¨ session å°±ä¼šæœ‰è®¸å¤šä¸ä¾¿ï¼Œå› ä¸ºç§»åŠ¨ç«¯ï¼ˆAndroidã€iOSã€å¾®ä¿¡å°ç¨‹åºç­‰ï¼‰è¦ä¹ˆä¸æ”¯æŒ cookieï¼ˆå¾®ä¿¡å°ç¨‹åºï¼‰ï¼Œè¦ä¹ˆä½¿ç”¨éå¸¸ä¸ä¾¿ï¼Œå¯¹äºè¿™äº›é—®é¢˜ï¼Œä½¿ç”¨ OAuth2 è®¤è¯éƒ½èƒ½è§£å†³ã€‚ å¯¹äºå¤§å®¶è€Œè¨€ï¼Œæˆ‘ä»¬åœ¨äº’è”ç½‘åº”ç”¨ä¸­æœ€å¸¸è§çš„ OAuth2 åº”è¯¥å°±æ˜¯å„ç§ç¬¬ä¸‰æ–¹ç™»å½•äº†ï¼Œä¾‹å¦‚ QQ æˆæƒç™»å½•ã€å¾®ä¿¡æˆæƒç™»å½•ã€å¾®åšæˆæƒç™»å½•ã€GitHub æˆæƒç™»å½•ç­‰ç­‰ã€‚ 3. å››ç§æ¨¡å¼OAuth2 åè®®ä¸€å…±æ”¯æŒ 4 ç§ä¸åŒçš„æˆæƒæ¨¡å¼ï¼š æˆæƒç æ¨¡å¼ï¼šå¸¸è§çš„ç¬¬ä¸‰æ–¹å¹³å°ç™»å½•åŠŸèƒ½åŸºæœ¬éƒ½æ˜¯ä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚ ç®€åŒ–æ¨¡å¼ï¼šç®€åŒ–æ¨¡å¼æ˜¯ä¸éœ€è¦å®¢æˆ·ç«¯æœåŠ¡å™¨å‚ä¸ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­å‘æˆæƒæœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œä¸€èˆ¬å¦‚æœç½‘ç«™æ˜¯çº¯é™æ€é¡µé¢åˆ™å¯ä»¥é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚ å¯†ç æ¨¡å¼ï¼šå¯†ç æ¨¡å¼æ˜¯ç”¨æˆ·æŠŠç”¨æˆ·åå¯†ç ç›´æ¥å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨è¯´è¿™äº›ä¿¡æ¯å‘æˆæƒæœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼ˆtokenï¼‰ã€‚è¿™éœ€è¦ç”¨æˆ·å¯¹å®¢æˆ·ç«¯é«˜åº¦ä¿¡ä»»ï¼Œä¾‹å¦‚å®¢æˆ·ç«¯åº”ç”¨å’ŒæœåŠ¡æä¾›å•†å°±æ˜¯åŒä¸€å®¶å…¬å¸ï¼Œæˆ‘ä»¬è‡ªå·±åšå‰åç«¯åˆ†ç¦»ç™»å½•å°±å¯ä»¥é‡‡ç”¨è¿™ç§æ¨¡å¼ã€‚ å®¢æˆ·ç«¯æ¨¡å¼ï¼šå®¢æˆ·ç«¯æ¨¡å¼æ˜¯æŒ‡å®¢æˆ·ç«¯ä½¿ç”¨è‡ªå·±çš„åä¹‰è€Œä¸æ˜¯ç”¨æˆ·çš„åä¹‰å‘æœåŠ¡æä¾›è€…ç”³è¯·æˆæƒï¼Œä¸¥æ ¼æ¥è¯´ï¼Œå®¢æˆ·ç«¯æ¨¡å¼å¹¶ä¸èƒ½ç®—ä½œ OAuth åè®®è¦è§£å†³çš„é—®é¢˜çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯ï¼Œå¯¹äºå¼€å‘è€…è€Œè¨€ï¼Œåœ¨ä¸€äº›å‰åç«¯åˆ†ç¦»åº”ç”¨æˆ–è€…ä¸ºç§»åŠ¨ç«¯æä¾›çš„è®¤è¯æˆæƒæœåŠ¡å™¨ä¸Šä½¿ç”¨è¿™ç§æ¨¡å¼è¿˜æ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚ 3.1 æˆæƒç æ¨¡å¼æˆæƒç æ¨¡å¼æ˜¯æœ€å®‰å…¨å¹¶ä¸”ä½¿ç”¨æœ€å¹¿æ³›çš„ä¸€ç§æ¨¡å¼ åœ¨æˆæƒç æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬åˆ†æˆæƒæœåŠ¡å™¨å’Œèµ„æºæœåŠ¡å™¨ï¼ŒæˆæƒæœåŠ¡å™¨ç”¨æ¥æ´¾å‘ Tokenï¼Œæ‹¿ç€ Token åˆ™å¯ä»¥å»èµ„æºæœåŠ¡å™¨è·å–èµ„æºï¼Œè¿™ä¸¤ä¸ªæœåŠ¡å™¨å¯ä»¥åˆ†å¼€ï¼Œä¹Ÿå¯ä»¥åˆå¹¶ã€‚ é¦–å…ˆï¼Œæˆ‘ä¼šåœ¨æˆ‘çš„ç½‘é¡µä¸Šæ”¾ä¸€ä¸ªè¶…é“¾æ¥ï¼ˆæˆ‘çš„ç½‘ç«™ç›¸å½“äºæ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨ï¼‰ï¼Œç”¨æˆ· A ï¼ˆæœåŠ¡æ–¹çš„ç”¨æˆ·ï¼Œä¾‹å¦‚å¾®ä¿¡ç”¨æˆ·ï¼‰ç‚¹å‡»è¿™ä¸ªè¶…é“¾æ¥å°±ä¼šå»è¯·æ±‚æˆæƒæœåŠ¡å™¨ï¼ˆå¾®ä¿¡çš„æˆæƒæœåŠ¡å™¨ï¼‰ï¼Œç”¨æˆ·ç‚¹å‡»çš„è¿‡ç¨‹å…¶å®ä¹Ÿå°±æ˜¯æˆ‘è·Ÿç”¨æˆ·è¦æˆæƒçš„è¿‡ç¨‹ï¼Œè¿™å°±æ˜¯ä¸Šå›¾ä¸­çš„ 1ã€2 æ­¥ã€‚ æ¥ä¸‹æ¥çš„ç¬¬ä¸‰æ­¥ï¼Œå°±æ˜¯ç”¨æˆ·ç‚¹å‡»äº†è¶…é“¾æ¥ä¹‹åï¼ŒåƒæˆæƒæœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘æ”¾åœ¨ç½‘é¡µä¸Šçš„è¶…é“¾æ¥å¯èƒ½æœ‰å¦‚ä¸‹å‚æ•°ï¼š 1https://wx.qq.com/oauth/authorize?response_type=code&amp;client_id=javaboy&amp;redirect_uri=www.javaboy.org&amp;scope=all è¿™é‡Œè¾¹æœ‰å¥½å‡ ä¸ªå‚æ•°ï¼Œåœ¨åé¢çš„ä»£ç ä¸­æˆ‘ä»¬éƒ½ä¼šç”¨åˆ°ï¼Œè¿™é‡Œå…ˆå’Œå¤§å®¶ç®€å•è§£é‡Šä¸€ä¸‹ï¼š response_type è¡¨ç¤ºæˆæƒç±»å‹ï¼Œä½¿ç”¨æˆæƒç æ¨¡å¼çš„æ—¶å€™è¿™é‡Œå›ºå®šä¸º codeï¼Œè¡¨ç¤ºè¦æ±‚è¿”å›æˆæƒç ï¼ˆå°†æ¥æ‹¿ç€è¿™ä¸ªæˆæƒç å»è·å– access_tokenï¼‰ã€‚ client_id è¡¨ç¤ºå®¢æˆ·ç«¯ idï¼Œä¹Ÿå°±æ˜¯æˆ‘åº”ç”¨çš„ idã€‚æœ‰çš„å°ä¼™ä¼´å¯¹è¿™ä¸ªä¸å¥½ç†è§£ï¼Œæˆ‘è¯´ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘æƒ³è®©æˆ‘çš„ www.javaboy.org æ¥å…¥å¾®ä¿¡ç™»å½•åŠŸèƒ½ï¼Œæˆ‘è‚¯å®šå¾—å»å¾®ä¿¡å¼€æ”¾å¹³å°æ³¨å†Œï¼Œå»å¡«å…¥æˆ‘è‡ªå·±åº”ç”¨çš„åŸºæœ¬ä¿¡æ¯ç­‰ç­‰ï¼Œå¼„å®Œä¹‹åï¼Œå¾®ä¿¡ä¼šç»™æˆ‘ä¸€ä¸ª APPIDï¼Œä¹Ÿå°±æ˜¯æˆ‘è¿™é‡Œçš„ client_idï¼Œæ‰€ä»¥ï¼Œä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼ŒæˆæƒæœåŠ¡å™¨åœ¨æ ¡éªŒçš„æ—¶å€™ï¼Œä¼šåšä¸¤ä»¶äº‹ï¼š1.æ ¡éªŒå®¢æˆ·ç«¯çš„èº«ä»½ï¼›2.æ ¡éªŒç”¨æˆ·èº«ä»½ã€‚ redirect_uri è¡¨ç¤ºç”¨æˆ·ç™»å½•åœ¨æˆåŠŸ/å¤±è´¥åï¼Œè·³è½¬çš„åœ°å€ï¼ˆæˆåŠŸç™»å½•å¾®ä¿¡åï¼Œè·³è½¬åˆ° www.javaboy.org ä¸­çš„å“ªä¸ªé¡µé¢ï¼‰ï¼Œè·³è½¬çš„æ—¶å€™ï¼Œè¿˜ä¼šæºå¸¦ä¸Šä¸€ä¸ªæˆæƒç å‚æ•°ã€‚ scope è¡¨ç¤ºæˆæƒèŒƒå›´ï¼Œå³ www.javaboy.org è¿™ä¸ªç½‘ç«™æ‹¿ç€ç”¨æˆ·çš„ token éƒ½èƒ½å¹²å•¥ï¼ˆä¸€èˆ¬æ¥è¯´å°±æ˜¯è·å–ç”¨æˆ·éæ•æ„Ÿçš„åŸºæœ¬ä¿¡æ¯ï¼‰ã€‚ æ¥ä¸‹æ¥ç¬¬å››æ­¥ï¼Œæˆ‘ä»¬çš„ç½‘ç«™ï¼Œæ‹¿ç€ç¬¬ä¸‰æ­¥è·å–åˆ°çš„ code ä»¥åŠè‡ªå·±çš„ client_id å’Œ client_secret ä»¥åŠå…¶ä»–ä¸€äº›ä¿¡æ¯å»æˆæƒæœåŠ¡å™¨è¯·æ±‚ä»¤ç‰Œï¼Œå¾®ä¿¡çš„æˆæƒæœåŠ¡å™¨åœ¨æ ¡éªŒè¿‡è¿™äº›æ•°æ®ä¹‹åï¼Œå°±ä¼šå‘é€ä¸€ä¸ªä»¤ç‰Œå›æ¥ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸€èˆ¬æ˜¯åœ¨åç«¯å®Œæˆçš„ï¼Œè€Œä¸æ˜¯åˆ©ç”¨ js å»å®Œæˆã€‚ æ¥ä¸‹æ¥æ‹¿ç€è¿™ä¸ª tokenï¼Œæˆ‘ä»¬å°±å¯ä»¥å»è¯·æ±‚ç”¨æˆ·ä¿¡æ¯äº†ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬è®¤ä¸ºæˆæƒç æ¨¡å¼æ˜¯å››ç§æ¨¡å¼ä¸­æœ€å®‰å…¨çš„ä¸€ç§æ¨¡å¼ï¼Œå› ä¸ºè¿™ç§æ¨¡å¼æˆ‘ä»¬çš„ access_token ä¸ç”¨ç»è¿‡æµè§ˆå™¨æˆ–è€…ç§»åŠ¨ç«¯ Appï¼Œæ˜¯ç›´æ¥ä»æˆ‘ä»¬çš„åå°å‘é€åˆ°æˆæƒæœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·å°±å¾ˆå¤§ç¨‹åº¦å‡å°‘äº† access_token æ³„æ¼çš„é£é™©ã€‚ OKï¼Œè¿™æ˜¯æˆ‘ä»¬ä»‹ç»çš„æˆæƒç æ¨¡å¼ã€‚ 3.2 ç®€åŒ–æ¨¡å¼ç®€åŒ–æ¨¡å¼æ˜¯æ€ä¹ˆä¸€å›äº‹å‘¢ï¼Ÿ è¿™ä¸ªæµç¨‹æ˜¯è¿™æ ·ï¼š åœ¨ç½‘ç«™ä¸Šæœ‰ä¸€ä¸ªå¾®ä¿¡ç™»å½•çš„è¶…é“¾æ¥ï¼Œè¿™ä¸ªè¶…é“¾æ¥ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š 1https://wx.qq.com/oauth/authorize?response_type=token&amp;client_id=javaboy&amp;redirect_uri=www.javaboy.org&amp;scope=all è¿™é‡Œçš„å‚æ•°å’Œå‰é¢æˆæƒç æ¨¡å¼çš„åŸºæœ¬ç›¸åŒï¼Œåªæœ‰ response_type çš„å€¼ä¸ä¸€æ ·ï¼Œè¿™é‡Œæ˜¯ tokenï¼Œè¡¨ç¤ºè¦æ±‚æˆæƒæœåŠ¡å™¨ç›´æ¥è¿”å› access_tokenã€‚ ç”¨æˆ·ç‚¹å‡»æˆ‘è¿™ä¸ªè¶…é“¾æ¥ä¹‹åï¼Œå°±ä¼šè·³è½¬åˆ°å¾®ä¿¡ç™»å½•é¡µé¢ï¼Œç„¶åç”¨æˆ·è¿›è¡Œç™»å½•ã€‚ ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œå¾®ä¿¡ä¼šè‡ªåŠ¨é‡å®šå‘åˆ° redirect_uri å‚æ•°æŒ‡å®šçš„è·³è½¬ç½‘å€ï¼ŒåŒæ—¶æºå¸¦ä¸Š access_tokenï¼Œè¿™æ ·ç”¨æˆ·åœ¨å‰ç«¯å°±è·å–åˆ° access_token äº†ã€‚ ç®€åŒ–æ¨¡å¼çš„å¼Šç«¯å¾ˆæ˜æ˜¾ï¼Œå› ä¸ºæ²¡æœ‰åç«¯ï¼Œæ‰€ä»¥éå¸¸ä¸å®‰å…¨ï¼Œé™¤éä½ å¯¹å®‰å…¨æ€§è¦æ±‚ä¸é«˜ï¼Œå¦åˆ™ä¸å»ºè®®ä½¿ç”¨ã€‚ 3.3 å¯†ç æ¨¡å¼å¯†ç æ¨¡å¼åœ¨ Spring Cloud é¡¹ç›®ä¸­æœ‰ç€éå¸¸å¹¿æ³›çš„åº”ç”¨ã€‚ å¯†ç æ¨¡å¼æœ‰ä¸€ä¸ªå‰æå°±æ˜¯ä½ é«˜åº¦ä¿¡ä»»ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œä¸¾ä¸ªä¸æ°å½“çš„ä¾‹å­ï¼šå¦‚æœæˆ‘è¦åœ¨ ç½‘ç«™ä¸Šæ¥å…¥å¾®ä¿¡ç™»å½•ï¼Œæˆ‘ä½¿ç”¨äº†å¯†ç æ¨¡å¼ï¼Œé‚£ä½ å°±è¦åœ¨ç½‘ç«™å»è¾“å…¥å¾®ä¿¡çš„ç”¨æˆ·åå¯†ç ï¼Œè¿™è‚¯å®šæ˜¯ä¸é è°±çš„ï¼Œæ‰€ä»¥å¯†ç æ¨¡å¼éœ€è¦ä½ éå¸¸ä¿¡ä»»ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚ å¾®æœåŠ¡ä¸­æœ‰ä¸€ä¸ªç‰¹æ®Šçš„åœºæ™¯ï¼Œå°±æ˜¯æœåŠ¡ä¹‹é—´çš„è°ƒç”¨ï¼Œç”¨å¯†ç æ¨¡å¼åšé‰´æƒæ˜¯éå¸¸æ°å½“ä¸è¿‡çš„äº†ã€‚ å¯†ç å¼çš„æµç¨‹æ¯”è¾ƒç®€å•ï¼š é¦–å…ˆä¼šå‘é€ä¸€ä¸ª post è¯·æ±‚ï¼Œç±»ä¼¼ä¸‹é¢è¿™æ ·çš„ï¼š 1https://wx.qq.com/oauth/authorize?response_type=password&amp;client_id=javaboy&amp;username=æ±Ÿå—ä¸€ç‚¹é›¨&amp;password=123 è¿™é‡Œçš„å‚æ•°å’Œå‰é¢æˆæƒç æ¨¡å¼çš„ç•¥æœ‰å·®å¼‚ï¼Œresponse_type çš„å€¼ä¸ä¸€æ ·ï¼Œè¿™é‡Œæ˜¯ passwordï¼Œè¡¨ç¤ºå¯†ç å¼ï¼Œå¦å¤–å¤šäº†ç”¨æˆ·å/å¯†ç å‚æ•°ï¼Œæ²¡æœ‰é‡å®šå‘çš„ redirect_uri ï¼Œå› ä¸ºè¿™é‡Œä¸éœ€è¦é‡å®šå‘ã€‚ å¾®ä¿¡æ ¡éªŒè¿‡ç”¨æˆ·å/å¯†ç ä¹‹åï¼Œç›´æ¥åœ¨ HTTP å“åº”ä¸­æŠŠ access_token è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ 3.4 å®¢æˆ·ç«¯æ¨¡å¼æœ‰çš„åº”ç”¨å¯èƒ½æ²¡æœ‰å‰ç«¯é¡µé¢ï¼Œå°±æ˜¯ä¸€ä¸ªåå° è¿™ä¸ªæ­¥éª¤ä¹Ÿå¾ˆç®€å•ï¼Œå°±ä¸¤æ­¥ï¼š å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚åˆ°æˆæƒæœåŠ¡å™¨ï¼Œè¯·æ±‚æ ¼å¼å¦‚ä¸‹ï¼š 1GET https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;client_id=APPID&amp;client_secret=APPSECRET è¿™é‡Œæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œå«ä¹‰å¦‚ä¸‹ï¼š grant_typeï¼Œè·å–access_tokenå¡«å†™client_credential client_id å’Œ client_secret ç”¨æ¥ç¡®è®¤å®¢æˆ·ç«¯çš„èº«ä»½ æˆæƒæœåŠ¡å™¨é€šè¿‡éªŒè¯åï¼Œä¼šç›´æ¥è¿”å› access_token ç»™å®¢æˆ·ç«¯ã€‚ å¤§å®¶å‘ç°ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¥½åƒæ²¡æœ‰ç”¨æˆ·ä»€ä¹ˆäº‹äº†ï¼æ˜¯çš„ï¼Œå®¢æˆ·ç«¯æ¨¡å¼ç»™å‡ºçš„ä»¤ç‰Œï¼Œå°±æ˜¯é’ˆå¯¹ç¬¬ä¸‰æ–¹åº”ç”¨çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹ç”¨æˆ·çš„ã€‚ åœ¨æ¥å…¥å¾®ä¿¡å…¬ä¼—å·åå°çš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªè·å– Access_token çš„æ­¥éª¤ï¼Œå…¶å®å°±æ˜¯è¿™ç§æ¨¡å¼ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œè¿™å…¶å®å°±æ˜¯å®¢æˆ·ç«¯æ¨¡å¼ã€‚","link":"/2022/08/24/04-OAuth2%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/"},{"title":"ç®€æ˜“æ­å»º Security OAuth2 é¡¹ç›®åŸºäº password æ¨¡å¼","text":"ç®€æ˜“æ­å»º Security OAuth2 é¡¹ç›®åŸºäº password æ¨¡å¼å¼•å…¥ä¾èµ–1234567891011121314151617181920212223242526272829303132333435363738394041424344&lt;dependencies&gt; &lt;!-- https://mvnrepository.com/artifact/org.springframework.security.oauth/spring-security-oauth2 --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.security.oauth&lt;/groupId&gt; &lt;artifactId&gt;spring-security-oauth2&lt;/artifactId&gt; &lt;version&gt;2.5.2.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;optional&gt;true&lt;/optional&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;exclusions&gt; &lt;exclusion&gt; &lt;groupId&gt;org.junit.vintage&lt;/groupId&gt; &lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;/exclusions&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.security&lt;/groupId&gt; &lt;artifactId&gt;spring-security-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt;&lt;/dependencies&gt; å¼•å…¥æˆæƒæœåŠ¡å™¨1234567891011121314151617181920212223242526272829303132333435363738394041@Configuration@EnableAuthorizationServerpublic class AuthorizationServerConfig extends AuthorizationServerConfigurerAdapter { @Autowired AuthenticationManager authenticationManager; @Autowired RedisConnectionFactory redisConnectionFactory; @Autowired UserDetailsService userDetailsService; @Bean PasswordEncoder passwordEncoder(){ return new BCryptPasswordEncoder(); } @Override public void configure(ClientDetailsServiceConfigurer clients) throws Exception { clients.inMemory() .withClient(&quot;password&quot;) .authorizedGrantTypes(&quot;password&quot;,&quot;refresh_token&quot;) .accessTokenValiditySeconds(1800) .resourceIds(&quot;rid&quot;) .scopes(&quot;all&quot;) .secret(&quot;$2a$10$igDDIJWXnYW3ZT7w.DkLx.IU4KInjbtZMXK4gjYXyyrowcx.mKjpO&quot;); } @Override public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception { endpoints.tokenStore(new RedisTokenStore(redisConnectionFactory)) .authenticationManager(authenticationManager) .userDetailsService(userDetailsService); } @Override public void configure(AuthorizationServerSecurityConfigurer security) throws Exception { security.allowFormAuthenticationForClients(); }} å¼•å…¥èµ„æºæœåŠ¡å™¨12345678910111213141516171819@Configuration@EnableResourceServerpublic class ResourceServerConfig extends ResourceServerConfigurerAdapter { @Override public void configure(ResourceServerSecurityConfigurer resources) throws Exception { resources.resourceId(&quot;rid&quot;) .stateless(true) //åŸºäºä»¤ç‰Œè®¤è¯ ; } @Override public void configure(HttpSecurity http) throws Exception { http.authorizeRequests().antMatchers(&quot;/admin/**&quot;) .hasRole(&quot;admin&quot;) .antMatchers(&quot;/user/**&quot;).hasRole(&quot;user&quot;) .anyRequest().authenticated(); }} å®¢æˆ·ç«¯æ­å»º123456789101112131415161718192021222324252627282930313233343536@EnableWebSecurity@Configurationpublic class SecurityConfig extends WebSecurityConfigurerAdapter { @Override @Bean protected AuthenticationManager authenticationManager() throws Exception { return super.authenticationManager(); } @Override @Bean protected UserDetailsService userDetailsService() { return super.userDetailsService(); } @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { auth.inMemoryAuthentication() .withUser(&quot;admin&quot;).password(&quot;123&quot;).roles(&quot;admin&quot;) .and() .withUser(&quot;user&quot;).password(&quot;123&quot;).roles(&quot;user&quot;); } @Override protected void configure(HttpSecurity http) throws Exception { http.antMatcher(&quot;/oauth/**&quot;) .authorizeRequests() .antMatchers(&quot;/oauth/**&quot;) .permitAll() .and() .csrf().disable(); }} æµ‹è¯•é¦–å…ˆåœ¨postmanä¸­å‘é€ post è¯·æ±‚ï¼šhttp://localhost:8080/oauth/tokenè·å–åˆ°å‚æ•° éœ€è¦æºå¸¦çš„å‚æ•°ï¼š client_id=password&amp;client_secret=123&amp;grant_type=password&amp;username=admin&amp;password=123&amp;scpoe=all client_id:å®¢æˆ·ç«¯ID client_secret: å®¢æˆ·ç«¯å¯†é’¥ grant_type:æƒé™ç±»å‹ username:ç”¨æˆ·å password:å¯†ç  scope:èŒƒå›´ è¿”å›å¦‚ä¸‹ï¼š 1234567{ &quot;access_token&quot;: &quot;aPmB0d6pK4ZKqnmQDEoWUqtww5M&quot;, &quot;token_type&quot;: &quot;bearer&quot;, &quot;refresh_token&quot;: &quot;zAgClPAjmXvjs6VA_DaDjuvMj2Y&quot;, &quot;expires_in&quot;: 1799, &quot;scope&quot;: &quot;all&quot;} å½“æˆ‘ä»¬éœ€è¦è®¿é—®èµ„æºçš„æ—¶å€™å‘é€è¯·æ±‚éœ€è¦æºå¸¦è¯·æ±‚å¤´ï¼š Authorization=Bearer aPmB0d6pK4ZKqnmQDEoWUqtww5M è¿™æ ·å°±å¯ä»¥æˆåŠŸè·å–åˆ°èµ„æº æˆ‘ä»¬çš„ token æ˜¯æœ‰è¿‡æœŸæ—¶é—´çš„ï¼Œå½“æˆ‘ä»¬éœ€è¦åˆ·æ–° token çš„æ—¶å€™éœ€è¦å‘é€è¯·æ±‚ï¼š æºå¸¦å‚æ•°ï¼š 1client_id=password&amp;client_secret=123&amp;grant_type=refresh_token&amp;refresh_token=zAgClPAjmXvjs6VA_DaDjuvMj2Y&amp; client_id client_secret grant_type refresh_token è¿”å›å¦‚ä¸‹ï¼š 1234567{ &quot;access_token&quot;: &quot;tJjJfcmCwHx-vGPraXlwyPcsCz8&quot;, &quot;token_type&quot;: &quot;bearer&quot;, &quot;refresh_token&quot;: &quot;zAgClPAjmXvjs6VA_DaDjuvMj2Y&quot;, &quot;expires_in&quot;: 1799, &quot;scope&quot;: &quot;all&quot;} è¿™æ ·å°±å¯ä»¥é‡æ–°è®¿é—®èµ„æºäº†ã€‚","link":"/2022/08/24/05-%E7%AE%80%E6%98%93%E6%90%AD%E5%BB%BA%20Security%20OAuth2%20%E9%A1%B9%E7%9B%AE%E5%9F%BA%E4%BA%8E%20password%20%E6%A8%A1%E5%BC%8F/"},{"title":"","text":"title: Spring Security ä¸­ä½¿ç”¨ JWTcategories: spring-securitydate: â€˜2022-08-25 11:17:01â€™tags: spring-security åœ¨å‰åç«¯åˆ†ç¦»çš„é¡¹ç›®ä¸­ï¼Œç™»å½•ç­–ç•¥ä¹Ÿæœ‰ä¸å°‘ï¼Œä¸è¿‡ JWT ç®—æ˜¯ç›®å‰æ¯”è¾ƒæµè¡Œçš„ä¸€ç§è§£å†³æ–¹æ¡ˆ 1 æ— çŠ¶æ€ç™»å½•1.1 ä»€ä¹ˆæ˜¯æœ‰çŠ¶æ€ï¼Ÿæœ‰çŠ¶æ€æœåŠ¡ï¼Œå³æœåŠ¡ç«¯éœ€è¦è®°å½•æ¯æ¬¡ä¼šè¯çš„å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œä»è€Œè¯†åˆ«å®¢æˆ·ç«¯èº«ä»½ï¼Œæ ¹æ®ç”¨æˆ·èº«ä»½è¿›è¡Œè¯·æ±‚çš„å¤„ç†ï¼Œå…¸å‹çš„è®¾è®¡å¦‚Tomcatä¸­çš„Sessionã€‚ä¾‹å¦‚ç™»å½•ï¼šç”¨æˆ·ç™»å½•åï¼Œæˆ‘ä»¬æŠŠç”¨æˆ·çš„ä¿¡æ¯ä¿å­˜åœ¨æœåŠ¡ç«¯sessionä¸­ï¼Œå¹¶ä¸”ç»™ç”¨æˆ·ä¸€ä¸ªcookieå€¼ï¼Œè®°å½•å¯¹åº”çš„sessionï¼Œç„¶åä¸‹æ¬¡è¯·æ±‚ï¼Œç”¨æˆ·æºå¸¦cookieå€¼æ¥ï¼ˆè¿™ä¸€æ­¥æœ‰æµè§ˆå™¨è‡ªåŠ¨å®Œæˆï¼‰ï¼Œæˆ‘ä»¬å°±èƒ½è¯†åˆ«åˆ°å¯¹åº”sessionï¼Œä»è€Œæ‰¾åˆ°ç”¨æˆ·çš„ä¿¡æ¯ã€‚è¿™ç§æ–¹å¼ç›®å‰æ¥çœ‹æœ€æ–¹ä¾¿ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›ç¼ºé™·ï¼Œå¦‚ä¸‹ï¼š æœåŠ¡ç«¯ä¿å­˜å¤§é‡æ•°æ®ï¼Œå¢åŠ æœåŠ¡ç«¯å‹åŠ› æœåŠ¡ç«¯ä¿å­˜ç”¨æˆ·çŠ¶æ€ï¼Œä¸æ”¯æŒé›†ç¾¤åŒ–éƒ¨ç½² 1.2 ä»€ä¹ˆæ˜¯æ— çŠ¶æ€å¾®æœåŠ¡é›†ç¾¤ä¸­çš„æ¯ä¸ªæœåŠ¡ï¼Œå¯¹å¤–æä¾›çš„éƒ½ä½¿ç”¨RESTfulé£æ ¼çš„æ¥å£ã€‚è€ŒRESTfulé£æ ¼çš„ä¸€ä¸ªæœ€é‡è¦çš„è§„èŒƒå°±æ˜¯ï¼šæœåŠ¡çš„æ— çŠ¶æ€æ€§ï¼Œå³ï¼š æœåŠ¡ç«¯ä¸ä¿å­˜ä»»ä½•å®¢æˆ·ç«¯è¯·æ±‚è€…ä¿¡æ¯ å®¢æˆ·ç«¯çš„æ¯æ¬¡è¯·æ±‚å¿…é¡»å…·å¤‡è‡ªæè¿°ä¿¡æ¯ï¼Œé€šè¿‡è¿™äº›ä¿¡æ¯è¯†åˆ«å®¢æˆ·ç«¯èº«ä»½ é‚£ä¹ˆè¿™ç§æ— çŠ¶æ€æ€§æœ‰å“ªäº›å¥½å¤„å‘¢ï¼Ÿ å®¢æˆ·ç«¯è¯·æ±‚ä¸ä¾èµ–æœåŠ¡ç«¯çš„ä¿¡æ¯ï¼Œå¤šæ¬¡è¯·æ±‚ä¸éœ€è¦å¿…é¡»è®¿é—®åˆ°åŒä¸€å°æœåŠ¡å™¨ æœåŠ¡ç«¯çš„é›†ç¾¤å’ŒçŠ¶æ€å¯¹å®¢æˆ·ç«¯é€æ˜ æœåŠ¡ç«¯å¯ä»¥ä»»æ„çš„è¿ç§»å’Œä¼¸ç¼©ï¼ˆå¯ä»¥æ–¹ä¾¿çš„è¿›è¡Œé›†ç¾¤åŒ–éƒ¨ç½²ï¼‰ å‡å°æœåŠ¡ç«¯å­˜å‚¨å‹åŠ› 1.3.å¦‚ä½•å®ç°æ— çŠ¶æ€æ— çŠ¶æ€ç™»å½•çš„æµç¨‹ï¼š é¦–å…ˆå®¢æˆ·ç«¯å‘é€è´¦æˆ·å/å¯†ç åˆ°æœåŠ¡ç«¯è¿›è¡Œè®¤è¯ è®¤è¯é€šè¿‡åï¼ŒæœåŠ¡ç«¯å°†ç”¨æˆ·ä¿¡æ¯åŠ å¯†å¹¶ä¸”ç¼–ç æˆä¸€ä¸ªtokenï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ ä»¥åå®¢æˆ·ç«¯æ¯æ¬¡å‘é€è¯·æ±‚ï¼Œéƒ½éœ€è¦æºå¸¦è®¤è¯çš„token æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯å‘é€æ¥çš„tokenè¿›è¡Œè§£å¯†ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ•ˆï¼Œå¹¶ä¸”è·å–ç”¨æˆ·ç™»å½•ä¿¡æ¯ 1.4 JWT1.4.1 ç®€ä»‹JWTï¼Œå…¨ç§°æ˜¯Json Web Tokenï¼Œ æ˜¯ä¸€ç§JSONé£æ ¼çš„è½»é‡çº§çš„æˆæƒå’Œèº«ä»½è®¤è¯è§„èŒƒï¼Œå¯å®ç°æ— çŠ¶æ€ã€åˆ†å¸ƒå¼çš„Webåº”ç”¨æˆæƒï¼š JWT ä½œä¸ºä¸€ç§è§„èŒƒï¼Œå¹¶æ²¡æœ‰å’ŒæŸä¸€ç§è¯­è¨€ç»‘å®šåœ¨ä¸€èµ·ï¼Œå¸¸ç”¨çš„Java å®ç°æ˜¯GitHub ä¸Šçš„å¼€æºé¡¹ç›® jjwtï¼Œåœ°å€å¦‚ä¸‹ï¼šhttps://github.com/jwtk/jjwt 1.4.2 JWTæ•°æ®æ ¼å¼JWTåŒ…å«ä¸‰éƒ¨åˆ†æ•°æ®ï¼š Headerï¼šå¤´éƒ¨ï¼Œé€šå¸¸å¤´éƒ¨æœ‰ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼š å£°æ˜ç±»å‹ï¼Œè¿™é‡Œæ˜¯JWT åŠ å¯†ç®—æ³•ï¼Œè‡ªå®šä¹‰ æˆ‘ä»¬ä¼šå¯¹å¤´éƒ¨è¿›è¡ŒBase64Urlç¼–ç ï¼ˆå¯è§£ç ï¼‰ï¼Œå¾—åˆ°ç¬¬ä¸€éƒ¨åˆ†æ•°æ®ã€‚ Payloadï¼šè½½è·ï¼Œå°±æ˜¯æœ‰æ•ˆæ•°æ®ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­(RFC7519)ï¼Œè¿™é‡Œç»™äº†7ä¸ªç¤ºä¾‹ä¿¡æ¯ï¼š iss (issuer)ï¼šè¡¨ç¤ºç­¾å‘äºº exp (expiration time)ï¼šè¡¨ç¤ºtokenè¿‡æœŸæ—¶é—´ sub (subject)ï¼šä¸»é¢˜ aud (audience)ï¼šå—ä¼— nbf (Not Before)ï¼šç”Ÿæ•ˆæ—¶é—´ iat (Issued At)ï¼šç­¾å‘æ—¶é—´ jti (JWT ID)ï¼šç¼–å· è¿™éƒ¨åˆ†ä¹Ÿä¼šé‡‡ç”¨Base64Urlç¼–ç ï¼Œå¾—åˆ°ç¬¬äºŒéƒ¨åˆ†æ•°æ®ã€‚ Signatureï¼šç­¾åï¼Œæ˜¯æ•´ä¸ªæ•°æ®çš„è®¤è¯ä¿¡æ¯ã€‚ä¸€èˆ¬æ ¹æ®å‰ä¸¤æ­¥çš„æ•°æ®ï¼Œå†åŠ ä¸ŠæœåŠ¡çš„çš„å¯†é’¥secretï¼ˆå¯†é’¥ä¿å­˜åœ¨æœåŠ¡ç«¯ï¼Œä¸èƒ½æ³„éœ²ç»™å®¢æˆ·ç«¯ï¼‰ï¼Œé€šè¿‡Headerä¸­é…ç½®çš„åŠ å¯†ç®—æ³•ç”Ÿæˆã€‚ç”¨äºéªŒè¯æ•´ä¸ªæ•°æ®å®Œæ•´å’Œå¯é æ€§ã€‚ 1.4.3 JWTäº¤äº’æµç¨‹ åº”ç”¨ç¨‹åºæˆ–å®¢æˆ·ç«¯å‘æˆæƒæœåŠ¡å™¨è¯·æ±‚æˆæƒ è·å–åˆ°æˆæƒåï¼ŒæˆæƒæœåŠ¡å™¨ä¼šå‘åº”ç”¨ç¨‹åºè¿”å›è®¿é—®ä»¤ç‰Œ åº”ç”¨ç¨‹åºä½¿ç”¨è®¿é—®ä»¤ç‰Œæ¥è®¿é—®å—ä¿æŠ¤èµ„æºï¼ˆå¦‚APIï¼‰ å› ä¸ºJWTç­¾å‘çš„tokenä¸­å·²ç»åŒ…å«äº†ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œå¹¶ä¸”æ¯æ¬¡è¯·æ±‚éƒ½ä¼šæºå¸¦ï¼Œè¿™æ ·æœåŠ¡çš„å°±æ— éœ€ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œç”šè‡³æ— éœ€å»æ•°æ®åº“æŸ¥è¯¢ï¼Œè¿™æ ·å°±å®Œå…¨ç¬¦åˆäº†RESTfulçš„æ— çŠ¶æ€è§„èŒƒã€‚ 1.5 JWT å­˜åœ¨çš„é—®é¢˜è¯´äº†è¿™ä¹ˆå¤šï¼ŒJWT ä¹Ÿä¸æ˜¯å¤©è¡£æ— ç¼ï¼Œç”±å®¢æˆ·ç«¯ç»´æŠ¤ç™»å½•çŠ¶æ€å¸¦æ¥çš„ä¸€äº›é—®é¢˜åœ¨è¿™é‡Œä¾ç„¶å­˜åœ¨ï¼Œä¸¾ä¾‹å¦‚ä¸‹ï¼š ç»­ç­¾é—®é¢˜ï¼Œè¿™æ˜¯è¢«å¾ˆå¤šäººè¯Ÿç—…çš„é—®é¢˜ä¹‹ä¸€ï¼Œä¼ ç»Ÿçš„cookie+sessionçš„æ–¹æ¡ˆå¤©ç„¶çš„æ”¯æŒç»­ç­¾ï¼Œä½†æ˜¯jwtç”±äºæœåŠ¡ç«¯ä¸ä¿å­˜ç”¨æˆ·çŠ¶æ€ï¼Œå› æ­¤å¾ˆéš¾å®Œç¾è§£å†³ç»­ç­¾é—®é¢˜ï¼Œå¦‚æœå¼•å…¥redisï¼Œè™½ç„¶å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†æ˜¯jwtä¹Ÿå˜å¾—ä¸ä¼¦ä¸ç±»äº†ã€‚ æ³¨é”€é—®é¢˜ï¼Œç”±äºæœåŠ¡ç«¯ä¸å†ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œæ‰€ä»¥ä¸€èˆ¬å¯ä»¥é€šè¿‡ä¿®æ”¹secretæ¥å®ç°æ³¨é”€ï¼ŒæœåŠ¡ç«¯secretä¿®æ”¹åï¼Œå·²ç»é¢å‘çš„æœªè¿‡æœŸçš„tokenå°±ä¼šè®¤è¯å¤±è´¥ï¼Œè¿›è€Œå®ç°æ³¨é”€ï¼Œä¸è¿‡æ¯•ç«Ÿæ²¡æœ‰ä¼ ç»Ÿçš„æ³¨é”€æ–¹ä¾¿ã€‚ å¯†ç é‡ç½®ï¼Œå¯†ç é‡ç½®åï¼ŒåŸæœ¬çš„tokenä¾ç„¶å¯ä»¥è®¿é—®ç³»ç»Ÿï¼Œè¿™æ—¶å€™ä¹Ÿéœ€è¦å¼ºåˆ¶ä¿®æ”¹secretã€‚ åŸºäºç¬¬2ç‚¹å’Œç¬¬3ç‚¹ï¼Œä¸€èˆ¬å»ºè®®ä¸åŒç”¨æˆ·å–ä¸åŒsecretã€‚ 2 å®æˆ˜2.1 ç¯å¢ƒæ­å»ºé¦–å…ˆæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œåˆ›å»ºæ—¶éœ€è¦æ·»åŠ Spring Securityä¾èµ–ï¼Œåˆ›å»ºå®Œæˆåï¼Œæ·»åŠ  jjwt ä¾èµ–ï¼Œå®Œæ•´çš„pom.xmlæ–‡ä»¶å¦‚ä¸‹ï¼š 12345678910111213&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt; &lt;artifactId&gt;jjwt&lt;/artifactId&gt; &lt;version&gt;0.9.1&lt;/version&gt;&lt;/dependency&gt; ç„¶ååœ¨é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ªç®€å•çš„ User å¯¹è±¡å®ç° UserDetails æ¥å£ï¼Œå¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425public class User implements UserDetails { private String username; private String password; private List&lt;GrantedAuthority&gt; authorities; public String getUsername() { return username; } @Override public boolean isAccountNonExpired() { return true; } @Override public boolean isAccountNonLocked() { return true; } @Override public boolean isCredentialsNonExpired() { return true; } @Override public boolean isEnabled() { return true; } //çœç•¥getter/setter} è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬çš„ç”¨æˆ·å¯¹è±¡ï¼Œå…ˆæ”¾ç€å¤‡ç”¨ï¼Œå†åˆ›å»ºä¸€ä¸ªHelloControllerï¼Œå†…å®¹å¦‚ä¸‹ï¼š 1234567891011@RestControllerpublic class HelloController { @GetMapping(&quot;/hello&quot;) public String hello() { return &quot;hello jwt !&quot;; } @GetMapping(&quot;/admin&quot;) public String admin() { return &quot;hello admin !&quot;; }} HelloController å¾ˆç®€å•ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªæ¥å£ï¼Œè®¾è®¡æ˜¯ /hello æ¥å£å¯ä»¥è¢«å…·æœ‰ user è§’è‰²çš„ç”¨æˆ·è®¿é—®ï¼Œè€Œ /admin æ¥å£åˆ™å¯ä»¥è¢«å…·æœ‰ admin è§’è‰²çš„ç”¨æˆ·è®¿é—®ã€‚ 2.2 JWT è¿‡æ»¤å™¨é…ç½®æ¥ä¸‹æ¥æä¾›ä¸¤ä¸ªå’Œ JWT ç›¸å…³çš„è¿‡æ»¤å™¨é…ç½®ï¼š ä¸€ä¸ªæ˜¯ç”¨æˆ·ç™»å½•çš„è¿‡æ»¤å™¨ï¼Œåœ¨ç”¨æˆ·çš„ç™»å½•çš„è¿‡æ»¤å™¨ä¸­æ ¡éªŒç”¨æˆ·æ˜¯å¦ç™»å½•æˆåŠŸï¼Œå¦‚æœç™»å½•æˆåŠŸï¼Œåˆ™ç”Ÿæˆä¸€ä¸ªtokenè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œç™»å½•å¤±è´¥åˆ™ç»™å‰ç«¯ä¸€ä¸ªç™»å½•å¤±è´¥çš„æç¤ºã€‚ ç¬¬äºŒä¸ªè¿‡æ»¤å™¨åˆ™æ˜¯å½“å…¶ä»–è¯·æ±‚å‘é€æ¥ï¼Œæ ¡éªŒtokençš„è¿‡æ»¤å™¨ï¼Œå¦‚æœæ ¡éªŒæˆåŠŸï¼Œå°±è®©è¯·æ±‚ç»§ç»­æ‰§è¡Œã€‚ è¿™ä¸¤ä¸ªè¿‡æ»¤å™¨ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ï¼Œå…ˆçœ‹ç¬¬ä¸€ä¸ªï¼š 1234567891011121314151617181920212223242526272829303132333435363738public class JwtLoginFilter extends AbstractAuthenticationProcessingFilter { protected JwtLoginFilter(String defaultFilterProcessesUrl, AuthenticationManager authenticationManager) { super(new AntPathRequestMatcher(defaultFilterProcessesUrl)); setAuthenticationManager(authenticationManager); } @Override public Authentication attemptAuthentication(HttpServletRequest req, HttpServletResponse resp) throws AuthenticationException, IOException, ServletException { User user = new ObjectMapper().readValue(req.getInputStream(), User.class); return getAuthenticationManager().authenticate(new UsernamePasswordAuthenticationToken(user.getUsername(), user.getPassword())); } @Override protected void successfulAuthentication(HttpServletRequest req, HttpServletResponse resp, FilterChain chain, Authentication authResult) throws IOException, ServletException { Collection&lt;? extends GrantedAuthority&gt; authorities = authResult.getAuthorities(); StringBuffer as = new StringBuffer(); for (GrantedAuthority authority : authorities) { as.append(authority.getAuthority()) .append(&quot;,&quot;); } String jwt = Jwts.builder() .claim(&quot;authorities&quot;, as)//é…ç½®ç”¨æˆ·è§’è‰² .setSubject(authResult.getName()) .setExpiration(new Date(System.currentTimeMillis() + 10 * 60 * 1000)) .signWith(SignatureAlgorithm.HS512,&quot;sang@123&quot;) .compact(); resp.setContentType(&quot;application/json;charset=utf-8&quot;); PrintWriter out = resp.getWriter(); out.write(new ObjectMapper().writeValueAsString(jwt)); out.flush(); out.close(); } protected void unsuccessfulAuthentication(HttpServletRequest req, HttpServletResponse resp, AuthenticationException failed) throws IOException, ServletException { resp.setContentType(&quot;application/json;charset=utf-8&quot;); PrintWriter out = resp.getWriter(); out.write(&quot;ç™»å½•å¤±è´¥!&quot;); out.flush(); out.close(); }} å…³äºè¿™ä¸ªç±»ï¼Œæˆ‘è¯´å¦‚ä¸‹å‡ ç‚¹ï¼š è‡ªå®šä¹‰ JwtLoginFilter ç»§æ‰¿è‡ª AbstractAuthenticationProcessingFilterï¼Œå¹¶å®ç°å…¶ä¸­çš„ä¸‰ä¸ªé»˜è®¤æ–¹æ³•ã€‚ attemptAuthenticationæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä»ç™»å½•å‚æ•°ä¸­æå–å‡ºç”¨æˆ·åå¯†ç ï¼Œç„¶åè°ƒç”¨AuthenticationManager.authenticate()æ–¹æ³•å»è¿›è¡Œè‡ªåŠ¨æ ¡éªŒã€‚ ç¬¬äºŒæ­¥å¦‚æœæ ¡éªŒæˆåŠŸï¼Œå°±ä¼šæ¥åˆ°successfulAuthenticationå›è°ƒä¸­ï¼Œåœ¨successfulAuthenticationæ–¹æ³•ä¸­ï¼Œå°†ç”¨æˆ·è§’è‰²éå†ç„¶åç”¨ä¸€ä¸ª , è¿æ¥èµ·æ¥ï¼Œç„¶åå†åˆ©ç”¨Jwtså»ç”Ÿæˆtokenï¼ŒæŒ‰ç…§ä»£ç çš„é¡ºåºï¼Œç”Ÿæˆè¿‡ç¨‹ä¸€å…±é…ç½®äº†å››ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ç”¨æˆ·è§’è‰²ã€ä¸»é¢˜ã€è¿‡æœŸæ—¶é—´ä»¥åŠåŠ å¯†ç®—æ³•å’Œå¯†é’¥ï¼Œç„¶åå°†ç”Ÿæˆçš„tokenå†™å‡ºåˆ°å®¢æˆ·ç«¯ã€‚ ç¬¬äºŒæ­¥å¦‚æœæ ¡éªŒå¤±è´¥å°±ä¼šæ¥åˆ°unsuccessfulAuthenticationæ–¹æ³•ä¸­ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿”å›ä¸€ä¸ªé”™è¯¯æç¤ºç»™å®¢æˆ·ç«¯å³å¯ã€‚ å†æ¥çœ‹ç¬¬äºŒä¸ªtokenæ ¡éªŒçš„è¿‡æ»¤å™¨ï¼š 123456789101112131415public class JwtFilter extends GenericFilterBean { @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { HttpServletRequest req = (HttpServletRequest) servletRequest; String jwtToken = req.getHeader(&quot;authorization&quot;); System.out.println(jwtToken); Claims claims = Jwts.parser().setSigningKey(&quot;sang@123&quot;).parseClaimsJws(jwtToken.replace(&quot;Bearer&quot;,&quot;&quot;)) .getBody(); String username = claims.getSubject();//è·å–å½“å‰ç™»å½•ç”¨æˆ·å List&lt;GrantedAuthority&gt; authorities = AuthorityUtils.commaSeparatedStringToAuthorityList((String) claims.get(&quot;authorities&quot;)); UsernamePasswordAuthenticationToken token = new UsernamePasswordAuthenticationToken(username, null, authorities); SecurityContextHolder.getContext().setAuthentication(token); filterChain.doFilter(req,servletResponse); }} å…³äºè¿™ä¸ªè¿‡æ»¤å™¨ï¼Œæˆ‘è¯´å¦‚ä¸‹å‡ ç‚¹ï¼š é¦–å…ˆä»è¯·æ±‚å¤´ä¸­æå–å‡º authorization å­—æ®µï¼Œè¿™ä¸ªå­—æ®µå¯¹åº”çš„valueå°±æ˜¯ç”¨æˆ·çš„tokenã€‚ å°†æå–å‡ºæ¥çš„tokenå­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ªClaimså¯¹è±¡ï¼Œå†ä»Claimså¯¹è±¡ä¸­æå–å‡ºå½“å‰ç”¨æˆ·åå’Œç”¨æˆ·è§’è‰²ï¼Œåˆ›å»ºä¸€ä¸ªUsernamePasswordAuthenticationTokenæ”¾åˆ°å½“å‰çš„Contextä¸­ï¼Œç„¶åæ‰§è¡Œè¿‡æ»¤é“¾ä½¿è¯·æ±‚ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚ å¦‚æ­¤ä¹‹åï¼Œä¸¤ä¸ªå’ŒJWTç›¸å…³çš„è¿‡æ»¤å™¨å°±ç®—é…ç½®å¥½äº†ã€‚ 2.3 Spring Security é…ç½®æ¥ä¸‹æ¥æˆ‘ä»¬æ¥é…ç½® Spring Security,å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344package com.wenx.security.jwt.config;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.http.HttpMethod;import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;import org.springframework.security.config.annotation.web.builders.HttpSecurity;import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;import org.springframework.security.crypto.password.NoOpPasswordEncoder;import org.springframework.security.crypto.password.PasswordEncoder;import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;@Configuration@EnableWebSecuritypublic class SecurityConfig extends WebSecurityConfigurerAdapter { @Bean PasswordEncoder passwordEncoder() { return NoOpPasswordEncoder.getInstance(); } @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { auth.inMemoryAuthentication().withUser(&quot;admin&quot;) .password(&quot;123&quot;).roles(&quot;admin&quot;) .and() .withUser(&quot;user&quot;) .password(&quot;123&quot;) .roles(&quot;user&quot;); } @Override protected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .antMatchers(&quot;/hello&quot;).hasRole(&quot;user&quot;) .antMatchers(&quot;/admin&quot;).hasRole(&quot;admin&quot;) .antMatchers(HttpMethod.POST, &quot;/login&quot;).permitAll() .anyRequest().authenticated() .and() .addFilterBefore(new JwtLoginFilter(&quot;/login&quot;,authenticationManager()), UsernamePasswordAuthenticationFilter.class) .addFilterBefore(new JwtFilter(),UsernamePasswordAuthenticationFilter.class) .csrf().disable(); }} ç®€å•èµ·è§ï¼Œè¿™é‡Œæˆ‘å¹¶æœªå¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œå› æ­¤é…ç½®äº†NoOpPasswordEncoderçš„å®ä¾‹ã€‚ ç®€å•èµ·è§ï¼Œè¿™é‡Œå¹¶æœªè¿æ¥æ•°æ®åº“ï¼Œæˆ‘ç›´æ¥åœ¨å†…å­˜ä¸­é…ç½®äº†ä¸¤ä¸ªç”¨æˆ·ï¼Œä¸¤ä¸ªç”¨æˆ·å…·å¤‡ä¸åŒçš„è§’è‰²ã€‚ é…ç½®è·¯å¾„è§„åˆ™æ—¶ï¼Œ /hello æ¥å£å¿…é¡»è¦å…·å¤‡ user è§’è‰²æ‰èƒ½è®¿é—®ï¼Œ /admin æ¥å£å¿…é¡»è¦å…·å¤‡ admin è§’è‰²æ‰èƒ½è®¿é—®ï¼ŒPOST è¯·æ±‚å¹¶ä¸”æ˜¯ /login æ¥å£åˆ™å¯ä»¥ç›´æ¥é€šè¿‡ï¼Œå…¶ä»–æ¥å£å¿…é¡»è®¤è¯åæ‰èƒ½è®¿é—®ã€‚ æœ€åé…ç½®ä¸Šä¸¤ä¸ªè‡ªå®šä¹‰çš„è¿‡æ»¤å™¨å¹¶ä¸”å…³é—­æ‰csrfä¿æŠ¤ã€‚ 2.4 æµ‹è¯•åšå®Œè¿™äº›ä¹‹åï¼Œæˆ‘ä»¬çš„ç¯å¢ƒå°±ç®—å®Œå…¨æ­å»ºèµ·æ¥äº†ï¼Œæ¥ä¸‹æ¥å¯åŠ¨é¡¹ç›®ç„¶ååœ¨ POSTMAN ä¸­è¿›è¡Œæµ‹è¯• å‘é€ http://localhost:8080/login[POSTè¯·æ±‚] æºå¸¦å‚æ•°{&quot;username&quot;:&quot;user&quot;,&quot;password&quot;:&quot;123&quot;} ä¼šè¿”å› token ä¿¡æ¯ å‘é€è¯·æ±‚èµ„æºçš„è¯·æ±‚ï¼š http://localhost:8080/user/hello æºå¸¦è¯·æ±‚å¤´ï¼šAuthorization=Bearer XXX.XXX.XXX å¯ä»¥æˆåŠŸè·å–åˆ°èµ„æºã€‚","link":"/2022/11/21/07-%E7%AE%80%E6%98%93%E6%90%AD%E5%BB%BA%20Security%20%E5%9F%BA%E4%BA%8E%20JWT%20%E7%99%BB%E5%BD%95/"},{"title":"å‰åç«¯åˆ†ç¦»ä¸­ï¼Œä½¿ç”¨ JSONè¿›è¡Œç™»å½•","text":"æœåŠ¡ç«¯æ¥å£å®ç°é¦–å…ˆå¤§å®¶çŸ¥é“ï¼Œç”¨æˆ·ç™»å½•çš„ç”¨æˆ·å/å¯†ç æ˜¯åœ¨ UsernamePasswordAuthenticationFilter ç±»ä¸­å¤„ç†çš„ï¼Œå…·ä½“çš„å¤„ç†ä»£ç å¦‚ä¸‹ï¼š 123456789101112public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException { String username = obtainUsername(request); String password = obtainPassword(request); //çœç•¥}protected String obtainPassword(HttpServletRequest request) { return request.getParameter(passwordParameter);}protected String obtainUsername(HttpServletRequest request) { return request.getParameter(usernameParameter);} ä»è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºæ¥ä¸ºä»€ä¹ˆ Spring Security é»˜è®¤æ˜¯é€šè¿‡ key/value çš„å½¢å¼æ¥ä¼ é€’ç™»å½•å‚æ•°ï¼Œå› ä¸ºå®ƒå¤„ç†çš„æ–¹å¼å°±æ˜¯ request.getParameterã€‚ æ‰€ä»¥æˆ‘ä»¬è¦å®šä¹‰æˆ JSON çš„ï¼Œæ€è·¯å¾ˆç®€å•ï¼Œå°±æ˜¯è‡ªå®šä¹‰æ¥å®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ä»£æ›¿ UsernamePasswordAuthenticationFilter ï¼Œç„¶ååœ¨è·å–å‚æ•°çš„æ—¶å€™ï¼Œæ¢ä¸€ç§æ–¹å¼å°±è¡Œäº†ã€‚ è‡ªå®šä¹‰è¿‡æ»¤å™¨æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ä»£æ›¿ UsernamePasswordAuthenticationFilter ï¼Œå¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667package com.example.security.json.config;import com.fasterxml.jackson.databind.ObjectMapper;import org.apache.commons.logging.Log;import org.apache.commons.logging.LogFactory;import org.springframework.http.MediaType;import org.springframework.security.authentication.AuthenticationServiceException;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;import org.springframework.security.core.Authentication;import org.springframework.security.core.AuthenticationException;import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;import org.springframework.stereotype.Component;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import java.io.IOException;import java.util.HashMap;import java.util.Map;public class JsonFilter extends UsernamePasswordAuthenticationFilter { private static final Log log = LogFactory.getLog(JsonFilter.class); @Override public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException { if (!&quot;POST&quot;.equals(request.getMethod())) { throw new AuthenticationServiceException( &quot;Authentication method not supported: &quot; + request.getMethod()); } if (request.getContentType().equals(MediaType.APPLICATION_JSON_VALUE) || request.getContentType().equals(MediaType.APPLICATION_JSON_UTF8_VALUE)) { log.info(&quot;JSONç™»å½•&quot;); Map&lt;String, String&gt; loginData = new HashMap&lt;&gt;(); try { loginData = new ObjectMapper().readValue(request.getInputStream(), Map.class); } catch (IOException e) { } String username = loginData.get(getUsernameParameter()); String password = loginData.get(getPasswordParameter()); if (username == null) { username = &quot;&quot;; } if (password == null) { password = &quot;&quot;; } username = username.trim(); UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken( username, password); setDetails(request, authRequest); return this.getAuthenticationManager().authenticate(authRequest); } else { System.out.println(&quot;kvç™»å½•&quot;); return super.attemptAuthentication(request, response); } }} è¿™æ®µé€»è¾‘æˆ‘ä»¬åŸºæœ¬ä¸Šæ˜¯æ¨¡ä»¿å®˜æ–¹æä¾›çš„ UsernamePasswordAuthenticationFilter æ¥å†™çš„ï¼Œæˆ‘æ¥ç»™å¤§å®¶ç¨å¾®è§£é‡Šä¸‹ï¼š é¦–å…ˆç™»å½•è¯·æ±‚è‚¯å®šæ˜¯ POSTï¼Œå¦‚æœä¸æ˜¯ POST ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œåé¢çš„ä¹Ÿä¸å¤„ç†äº†ã€‚ å› ä¸ºè¦åœ¨è¿™é‡Œå¤„ç†éªŒè¯ç ï¼Œæ‰€ä»¥ç¬¬äºŒæ­¥ä» session ä¸­æŠŠå·²ç»ä¸‹å‘è¿‡çš„éªŒè¯ç çš„å€¼æ‹¿å‡ºæ¥ã€‚ æ¥ä¸‹æ¥é€šè¿‡ contentType æ¥åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦é€šè¿‡ JSON æ¥ä¼ é€’å‚æ•°ï¼Œå¦‚æœæ˜¯é€šè¿‡ JSON ä¼ é€’å‚æ•°ï¼Œåˆ™æŒ‰ç…§ JSON çš„æ–¹å¼è§£æï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è°ƒç”¨ super.attemptAuthentication æ–¹æ³•ï¼Œè¿›å…¥çˆ¶ç±»çš„å¤„ç†é€»è¾‘ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„è¿™ä¸ªç±»ï¼Œæ—¢æ”¯æŒ JSON å½¢å¼ä¼ é€’å‚æ•°ï¼Œä¹Ÿæ”¯æŒ key/value å½¢å¼ä¼ é€’å‚æ•°ã€‚ å¦‚æœæ˜¯ JSON å½¢å¼çš„æ•°æ®ï¼Œæˆ‘ä»¬å°±é€šè¿‡è¯»å– request ä¸­çš„ I/O æµï¼Œå°† JSON æ˜ å°„åˆ°ä¸€ä¸ª Map ä¸Šã€‚ æ¥ä¸‹æ¥ä» Map ä¸­å–å‡º username å’Œ passwordï¼Œæ„é€  UsernamePasswordAuthenticationToken å¯¹è±¡å¹¶ä½œæ ¡éªŒ è¿‡æ»¤å™¨å®šä¹‰å®Œæˆåï¼Œæ¥ä¸‹æ¥ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ä»£æ›¿é»˜è®¤çš„ UsernamePasswordAuthenticationFilterï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ª JsonFilterçš„å®ä¾‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105package com.example.security.json.config;import com.fasterxml.jackson.databind.ObjectMapper;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.security.authentication.*;import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;import org.springframework.security.config.annotation.web.builders.HttpSecurity;import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;import org.springframework.security.core.Authentication;import org.springframework.security.core.AuthenticationException;import org.springframework.security.core.userdetails.User;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;import org.springframework.security.crypto.password.PasswordEncoder;import org.springframework.security.web.authentication.AuthenticationFailureHandler;import org.springframework.security.web.authentication.AuthenticationSuccessHandler;import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;import javax.servlet.ServletException;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import java.io.IOException;import java.io.PrintWriter;import java.util.HashMap;import java.util.Map;@Configuration@EnableWebSecuritypublic class SecurityConfig extends WebSecurityConfigurerAdapter { @Bean JsonFilter jsonFilter() throws Exception { JsonFilter loginFilter = new JsonFilter(); loginFilter.setAuthenticationSuccessHandler(new AuthenticationSuccessHandler() { @Override public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException { response.setContentType(&quot;application/json;charset=utf-8&quot;); PrintWriter out = response.getWriter(); Map&lt;String,Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;message&quot;,&quot;ç™»é™†æˆåŠŸ&quot;); map.put(&quot;data&quot;,authentication.getPrincipal());// map.put(&quot;data&quot;,principal); String s = new ObjectMapper().writeValueAsString(map); System.out.println(&quot;success=&gt;&quot;+s); out.write(s); out.flush(); out.close(); } }); loginFilter.setAuthenticationFailureHandler(new AuthenticationFailureHandler() { @Override public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException { response.setContentType(&quot;application/json;charset=utf-8&quot;); PrintWriter out = response.getWriter(); Map&lt;String,String&gt; map = new HashMap&lt;&gt;(); map.put(&quot;error&quot;,exception.getMessage()); if (exception instanceof LockedException) { map.put(&quot;message&quot;,&quot;è´¦æˆ·è¢«é”å®šï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;); } else if (exception instanceof CredentialsExpiredException) { map.put(&quot;message&quot;,&quot;å¯†ç è¿‡æœŸï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;); } else if (exception instanceof AccountExpiredException) { map.put(&quot;message&quot;,&quot;è´¦æˆ·è¿‡æœŸï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;); } else if (exception instanceof BadCredentialsException) { map.put(&quot;message&quot;,&quot;ç”¨æˆ·åæˆ–è€…å¯†ç è¾“å…¥é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜!&quot;); } out.write(new ObjectMapper().writeValueAsString(map)); out.flush(); out.close(); } }); loginFilter.setAuthenticationManager(authenticationManagerBean()); loginFilter.setFilterProcessesUrl(&quot;/doLogin&quot;); return loginFilter; } @Bean PasswordEncoder passwordEncoder(){ return new BCryptPasswordEncoder(); } @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { auth.inMemoryAuthentication() .withUser(&quot;user&quot;).password(passwordEncoder().encode(&quot;123&quot;)).roles(&quot;user&quot;) .and() .withUser(&quot;admin&quot;).password(&quot;123&quot;).roles(&quot;admin&quot;); } @Override protected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .antMatchers(&quot;/admin/**&quot;).hasRole(&quot;admin&quot;) .antMatchers(&quot;/user/**&quot;).hasRole(&quot;user&quot;) .anyRequest().authenticated() .and() .formLogin() .permitAll() .and() .csrf().disable(); http.addFilterAt(jsonFilter(), UsernamePasswordAuthenticationFilter.class); }} å½“æˆ‘ä»¬ä»£æ›¿äº† UsernamePasswordAuthenticationFilter ä¹‹åï¼ŒåŸæœ¬åœ¨ SecurityConfig#configure æ–¹æ³•ä¸­å…³äº form è¡¨å•çš„é…ç½®å°±ä¼šå¤±æ•ˆï¼Œé‚£äº›å¤±æ•ˆçš„å±æ€§ï¼Œéƒ½å¯ä»¥åœ¨é…ç½® LoginFilter å®ä¾‹çš„æ—¶å€™é…ç½®ã€‚ å¦å¤–è®°å¾—é…ç½®ä¸€ä¸ª AuthenticationManagerï¼Œæ ¹æ® WebSecurityConfigurerAdapter ä¸­æä¾›çš„é…ç½®å³å¯ã€‚ FilterProcessUrl åˆ™å¯ä»¥æ ¹æ®å®é™…æƒ…å†µé…ç½®ï¼Œå¦‚æœä¸é…ç½®ï¼Œé»˜è®¤çš„å°±æ˜¯ /loginã€‚ æœ€åï¼Œæˆ‘ä»¬ç”¨è‡ªå®šä¹‰çš„ JsonFilter å®ä¾‹ä»£æ›¿ UsernamePasswordAuthenticationFilterï¼Œå¦‚ä¸‹ï¼š 1234567@Overrideprotected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() ... //çœç•¥ http.addFilterAt(loginFilter(), UsernamePasswordAuthenticationFilter.class);} è°ƒç”¨ addFilterAt æ–¹æ³•å®Œæˆæ›¿æ¢æ“ä½œã€‚","link":"/2022/08/25/06-%E7%AE%80%E6%98%93%E6%90%AD%E5%BB%BA%20Security%20%E5%9F%BA%E4%BA%8E%20JSON%20%E7%99%BB%E5%BD%95/"},{"title":"Spring Boot + Spring Security å®ç°è‡ªåŠ¨ç™»å½•","text":"å®ç°è‡ªåŠ¨ç™»å½•åŠŸèƒ½è‡ªåŠ¨ç™»å½•æ˜¯æˆ‘ä»¬åœ¨è½¯ä»¶å¼€å‘æ—¶ä¸€ä¸ªéå¸¸å¸¸è§çš„åŠŸèƒ½ å¾ˆå¤šç½‘ç«™æˆ‘ä»¬åœ¨ç™»å½•çš„æ—¶å€™éƒ½ä¼šçœ‹åˆ°ç±»ä¼¼çš„é€‰é¡¹ï¼Œæ¯•ç«Ÿæ€»è®©ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå¯†ç æ˜¯ä¸€ä»¶å¾ˆéº»çƒ¦çš„äº‹ã€‚ è‡ªåŠ¨ç™»å½•åŠŸèƒ½å°±æ˜¯ï¼Œç”¨æˆ·åœ¨ç™»å½•æˆåŠŸåï¼Œåœ¨æŸä¸€æ®µæ—¶é—´å†…ï¼Œå¦‚æœç”¨æˆ·å…³é—­äº†æµè§ˆå™¨å¹¶é‡æ–°æ‰“å¼€ï¼Œæˆ–è€…æœåŠ¡å™¨é‡å¯äº†ï¼Œéƒ½ä¸éœ€è¦ç”¨æˆ·é‡æ–°ç™»å½•äº†ï¼Œç”¨æˆ·ä¾ç„¶å¯ä»¥ç›´æ¥è®¿é—®æ¥å£æ•°æ®ã€‚ å®ä¾‹ä»£ç é¦–å…ˆï¼Œè¦å®ç°è®°ä½æˆ‘è¿™ä¸ªåŠŸèƒ½ï¼Œå…¶å®åªéœ€è¦å…¶å®åªéœ€è¦åœ¨ Spring Security çš„é…ç½®ä¸­ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç å³å¯ï¼š 12345678910111213141516171819@Overrideprotected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .anyRequest().authenticated() .and() .formLogin() .permitAll() .and() .rememberMe() .and() .csrf().disable();}@Overrideprotected void configure(AuthenticationManagerBuilder auth) throws Exception { auth.inMemoryAuthentication() .withUser(&quot;user&quot;).password(passwordEncoder().encode(&quot;123&quot;)).roles(&quot;user&quot;) ;} å¤§å®¶çœ‹åˆ°ï¼Œè¿™é‡Œåªéœ€è¦æ·»åŠ ä¸€ä¸ª .rememberMe() å³å¯ï¼Œè‡ªåŠ¨ç™»å½•åŠŸèƒ½å°±æˆåŠŸæ·»åŠ è¿›æ¥äº†ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬éšæ„æ·»åŠ ä¸€ä¸ªæµ‹è¯•æ¥å£ï¼š 1234567@RestControllerpublic class HelloController { @GetMapping(&quot;/hello&quot;) public String hello() { return &quot;hello&quot;; }} é‡å¯é¡¹ç›®ï¼Œæˆ‘ä»¬è®¿é—® hello æ¥å£ï¼Œæ­¤æ—¶ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ è¿™ä¸ªæ—¶å€™å¤§å®¶å‘ç°ï¼Œé»˜è®¤çš„ç™»å½•é¡µé¢å¤šäº†ä¸€ä¸ªé€‰é¡¹ï¼Œå°±æ˜¯è®°ä½æˆ‘ã€‚æˆ‘ä»¬è¾“å…¥ç”¨æˆ·åå¯†ç ï¼Œå¹¶ä¸”å‹¾é€‰ä¸Šè®°ä½æˆ‘è¿™ä¸ªæ¡†ï¼Œç„¶åç‚¹å‡»ç™»å½•æŒ‰é’®æ‰§è¡Œç™»å½•æ“ä½œ å¯ä»¥çœ‹åˆ°ï¼Œç™»å½•æ•°æ®ä¸­ï¼Œé™¤äº† username å’Œ password ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª remember-meï¼Œä¹‹æ‰€ä»¥ç»™å¤§å®¶çœ‹è¿™ä¸ªï¼Œæ˜¯æƒ³å‘Šè¯‰å¤§å®¶ï¼Œå¦‚æœä½ ä½ éœ€è¦è‡ªå®šä¹‰ç™»å½•é¡µé¢ï¼ŒRememberMe è¿™ä¸ªé€‰é¡¹çš„ key è¯¥æ€ä¹ˆå†™ã€‚ ç™»å½•æˆåŠŸä¹‹åï¼Œå°±ä¼šè‡ªåŠ¨è·³è½¬åˆ° hello æ¥å£äº†ã€‚æˆ‘ä»¬æ³¨æ„ï¼Œç³»ç»Ÿè®¿é—® hello æ¥å£çš„æ—¶å€™ï¼Œæºå¸¦çš„ cookie æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…³é—­æµè§ˆå™¨ï¼Œå†é‡æ–°æ‰“å¼€æµè§ˆå™¨ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨å…³é—­å†é‡æ–°æ‰“å¼€ï¼Œå¦‚æœéœ€è¦å†æ¬¡è®¿é—® hello æ¥å£ï¼Œå°±éœ€è¦æˆ‘ä»¬é‡æ–°ç™»å½•äº†ã€‚ä½†æ˜¯æ­¤æ—¶ï¼Œæˆ‘ä»¬å†å»è®¿é—® hello æ¥å£ï¼Œå‘ç°ä¸ç”¨é‡æ–°ç™»å½•äº†ï¼Œç›´æ¥å°±èƒ½è®¿é—®åˆ°ï¼Œè¿™å°±è¯´æ˜æˆ‘ä»¬çš„ RememberMe é…ç½®ç”Ÿæ•ˆäº†ï¼ˆå³ä¸‹æ¬¡è‡ªåŠ¨ç™»å½•åŠŸèƒ½ç”Ÿæ•ˆäº†ï¼‰ åŸç†åˆ†ææŒ‰ç†è¯´ï¼Œæµè§ˆå™¨å…³é—­å†é‡æ–°æ‰“å¼€ï¼Œå°±è¦é‡æ–°ç™»å½•ï¼Œç°åœ¨ç«Ÿç„¶ä¸ç”¨ç­‰äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªåŠŸèƒ½åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ é¦–å…ˆæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ cookie ä¸­å¤šå‡ºæ¥çš„è¿™ä¸ª remember-meï¼Œè¿™ä¸ªå€¼ä¸€çœ‹å°±æ˜¯ä¸€ä¸ª Base64 è½¬ç åçš„å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç½‘ä¸Šçš„ä¸€äº›åœ¨çº¿å·¥å…·æ¥è§£ç ï¼Œå¯ä»¥è‡ªå·±ç®€å•å†™ä¸¤è¡Œä»£ç æ¥è§£ç ï¼š 12345@Testvoid contextLoads() throws UnsupportedEncodingException { String s = new String(Base64.getDecoder().decode(&quot;amF2YWJveToxNTg5MTA0MDU1MzczOjI1NzhmZmJjMjY0ODVjNTM0YTJlZjkyOWFjMmVmYzQ3&quot;), &quot;UTF-8&quot;); System.out.println(&quot;s = &quot; + s);} æ‰§è¡Œè¿™æ®µä»£ç ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š 1s = user:1589104055373:2578ffbc26485c534a2ef929ac2efc47 å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ®µ Base64 å­—ç¬¦ä¸²å®é™…ä¸Šç”¨ : éš”å¼€ï¼Œåˆ†æˆäº†ä¸‰éƒ¨åˆ†ï¼š ç¬¬ä¸€æ®µæ˜¯ç”¨æˆ·åï¼Œè¿™ä¸ªæ— éœ€è´¨ç–‘ã€‚ ç¬¬äºŒæ®µçœ‹èµ·æ¥æ˜¯ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œæˆ‘ä»¬é€šè¿‡åœ¨çº¿å·¥å…·æˆ–è€… Java ä»£ç è§£æåå‘ç°ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸¤å‘¨åçš„æ•°æ®ã€‚ ç¬¬ä¸‰æ®µ,è¿™æ˜¯ä½¿ç”¨ MD5 æ•£åˆ—å‡½æ•°ç®—å‡ºæ¥çš„å€¼ï¼Œä»–çš„æ˜æ–‡æ ¼å¼æ˜¯ username + &quot;:&quot; + tokenExpiryTime + &quot;:&quot; + password + &quot;:&quot; + keyï¼Œæœ€åçš„ key æ˜¯ä¸€ä¸ªæ•£åˆ—ç›å€¼ï¼Œå¯ä»¥ç”¨æ¥é˜²æ²»ä»¤ç‰Œè¢«ä¿®æ”¹ã€‚ äº†è§£åˆ° cookie ä¸­ remember-me çš„å«ä¹‰ä¹‹åï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯¹äºè®°ä½æˆ‘çš„ç™»å½•æµç¨‹ä¹Ÿå°±å¾ˆå®¹æ˜“çŒœåˆ°äº†äº†ã€‚ åœ¨æµè§ˆå™¨å…³é—­åï¼Œå¹¶é‡æ–°æ‰“å¼€ä¹‹åï¼Œç”¨æˆ·å†å»è®¿é—® hello æ¥å£ï¼Œæ­¤æ—¶ä¼šæºå¸¦ç€ cookie ä¸­çš„ remember-me åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡åˆ°æ‹¿åˆ°å€¼ä¹‹åï¼Œå¯ä»¥æ–¹ä¾¿çš„è®¡ç®—å‡ºç”¨æˆ·åå’Œè¿‡æœŸæ—¶é—´ï¼Œå†æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢åˆ°ç”¨æˆ·å¯†ç ï¼Œç„¶åé€šè¿‡ MD5 æ•£åˆ—å‡½æ•°è®¡ç®—å‡ºæ•£åˆ—å€¼ï¼Œå†å°†è®¡ç®—å‡ºçš„æ•£åˆ—å€¼å’Œæµè§ˆå™¨ä¼ é€’æ¥çš„æ•£åˆ—å€¼è¿›è¡Œå¯¹æ¯”ï¼Œå°±èƒ½ç¡®è®¤è¿™ä¸ªä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆã€‚ æµç¨‹å°±æ˜¯è¿™ä¹ˆä¸ªæµç¨‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡åˆ†ææºç æ¥éªŒè¯ä¸€ä¸‹è¿™ä¸ªæµç¨‹å¯¹ä¸å¯¹ã€‚ æºç åˆ†ææ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡æºç æ¥éªŒè¯ä¸€ä¸‹æˆ‘ä»¬ä¸Šé¢è¯´çš„å¯¹ä¸å¯¹ã€‚ è¿™é‡Œä¸»è¦ä»ä¸¤ä¸ªæ–¹é¢æ¥ä»‹ç»ï¼Œä¸€ä¸ªæ˜¯ remember-me è¿™ä¸ªä»¤ç‰Œç”Ÿæˆçš„è¿‡ç¨‹ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯å®ƒè§£æçš„è¿‡ç¨‹ã€‚ ç”Ÿæˆç”Ÿæˆçš„æ ¸å¿ƒå¤„ç†æ–¹æ³•åœ¨ï¼šTokenBasedRememberMeServices#onLoginSuccessï¼š 1234567891011121314151617181920212223@Overridepublic void onLoginSuccess(HttpServletRequest request, HttpServletResponse response, Authentication successfulAuthentication) { String username = retrieveUserName(successfulAuthentication); String password = retrievePassword(successfulAuthentication); if (!StringUtils.hasLength(password)) { UserDetails user = getUserDetailsService().loadUserByUsername(username); password = user.getPassword(); } int tokenLifetime = calculateLoginLifetime(request, successfulAuthentication); long expiryTime = System.currentTimeMillis(); expiryTime += 1000L * (tokenLifetime &lt; 0 ? TWO_WEEKS_S : tokenLifetime); String signatureValue = makeTokenSignature(expiryTime, username, password); setCookie(new String[] { username, Long.toString(expiryTime), signatureValue }, tokenLifetime, request, response);}protected String makeTokenSignature(long tokenExpiryTime, String username, String password) { String data = username + &quot;:&quot; + tokenExpiryTime + &quot;:&quot; + password + &quot;:&quot; + getKey(); MessageDigest digest; digest = MessageDigest.getInstance(&quot;MD5&quot;); return new String(Hex.encode(digest.digest(data.getBytes())));} è¿™æ®µæ–¹æ³•çš„é€»è¾‘å…¶å®å¾ˆå¥½ç†è§£ï¼š é¦–å…ˆä»ç™»å½•æˆåŠŸçš„ Authentication ä¸­æå–å‡ºç”¨æˆ·å/å¯†ç ã€‚ ç”±äºç™»å½•æˆåŠŸä¹‹åï¼Œå¯†ç å¯èƒ½è¢«æ“¦é™¤äº†ï¼Œæ‰€ä»¥ï¼Œå¦‚æœä¸€å¼€å§‹æ²¡æœ‰æ‹¿åˆ°å¯†ç ï¼Œå°±å†ä» UserDetailsService ä¸­é‡æ–°åŠ è½½ç”¨æˆ·å¹¶é‡æ–°è·å–å¯†ç ã€‚ å†æ¥ä¸‹æ¥å»è·å–ä»¤ç‰Œçš„æœ‰æ•ˆæœŸï¼Œä»¤ç‰Œæœ‰æ•ˆæœŸé»˜è®¤å°±æ˜¯ä¸¤å‘¨ã€‚ å†æ¥ä¸‹æ¥è°ƒç”¨ makeTokenSignature æ–¹æ³•å»è®¡ç®—æ•£åˆ—å€¼ï¼Œå®é™…ä¸Šå°±æ˜¯æ ¹æ® usernameã€ä»¤ç‰Œæœ‰æ•ˆæœŸä»¥åŠ passwordã€key ä¸€èµ·è®¡ç®—ä¸€ä¸ªæ•£åˆ—å€¼ã€‚å¦‚æœæˆ‘ä»¬æ²¡æœ‰è‡ªå·±å»è®¾ç½®è¿™ä¸ª keyï¼Œé»˜è®¤æ˜¯åœ¨ RememberMeConfigurer#getKey æ–¹æ³•ä¸­è¿›è¡Œè®¾ç½®çš„ï¼Œå®ƒçš„å€¼æ˜¯ä¸€ä¸ª UUID å­—ç¬¦ä¸²ã€‚ æœ€åï¼Œå°†ç”¨æˆ·åã€ä»¤ç‰Œæœ‰æ•ˆæœŸä»¥åŠè®¡ç®—å¾—åˆ°çš„æ•£åˆ—å€¼æ”¾å…¥ Cookie ä¸­ã€‚ ç”±äºæˆ‘ä»¬è‡ªå·±æ²¡æœ‰è®¾ç½® keyï¼Œkey é»˜è®¤å€¼æ˜¯ä¸€ä¸ª UUID å­—ç¬¦ä¸²ï¼Œè¿™æ ·ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœæœåŠ¡ç«¯é‡å¯ï¼Œè¿™ä¸ª key ä¼šå˜ï¼Œè¿™æ ·å°±å¯¼è‡´ä¹‹å‰æ´¾å‘å‡ºå»çš„æ‰€æœ‰ remember-me è‡ªåŠ¨ç™»å½•ä»¤ç‰Œå¤±æ•ˆï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šè¿™ä¸ª keyã€‚æŒ‡å®šæ–¹å¼å¦‚ä¸‹ï¼š 123456789101112@Overrideprotected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .anyRequest().authenticated() .and() .formLogin() .and() .rememberMe() .key(&quot;javaboy&quot;) .and() .csrf().disable();} å¦‚æœè‡ªå·±é…ç½®äº† keyï¼Œå³ä½¿æœåŠ¡ç«¯é‡å¯ï¼Œå³ä½¿æµè§ˆå™¨æ‰“å¼€å†å…³é—­ï¼Œä¹Ÿä¾ç„¶èƒ½å¤Ÿè®¿é—®åˆ° hello æ¥å£ã€‚ è¿™æ˜¯ remember-me ä»¤ç‰Œç”Ÿæˆçš„è¿‡ç¨‹ã€‚ AbstractAuthenticationProcessingFilter#doFilter -&gt; AbstractAuthenticationProcessingFilter#successfulAuthentication -&gt; AbstractRememberMeServices#loginSuccess -&gt; TokenBasedRememberMeServices#onLoginSuccessã€‚ è§£æé‚£ä¹ˆå½“ç”¨æˆ·å…³æ‰å¹¶æ‰“å¼€æµè§ˆå™¨ä¹‹åï¼Œé‡æ–°è®¿é—® /hello æ¥å£ï¼Œæ­¤æ—¶çš„è®¤è¯æµç¨‹åˆæ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼ŒSpring Security ä¸­çš„ä¸€ç³»åˆ—åŠŸèƒ½éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªè¿‡æ»¤å™¨é“¾å®ç°çš„ï¼ŒRememberMe è¿™ä¸ªåŠŸèƒ½å½“ç„¶ä¹Ÿä¸ä¾‹å¤–ã€‚ Spring Security ä¸­æä¾›äº† RememberMeAuthenticationFilter ç±»ä¸“é—¨ç”¨æ¥åšç›¸å…³çš„äº‹æƒ…ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ RememberMeAuthenticationFilter çš„ doFilter æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException { HttpServletRequest request = (HttpServletRequest) req; HttpServletResponse response = (HttpServletResponse) res; if (SecurityContextHolder.getContext().getAuthentication() == null) { Authentication rememberMeAuth = rememberMeServices.autoLogin(request, response); if (rememberMeAuth != null) { rememberMeAuth = authenticationManager.authenticate(rememberMeAuth); SecurityContextHolder.getContext().setAuthentication(rememberMeAuth); onSuccessfulAuthentication(request, response, rememberMeAuth); if (this.eventPublisher != null) { eventPublisher .publishEvent(new InteractiveAuthenticationSuccessEvent( SecurityContextHolder.getContext() .getAuthentication(), this.getClass())); } if (successHandler != null) { successHandler.onAuthenticationSuccess(request, response, rememberMeAuth); return; } } chain.doFilter(request, response); } else { chain.doFilter(request, response); }} å¯ä»¥çœ‹åˆ°ï¼Œå°±æ˜¯åœ¨è¿™é‡Œå®ç°çš„ã€‚ è¿™ä¸ªæ–¹æ³•æœ€å…³é”®çš„åœ°æ–¹åœ¨äºï¼Œå¦‚æœä» SecurityContextHolder ä¸­æ— æ³•è·å–åˆ°å½“å‰ç™»å½•ç”¨æˆ·å®ä¾‹ï¼Œé‚£ä¹ˆå°±è°ƒç”¨ rememberMeServices.autoLogin é€»è¾‘è¿›è¡Œç™»å½•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627public final Authentication autoLogin(HttpServletRequest request, HttpServletResponse response) { String rememberMeCookie = extractRememberMeCookie(request); if (rememberMeCookie == null) { return null; } logger.debug(&quot;Remember-me cookie detected&quot;); if (rememberMeCookie.length() == 0) { logger.debug(&quot;Cookie was empty&quot;); cancelCookie(request, response); return null; } UserDetails user = null; try { String[] cookieTokens = decodeCookie(rememberMeCookie); user = processAutoLoginCookie(cookieTokens, request, response); userDetailsChecker.check(user); logger.debug(&quot;Remember-me cookie accepted&quot;); return createSuccessfulAuthentication(request, user); } catch (CookieTheftException cte) { throw cte; } cancelCookie(request, response); return null;} å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå°±æ˜¯æå–å‡º cookie ä¿¡æ¯ï¼Œå¹¶å¯¹ cookie ä¿¡æ¯è¿›è¡Œè§£ç ï¼Œè§£ç ä¹‹åï¼Œå†è°ƒç”¨ processAutoLoginCookie æ–¹æ³•å»åšæ ¡éªŒï¼ŒprocessAutoLoginCookie æ–¹æ³•çš„ä»£ç æˆ‘å°±ä¸è´´äº†ï¼Œæ ¸å¿ƒæµç¨‹å°±æ˜¯é¦–å…ˆè·å–ç”¨æˆ·åå’Œè¿‡æœŸæ—¶é—´ï¼Œå†æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢åˆ°ç”¨æˆ·å¯†ç ï¼Œç„¶åé€šè¿‡ MD5 æ•£åˆ—å‡½æ•°è®¡ç®—å‡ºæ•£åˆ—å€¼ï¼Œå†å°†æ‹¿åˆ°çš„æ•£åˆ—å€¼å’Œæµè§ˆå™¨ä¼ é€’æ¥çš„æ•£åˆ—å€¼è¿›è¡Œå¯¹æ¯”ï¼Œå°±èƒ½ç¡®è®¤è¿™ä¸ªä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆï¼Œè¿›è€Œç¡®è®¤ç™»å½•æ˜¯å¦æœ‰æ•ˆã€‚ æ€»ç»“çœ‹äº†ä¸Šé¢çš„æ–‡ç« ï¼Œå¤§å®¶å¯èƒ½å·²ç»å‘ç°ï¼Œå¦‚æœæˆ‘ä»¬å¼€å¯äº† RememberMe åŠŸèƒ½ï¼Œæœ€æœ€æ ¸å¿ƒçš„ä¸œè¥¿å°±æ˜¯æ”¾åœ¨ cookie ä¸­çš„ä»¤ç‰Œäº†ï¼Œè¿™ä¸ªä»¤ç‰Œçªç ´äº† session çš„é™åˆ¶ï¼Œå³ä½¿æœåŠ¡å™¨é‡å¯ã€å³ä½¿æµè§ˆå™¨å…³é—­åˆé‡æ–°æ‰“å¼€ï¼Œåªè¦è¿™ä¸ªä»¤ç‰Œæ²¡æœ‰è¿‡æœŸï¼Œå°±èƒ½è®¿é—®åˆ°æ•°æ®ã€‚ ä¸€æ—¦ä»¤ç‰Œä¸¢å¤±ï¼Œåˆ«äººå°±å¯ä»¥æ‹¿ç€è¿™ä¸ªä»¤ç‰Œéšæ„ç™»å½•æˆ‘ä»¬çš„ç³»ç»Ÿäº†ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å±é™©çš„æ“ä½œã€‚ ä½†æ˜¯å®é™…ä¸Šè¿™æ˜¯ä¸€æ®µæ‚–è®ºï¼Œä¸ºäº†æé«˜ç”¨æˆ·ä½“éªŒï¼ˆå°‘ç™»å½•ï¼‰ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿä¸å¯é¿å…çš„å¼•å‡ºäº†ä¸€äº›å®‰å…¨é—®é¢˜ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡æŠ€æœ¯å°†å®‰å…¨é£é™©é™ä½åˆ°æœ€å°ã€‚ RememberMe æŒä¹…åŒ–æ–¹æ¡ˆåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬è‚¯å®šè¦æŠŠè¿™äº›å®‰å…¨é£é™©é™åˆ°æœ€ä½ã€‚é™ä½å®‰å…¨é£é™©ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªæ–¹é¢ï¼š æŒä¹…åŒ–æ–¹æ¡ˆ äºŒæ¬¡æ ¡éªŒ æŒä¹…åŒ–ä»¤ç‰ŒåŸç†è¦ç†è§£æŒä¹…åŒ–ä»¤ç‰Œï¼Œä¸€å®šè¦å…ˆææ˜ç™½è‡ªåŠ¨ç™»å½•çš„åŸºæœ¬ç©æ³• æŒä¹…åŒ–ä»¤ç‰Œå°±æ˜¯åœ¨åŸºæœ¬çš„è‡ªåŠ¨ç™»å½•åŠŸèƒ½åŸºç¡€ä¸Šï¼Œåˆå¢åŠ äº†æ–°çš„æ ¡éªŒå‚æ•°ï¼Œæ¥æé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œè¿™ä¸€äº›éƒ½æ˜¯ç”±å¼€å‘è€…åœ¨åå°å®Œæˆçš„ï¼Œå¯¹äºç”¨æˆ·æ¥è¯´ï¼Œç™»å½•ä½“éªŒå’Œæ™®é€šçš„è‡ªåŠ¨ç™»å½•ä½“éªŒæ˜¯ä¸€æ ·çš„ã€‚ åœ¨æŒä¹…åŒ–ä»¤ç‰Œä¸­ï¼Œæ–°å¢äº†ä¸¤ä¸ªç»è¿‡ MD5 æ•£åˆ—å‡½æ•°è®¡ç®—çš„æ ¡éªŒå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ seriesï¼Œå¦ä¸€ä¸ªæ˜¯ tokenã€‚å…¶ä¸­ï¼Œseries åªæœ‰å½“ç”¨æˆ·åœ¨ä½¿ç”¨ç”¨æˆ·å/å¯†ç ç™»å½•æ—¶ï¼Œæ‰ä¼šç”Ÿæˆæˆ–è€…æ›´æ–°ï¼Œè€Œ token åªè¦æœ‰æ–°çš„ä¼šè¯ï¼Œå°±ä¼šé‡æ–°ç”Ÿæˆï¼Œè¿™æ ·å°±å¯ä»¥é¿å…ä¸€ä¸ªç”¨æˆ·åŒæ—¶åœ¨å¤šç«¯ç™»å½•ï¼Œå°±åƒæ‰‹æœº QQ ï¼Œä¸€ä¸ªæ‰‹æœºä¸Šç™»å½•äº†ï¼Œå°±ä¼šè¸¢æ‰å¦å¤–ä¸€ä¸ªæ‰‹æœºçš„ç™»å½•ï¼Œè¿™æ ·ç”¨æˆ·å°±ä¼šå¾ˆå®¹æ˜“å‘ç°è´¦æˆ·æ˜¯å¦æ³„æ¼ æŒä¹…åŒ–ä»¤ç‰Œçš„å…·ä½“å¤„ç†ç±»åœ¨ PersistentTokenBasedRememberMeServices ä¸­ï¼Œè‡ªåŠ¨åŒ–ç™»å½•å…·ä½“çš„å¤„ç†ç±»æ˜¯åœ¨ TokenBasedRememberMeServices ä¸­ï¼Œå®ƒä»¬æœ‰ä¸€ä¸ªå…±åŒçš„çˆ¶ç±» è€Œç”¨æ¥ä¿å­˜ä»¤ç‰Œçš„å¤„ç†ç±»åˆ™æ˜¯ PersistentRememberMeTokenï¼Œè¯¥ç±»çš„å®šä¹‰ä¹Ÿå¾ˆç®€æ´å‘½ä»¤ï¼š 1234567public class PersistentRememberMeToken { private final String username; private final String series; private final String tokenValue; private final Date date; //çœç•¥ getter} è¿™é‡Œçš„ Date è¡¨ç¤ºä¸Šä¸€æ¬¡ä½¿ç”¨è‡ªåŠ¨ç™»å½•çš„æ—¶é—´ã€‚ ä»£ç å®ä¾‹é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€å¼ è¡¨æ¥è®°å½•ä»¤ç‰Œä¿¡æ¯ï¼Œè¿™å¼ è¡¨æˆ‘ä»¬å¯ä»¥å®Œå…¨è‡ªå®šä¹‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç³»ç»Ÿé»˜è®¤æä¾›çš„ JDBC æ¥æ“ä½œï¼Œå¦‚æœä½¿ç”¨é»˜è®¤çš„ JDBCï¼Œå³ JdbcTokenRepositoryImplï¼Œæˆ‘ä»¬å¯ä»¥æ¥åˆ†æä¸€ä¸‹è¯¥ç±»çš„å®šä¹‰ï¼š 123456789public class JdbcTokenRepositoryImpl extends JdbcDaoSupport implements PersistentTokenRepository { public static final String CREATE_TABLE_SQL = &quot;create table persistent_logins (username varchar(64) not null, series varchar(64) primary key, &quot; + &quot;token varchar(64) not null, last_used timestamp not null)&quot;; public static final String DEF_TOKEN_BY_SERIES_SQL = &quot;select username,series,token,last_used from persistent_logins where series = ?&quot;; public static final String DEF_INSERT_TOKEN_SQL = &quot;insert into persistent_logins (username, series, token, last_used) values(?,?,?,?)&quot;; public static final String DEF_UPDATE_TOKEN_SQL = &quot;update persistent_logins set token = ?, last_used = ? where series = ?&quot;; public static final String DEF_REMOVE_USER_TOKENS_SQL = &quot;delete from persistent_logins where username = ?&quot;;} æ ¹æ®è¿™æ®µ SQL å®šä¹‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ†æå‡ºæ¥è¡¨çš„ç»“æ„ 1234567CREATE TABLE `persistent_logins` ( `username` varchar(64) COLLATE utf8mb4_unicode_ci NOT NULL, `series` varchar(64) COLLATE utf8mb4_unicode_ci NOT NULL, `token` varchar(64) COLLATE utf8mb4_unicode_ci NOT NULL, `last_used` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (`series`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci; é¦–å…ˆæˆ‘ä»¬åœ¨æ•°æ®åº“ä¸­å‡†å¤‡å¥½è¿™å¼ è¡¨ã€‚ æ—¢ç„¶è¦è¿æ¥æ•°æ®åº“ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å‡†å¤‡ jdbc å’Œ mysql ä¾èµ–ï¼Œå¦‚ä¸‹ï¼š 12345678&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;&lt;/dependency&gt; ç„¶åä¿®æ”¹ application.properties ï¼Œé…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼š 123spring.datasource.url=jdbc:mysql:///oauth2?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghaispring.datasource.username=rootspring.datasource.password=123 æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¿®æ”¹ SecurityConfigï¼Œå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223@AutowiredDataSource dataSource;@BeanJdbcTokenRepositoryImpl jdbcTokenRepository() { JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl(); jdbcTokenRepository.setDataSource(dataSource); return jdbcTokenRepository;}@Overrideprotected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .anyRequest().authenticated() .and() .formLogin() .and() .rememberMe() .key(&quot;wenx&quot;) .tokenRepository(jdbcTokenRepository()) .and() .csrf().disable();} æä¾›ä¸€ä¸ª JdbcTokenRepositoryImpl å®ä¾‹ï¼Œå¹¶ç»™å…¶é…ç½® DataSource æ•°æ®æºï¼Œæœ€åé€šè¿‡ tokenRepository å°† JdbcTokenRepositoryImpl å®ä¾‹çº³å…¥é…ç½®ä¸­ã€‚ OKï¼Œåšå®Œè¿™ä¸€åˆ‡ï¼Œæˆ‘ä»¬å°±å¯ä»¥æµ‹è¯•äº†ã€‚ æµ‹è¯•æˆ‘ä»¬è¿˜æ˜¯å…ˆå»è®¿é—® /hello æ¥å£ï¼Œæ­¤æ—¶ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œç„¶åæˆ‘ä»¬æ‰§è¡Œç™»å½•æ“ä½œï¼Œè®°å¾—å‹¾é€‰ä¸Šâ€œè®°ä½æˆ‘â€è¿™ä¸ªé€‰é¡¹ï¼Œç™»å½•æˆåŠŸåï¼Œæˆ‘ä»¬å¯ä»¥é‡å¯æœåŠ¡å™¨ã€ç„¶åå…³é—­æµè§ˆå™¨å†æ‰“å¼€ï¼Œå†å»è®¿é—® /hello æ¥å£ï¼Œå‘ç°ä¾ç„¶èƒ½å¤Ÿè®¿é—®åˆ°ï¼Œè¯´æ˜æˆ‘ä»¬çš„æŒä¹…åŒ–ä»¤ç‰Œé…ç½®å·²ç»ç”Ÿæ•ˆã€‚ ä»¤ç‰Œç»è¿‡è§£æä¹‹åï¼Œæ ¼å¼å¦‚ä¸‹ï¼š 1emhqATk3ZDBdR8862WP4Ig%3D%3D:ZAEv6EIWqA7CkGbYewCh8g%3D%3D è¿™å…¶ä¸­ï¼Œ%3D è¡¨ç¤º =ï¼Œæ‰€ä»¥ä¸Šé¢çš„å­—ç¬¦å®é™…ä¸Šå¯ä»¥ç¿»è¯‘æˆä¸‹é¢è¿™æ ·ï¼š 1emhqATk3ZDBdR8862WP4Ig==:ZAEv6EIWqA7CkGbYewCh8g== æ­¤æ—¶ï¼ŒæŸ¥çœ‹æ•°æ®åº“ï¼Œæˆ‘ä»¬å‘ç°ä¹‹å‰çš„è¡¨ä¸­ç”Ÿæˆäº†ä¸€æ¡è®°å½• æ•°æ®åº“ä¸­çš„è®°å½•å’Œæˆ‘ä»¬çœ‹åˆ°çš„ remember-me ä»¤ç‰Œè§£æåæ˜¯ä¸€è‡´çš„ã€‚ æºç åˆ†æè¿™æ¬¡çš„å®ç°ç±»ä¸»è¦æ˜¯ï¼šPersistentTokenBasedRememberMeServicesï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹é‡Œè¾¹å‡ ä¸ªå’Œä»¤ç‰Œç”Ÿæˆç›¸å…³çš„æ–¹æ³•ï¼š 1234567891011121314151617181920212223protected void onLoginSuccess(HttpServletRequest request, HttpServletResponse response, Authentication successfulAuthentication) { String username = successfulAuthentication.getName(); PersistentRememberMeToken persistentToken = new PersistentRememberMeToken( username, generateSeriesData(), generateTokenData(), new Date()); tokenRepository.createNewToken(persistentToken); addCookie(persistentToken, request, response);}protected String generateSeriesData() { byte[] newSeries = new byte[seriesLength]; random.nextBytes(newSeries); return new String(Base64.getEncoder().encode(newSeries));}protected String generateTokenData() { byte[] newToken = new byte[tokenLength]; random.nextBytes(newToken); return new String(Base64.getEncoder().encode(newToken));}private void addCookie(PersistentRememberMeToken token, HttpServletRequest request, HttpServletResponse response) { setCookie(new String[] { token.getSeries(), token.getTokenValue() }, getTokenValiditySeconds(), request, response);} å¯ä»¥çœ‹åˆ°ï¼š åœ¨ç™»å½•æˆåŠŸåï¼Œé¦–å…ˆè¿˜æ˜¯è·å–åˆ°ç”¨æˆ·åï¼Œå³ usernameã€‚ æ¥ä¸‹æ¥æ„é€ ä¸€ä¸ª PersistentRememberMeToken å®ä¾‹ï¼ŒgenerateSeriesData å’Œ generateTokenData æ–¹æ³•åˆ†åˆ«ç”¨æ¥è·å– series å’Œ tokenï¼Œå…·ä½“çš„ç”Ÿæˆè¿‡ç¨‹å®é™…ä¸Šå°±æ˜¯è°ƒç”¨ SecureRandom ç”Ÿæˆéšæœºæ•°å†è¿›è¡Œ Base64 ç¼–ç ï¼Œä¸åŒäºæˆ‘ä»¬ä»¥å‰ç”¨çš„ Math.random æˆ–è€… java.util.Random è¿™ç§ä¼ªéšæœºæ•°ï¼ŒSecureRandom åˆ™é‡‡ç”¨çš„æ˜¯ç±»ä¼¼äºå¯†ç å­¦çš„éšæœºæ•°ç”Ÿæˆè§„åˆ™ï¼Œå…¶è¾“å‡ºç»“æœè¾ƒéš¾é¢„æµ‹ï¼Œé€‚åˆåœ¨ç™»å½•è¿™æ ·çš„åœºæ™¯ä¸‹ä½¿ç”¨ã€‚ è°ƒç”¨ tokenRepository å®ä¾‹ä¸­çš„ createNewToken æ–¹æ³•ï¼ŒtokenRepository å®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹é…ç½®çš„ JdbcTokenRepositoryImplï¼Œæ‰€ä»¥è¿™è¡Œä»£ç å®é™…ä¸Šå°±æ˜¯å°† PersistentRememberMeToken å­˜å…¥æ•°æ®åº“ä¸­ã€‚ æœ€å addCookieï¼Œå¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œå°±æ˜¯æ·»åŠ äº† series å’Œ tokenã€‚ è¿™æ˜¯ä»¤ç‰Œç”Ÿæˆçš„è¿‡ç¨‹ï¼Œè¿˜æœ‰ä»¤ç‰Œæ ¡éªŒçš„è¿‡ç¨‹ï¼Œä¹Ÿåœ¨è¯¥ç±»ä¸­ï¼Œæ–¹æ³•æ˜¯ï¼šprocessAutoLoginCookieï¼š 123456789101112131415161718192021222324protected UserDetails processAutoLoginCookie(String[] cookieTokens, HttpServletRequest request, HttpServletResponse response) { final String presentedSeries = cookieTokens[0]; final String presentedToken = cookieTokens[1]; PersistentRememberMeToken token = tokenRepository .getTokenForSeries(presentedSeries); if (!presentedToken.equals(token.getTokenValue())) { tokenRepository.removeUserTokens(token.getUsername()); throw new CookieTheftException( messages.getMessage( &quot;PersistentTokenBasedRememberMeServices.cookieStolen&quot;, &quot;Invalid remember-me token (Series/token) mismatch. Implies previous cookie theft attack.&quot;)); } if (token.getDate().getTime() + getTokenValiditySeconds() * 1000L &lt; System .currentTimeMillis()) { throw new RememberMeAuthenticationException(&quot;Remember-me login has expired&quot;); } PersistentRememberMeToken newToken = new PersistentRememberMeToken( token.getUsername(), token.getSeries(), generateTokenData(), new Date()); tokenRepository.updateToken(newToken.getSeries(), newToken.getTokenValue(), newToken.getDate()); addCookie(newToken, request, response); return getUserDetailsService().loadUserByUsername(token.getUsername());} è¿™æ®µé€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼š é¦–å…ˆä»å‰ç«¯ä¼ æ¥çš„ cookie ä¸­è§£æå‡º series å’Œ tokenã€‚ æ ¹æ® series ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºä¸€ä¸ª PersistentRememberMeToken å®ä¾‹ã€‚ å¦‚æœæŸ¥å‡ºæ¥çš„ token å’Œå‰ç«¯ä¼ æ¥çš„ token ä¸ç›¸åŒï¼Œè¯´æ˜è´¦å·å¯èƒ½è¢«äººç›—ç”¨ï¼ˆåˆ«äººç”¨ä½ çš„ä»¤ç‰Œç™»å½•ä¹‹åï¼Œtoken ä¼šå˜ï¼‰ã€‚æ­¤æ—¶æ ¹æ®ç”¨æˆ·åç§»é™¤ç›¸å…³çš„ tokenï¼Œç›¸å½“äºå¿…é¡»è¦é‡æ–°è¾“å…¥ç”¨æˆ·åå¯†ç ç™»å½•æ‰èƒ½è·å–æ–°çš„è‡ªåŠ¨ç™»å½•æƒé™ã€‚ æ¥ä¸‹æ¥æ ¡éªŒ token æ˜¯å¦è¿‡æœŸã€‚ æ„é€ æ–°çš„ PersistentRememberMeToken å¯¹è±¡ï¼Œå¹¶ä¸”æ›´æ–°æ•°æ®åº“ä¸­çš„ tokenï¼ˆè¿™å°±æ˜¯æˆ‘ä»¬æ–‡ç« å¼€å¤´è¯´çš„ï¼Œæ–°çš„ä¼šè¯éƒ½ä¼šå¯¹åº”ä¸€ä¸ªæ–°çš„ tokenï¼‰ã€‚ å°†æ–°çš„ä»¤ç‰Œé‡æ–°æ·»åŠ åˆ° cookie ä¸­è¿”å›ã€‚ æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå†èµ°ä¸€æ³¢ç™»å½•æµç¨‹ äºŒæ¬¡æ ¡éªŒæŒä¹…åŒ–ä»¤ç‰Œçš„æ–¹å¼å…¶å®å·²ç»å®‰å…¨å¾ˆå¤šäº†ï¼Œä½†æ˜¯ä¾ç„¶å­˜åœ¨ç”¨æˆ·èº«ä»½è¢«ç›—ç”¨çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜å®é™…ä¸Šå¾ˆéš¾å®Œç¾è§£å†³ï¼Œæˆ‘ä»¬èƒ½åšçš„ï¼Œåªèƒ½æ˜¯å½“å‘ç”Ÿç”¨æˆ·èº«ä»½è¢«ç›—ç”¨è¿™æ ·çš„äº‹æƒ…æ—¶ï¼Œå°†æŸå¤±é™ä½åˆ°æœ€å°ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å¦ä¸€ç§æ–¹æ¡ˆï¼Œå°±æ˜¯äºŒæ¬¡æ ¡éªŒã€‚ ä¸ºäº†è®©ç”¨æˆ·ä½¿ç”¨æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¼€é€šäº†è‡ªåŠ¨ç™»å½•åŠŸèƒ½ï¼Œä½†æ˜¯è‡ªåŠ¨ç™»å½•åŠŸèƒ½åˆå¸¦æ¥äº†å®‰å…¨é£é™©ï¼Œä¸€ä¸ªè§„é¿çš„åŠæ³•å°±æ˜¯å¦‚æœç”¨æˆ·ä½¿ç”¨äº†è‡ªåŠ¨ç™»å½•åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥åªè®©ä»–åšä¸€äº›å¸¸è§„çš„ä¸æ•æ„Ÿæ“ä½œï¼Œä¾‹å¦‚æ•°æ®æµè§ˆã€æŸ¥çœ‹ï¼Œä½†æ˜¯ä¸å…è®¸ä»–åšä»»ä½•ä¿®æ”¹ã€åˆ é™¤æ“ä½œï¼Œå¦‚æœç”¨æˆ·ç‚¹å‡»äº†ä¿®æ”¹ã€åˆ é™¤æŒ‰é’®ï¼Œæˆ‘ä»¬å¯ä»¥è·³è½¬å›ç™»å½•é¡µé¢ï¼Œè®©ç”¨æˆ·é‡æ–°è¾“å…¥å¯†ç ç¡®è®¤èº«ä»½ï¼Œç„¶åå†å…è®¸ä»–æ‰§è¡Œæ•æ„Ÿæ“ä½œã€‚ è¿™ä¸ªåŠŸèƒ½åœ¨ Shiro ä¸­æœ‰ä¸€ä¸ªæ¯”è¾ƒæ–¹ä¾¿çš„è¿‡æ»¤å™¨å¯ä»¥é…ç½®ï¼ŒSpring Security å½“ç„¶ä¹Ÿä¸€æ ·ï¼Œä¾‹å¦‚æˆ‘ç°åœ¨æä¾›ä¸‰ä¸ªè®¿é—®æ¥å£ï¼š 123456789101112131415@RestControllerpublic class HelloController { @GetMapping(&quot;/hello&quot;) public String hello() { return &quot;hello&quot;; } @GetMapping(&quot;/admin&quot;) public String admin() { return &quot;admin&quot;; } @GetMapping(&quot;/rememberme&quot;) public String rememberme() { return &quot;rememberme&quot;; }} ç¬¬ä¸€ä¸ª /hello æ¥å£ï¼Œåªè¦è®¤è¯åå°±å¯ä»¥è®¿é—®ï¼Œæ— è®ºæ˜¯é€šè¿‡ç”¨æˆ·åå¯†ç è®¤è¯è¿˜æ˜¯é€šè¿‡è‡ªåŠ¨ç™»å½•è®¤è¯ï¼Œåªè¦è®¤è¯äº†ï¼Œå°±å¯ä»¥è®¿é—®ã€‚ ç¬¬äºŒä¸ª /admin æ¥å£ï¼Œå¿…é¡»è¦ç”¨æˆ·åå¯†ç è®¤è¯ä¹‹åæ‰èƒ½è®¿é—®ï¼Œå¦‚æœç”¨æˆ·æ˜¯é€šè¿‡è‡ªåŠ¨ç™»å½•è®¤è¯çš„ï¼Œåˆ™å¿…é¡»é‡æ–°è¾“å…¥ç”¨æˆ·åå¯†ç æ‰èƒ½è®¿é—®è¯¥æ¥å£ã€‚ ç¬¬ä¸‰ä¸ª /rememberme æ¥å£ï¼Œå¿…é¡»æ˜¯é€šè¿‡è‡ªåŠ¨ç™»å½•è®¤è¯åæ‰èƒ½è®¿é—®ï¼Œå¦‚æœç”¨æˆ·æ˜¯é€šè¿‡ç”¨æˆ·å/å¯†ç è®¤è¯çš„ï¼Œåˆ™æ— æ³•è®¿é—®è¯¥æ¥å£ã€‚ 123456789101112131415@Overrideprotected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .antMatchers(&quot;/rememberme&quot;).rememberMe() .antMatchers(&quot;/admin&quot;).fullyAuthenticated() .anyRequest().authenticated() .and() .formLogin() .and() .rememberMe() .key(&quot;wenx&quot;) .tokenRepository(jdbcTokenRepository()) .and() .csrf().disable();} å¯ä»¥çœ‹åˆ°ï¼š /rememberme æ¥å£æ˜¯éœ€è¦ rememberMe æ‰èƒ½è®¿é—®ã€‚ /admin æ˜¯éœ€è¦ fullyAuthenticatedï¼ŒfullyAuthenticated ä¸åŒäº authenticatedï¼ŒfullyAuthenticated ä¸åŒ…å«è‡ªåŠ¨ç™»å½•çš„å½¢å¼ï¼Œè€Œ authenticated åŒ…å«è‡ªåŠ¨ç™»å½•çš„å½¢å¼ã€‚ æœ€åå‰©ä½™çš„æ¥å£ï¼ˆ/helloï¼‰éƒ½æ˜¯ authenticated å°±èƒ½è®¿é—®ã€‚","link":"/2022/08/25/08-%E7%AE%80%E6%98%93%E6%90%AD%E5%BB%BA%20Security%20%E5%9F%BA%E4%BA%8E%20RememberMe%20%E7%99%BB%E5%BD%95/"},{"title":"Spring Security è‡ªå®šä¹‰è®¤è¯é€»è¾‘","text":"è®¤è¯æµç¨‹ç®€æAuthenticationProvider å®šä¹‰äº† Spring Security ä¸­çš„éªŒè¯é€»è¾‘ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ AuthenticationProvider çš„å®šä¹‰ï¼š 12345public interface AuthenticationProvider { Authentication authenticate(Authentication authentication) throws AuthenticationException; boolean supports(Class&lt;?&gt; authentication);} å¯ä»¥çœ‹åˆ°ï¼ŒAuthenticationProvider ä¸­å°±ä¸¤ä¸ªæ–¹æ³•ï¼š authenticate æ–¹æ³•ç”¨æ¥åšéªŒè¯ï¼Œå°±æ˜¯éªŒè¯ç”¨æˆ·èº«ä»½ã€‚ supports åˆ™ç”¨æ¥åˆ¤æ–­å½“å‰çš„ AuthenticationProvider æ˜¯å¦æ”¯æŒå¯¹åº”çš„ Authenticationã€‚ è¿™é‡Œåˆæ¶‰åŠåˆ°ä¸€ä¸ªä¸œè¥¿ï¼Œå°±æ˜¯ Authenticationã€‚ ç©è¿‡ Spring Security çš„å°ä¼™ä¼´éƒ½çŸ¥é“ï¼Œåœ¨ Spring Security ä¸­æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„å¯¹è±¡å«åš Authenticationï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹æ³¨å…¥ Authentication è¿›è€Œè·å–åˆ°å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ŒAuthentication æœ¬èº«æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒå®é™…ä¸Šå¯¹ java.security.Principal åšçš„è¿›ä¸€æ­¥å°è£…ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ Authentication çš„å®šä¹‰ï¼š 12345678public interface Authentication extends Principal, Serializable { Collection&lt;? extends GrantedAuthority&gt; getAuthorities(); Object getCredentials(); Object getDetails(); Object getPrincipal(); boolean isAuthenticated(); void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException;} å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ¥å£ä¸­çš„æ–¹æ³•ä¹Ÿæ²¡å‡ ä¸ªï¼Œæˆ‘æ¥å¤§æ¦‚è§£é‡Šä¸‹ï¼š getAuthorities æ–¹æ³•ç”¨æ¥è·å–ç”¨æˆ·çš„æƒé™ã€‚ getCredentials æ–¹æ³•ç”¨æ¥è·å–ç”¨æˆ·å‡­è¯ï¼Œä¸€èˆ¬æ¥è¯´å°±æ˜¯å¯†ç ã€‚ getDetails æ–¹æ³•ç”¨æ¥è·å–ç”¨æˆ·æºå¸¦çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯èƒ½æ˜¯å½“å‰è¯·æ±‚ä¹‹ç±»çš„ä¸œè¥¿ã€‚ getPrincipal æ–¹æ³•ç”¨æ¥è·å–å½“å‰ç”¨æˆ·ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªç”¨æˆ·åï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªç”¨æˆ·å¯¹è±¡ã€‚ isAuthenticated å½“å‰ç”¨æˆ·æ˜¯å¦è®¤è¯æˆåŠŸã€‚ Authentication ä½œä¸ºä¸€ä¸ªæ¥å£ï¼Œå®ƒå®šä¹‰äº†ç”¨æˆ·ï¼Œæˆ–è€…è¯´ Principal çš„ä¸€äº›åŸºæœ¬è¡Œä¸ºï¼Œå®ƒæœ‰å¾ˆå¤šå®ç°ç±»ã€‚ åœ¨è¿™äº›å®ç°ç±»ä¸­ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„å°±æ˜¯ UsernamePasswordAuthenticationToken äº†ï¼Œè€Œæ¯ä¸€ä¸ª Authentication éƒ½æœ‰é€‚åˆå®ƒçš„ AuthenticationProvider å»å¤„ç†æ ¡éªŒã€‚ä¾‹å¦‚å¤„ç† UsernamePasswordAuthenticationToken çš„ AuthenticationProvider æ˜¯ DaoAuthenticationProviderã€‚ æ‰€ä»¥å¤§å®¶åœ¨ AuthenticationProvider ä¸­çœ‹åˆ°ä¸€ä¸ª supports æ–¹æ³•ï¼Œå°±æ˜¯ç”¨æ¥åˆ¤æ–­ AuthenticationProvider æ˜¯å¦æ”¯æŒå½“å‰ Authenticationã€‚ åœ¨ä¸€æ¬¡å®Œæ•´çš„è®¤è¯ä¸­ï¼Œå¯èƒ½åŒ…å«å¤šä¸ª AuthenticationProviderï¼Œè€Œè¿™å¤šä¸ª AuthenticationProvider åˆ™ç”± ProviderManager è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚ è¿™é‡Œæˆ‘ä»¬æ¥é‡ç‚¹çœ‹ä¸€ä¸‹ DaoAuthenticationProviderï¼Œå› ä¸ºè¿™æ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„ä¸€ä¸ªï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ç”¨æˆ·å/å¯†ç ç™»å½•çš„æ—¶å€™ï¼Œç”¨çš„å°±æ˜¯å®ƒï¼ŒDaoAuthenticationProvider çš„çˆ¶ç±»æ˜¯ AbstractUserDetailsAuthenticationProviderï¼Œæˆ‘ä»¬å°±å…ˆä»å®ƒçš„çˆ¶ç±»çœ‹èµ·ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566public abstract class AbstractUserDetailsAuthenticationProvider implements AuthenticationProvider, InitializingBean, MessageSourceAware { public Authentication authenticate(Authentication authentication) throws AuthenticationException { String username = (authentication.getPrincipal() == null) ? &quot;NONE_PROVIDED&quot; : authentication.getName(); boolean cacheWasUsed = true; UserDetails user = this.userCache.getUserFromCache(username); if (user == null) { cacheWasUsed = false; try { user = retrieveUser(username, (UsernamePasswordAuthenticationToken) authentication); } catch (UsernameNotFoundException notFound) { logger.debug(&quot;User '&quot; + username + &quot;' not found&quot;); if (hideUserNotFoundExceptions) { throw new BadCredentialsException(messages.getMessage( &quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;, &quot;Bad credentials&quot;)); } else { throw notFound; } } } try { preAuthenticationChecks.check(user); additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken) authentication); } catch (AuthenticationException exception) { if (cacheWasUsed) { cacheWasUsed = false; user = retrieveUser(username, (UsernamePasswordAuthenticationToken) authentication); preAuthenticationChecks.check(user); additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken) authentication); } else { throw exception; } } postAuthenticationChecks.check(user); if (!cacheWasUsed) { this.userCache.putUserInCache(user); } Object principalToReturn = user; if (forcePrincipalAsString) { principalToReturn = user.getUsername(); } return createSuccessAuthentication(principalToReturn, authentication, user); } public boolean supports(Class&lt;?&gt; authentication) { return (UsernamePasswordAuthenticationToken.class .isAssignableFrom(authentication)); }} AbstractUserDetailsAuthenticationProvider çš„ä»£ç è¿˜æ˜¯æŒºé•¿çš„ï¼Œè¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸¤ä¸ªæ–¹æ³•ï¼šauthenticate å’Œ supportsã€‚ authenticate æ–¹æ³•å°±æ˜¯ç”¨æ¥åšè®¤è¯çš„æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥ç®€å•çœ‹ä¸‹æ–¹æ³•æµç¨‹ï¼š é¦–å…ˆä» Authentication æå–å‡ºç™»å½•ç”¨æˆ·åã€‚ ç„¶åé€šè¿‡æ‹¿ç€ username å»è°ƒç”¨ retrieveUser æ–¹æ³•å»è·å–å½“å‰ç”¨æˆ·å¯¹è±¡ï¼Œè¿™ä¸€æ­¥ä¼šè°ƒç”¨æˆ‘ä»¬è‡ªå·±åœ¨ç™»å½•æ—¶å€™çš„å†™çš„ loadUserByUsername æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œè¿”å›çš„ user å…¶å®å°±æ˜¯ä½ çš„ç™»å½•å¯¹è±¡ æ¥ä¸‹æ¥è°ƒç”¨ preAuthenticationChecks.check æ–¹æ³•å»æ£€éªŒ user ä¸­çš„å„ä¸ªè´¦æˆ·çŠ¶æ€å±æ€§æ˜¯å¦æ­£å¸¸ï¼Œä¾‹å¦‚è´¦æˆ·æ˜¯å¦è¢«ç¦ç”¨ã€è´¦æˆ·æ˜¯å¦è¢«é”å®šã€è´¦æˆ·æ˜¯å¦è¿‡æœŸç­‰ç­‰ã€‚ additionalAuthenticationChecks æ–¹æ³•åˆ™æ˜¯åšå¯†ç æ¯”å¯¹çš„ï¼Œå¥½å¤šå°ä¼™ä¼´å¥½å¥‡ Spring Security çš„å¯†ç åŠ å¯†ä¹‹åï¼Œæ˜¯å¦‚ä½•è¿›è¡Œæ¯”è¾ƒçš„ï¼Œçœ‹è¿™é‡Œå°±æ‡‚äº†ï¼Œå› ä¸ºæ¯”è¾ƒçš„é€»è¾‘å¾ˆç®€å•ï¼Œæˆ‘è¿™é‡Œå°±ä¸è´´ä»£ç å‡ºæ¥äº†ã€‚ä½†æ˜¯æ³¨æ„ï¼ŒadditionalAuthenticationChecks æ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“çš„å®ç°æ˜¯åœ¨ AbstractUserDetailsAuthenticationProvider çš„å­ç±»ä¸­å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯ DaoAuthenticationProviderã€‚è¿™ä¸ªå…¶å®å¾ˆå¥½ç†è§£ï¼Œå› ä¸º AbstractUserDetailsAuthenticationProvider ä½œä¸ºä¸€ä¸ªè¾ƒé€šç”¨çš„çˆ¶ç±»ï¼Œå¤„ç†ä¸€äº›é€šç”¨çš„è¡Œä¸ºï¼Œæˆ‘ä»¬åœ¨ç™»å½•çš„æ—¶å€™ï¼Œæœ‰çš„ç™»å½•æ–¹å¼å¹¶ä¸éœ€è¦å¯†ç ï¼Œæ‰€ä»¥ additionalAuthenticationChecks æ–¹æ³•ä¸€èˆ¬äº¤ç»™å®ƒçš„å­ç±»å»å®ç°ï¼Œåœ¨ DaoAuthenticationProvider ç±»ä¸­ï¼ŒadditionalAuthenticationChecks æ–¹æ³•å°±æ˜¯åšå¯†ç æ¯”å¯¹çš„ï¼Œåœ¨å…¶ä»–çš„ AuthenticationProvider ä¸­ï¼ŒadditionalAuthenticationChecks æ–¹æ³•çš„ä½œç”¨å°±ä¸ä¸€å®šäº†ã€‚ æœ€ååœ¨ postAuthenticationChecks.check æ–¹æ³•ä¸­æ£€æŸ¥å¯†ç æ˜¯å¦è¿‡æœŸã€‚ æ¥ä¸‹æ¥æœ‰ä¸€ä¸ª forcePrincipalAsString å±æ€§ï¼Œè¿™ä¸ªæ˜¯æ˜¯å¦å¼ºåˆ¶å°† Authentication ä¸­çš„ principal å±æ€§è®¾ç½®ä¸ºå­—ç¬¦ä¸²ï¼Œè¿™ä¸ªå±æ€§æˆ‘ä»¬ä¸€å¼€å§‹åœ¨ UsernamePasswordAuthenticationFilter ç±»ä¸­å…¶å®å°±æ˜¯è®¾ç½®ä¸ºå­—ç¬¦ä¸²çš„ï¼ˆå³ usernameï¼‰ï¼Œä½†æ˜¯é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åï¼Œ è¿™ä¸ªå±æ€§çš„å€¼å°±å˜æˆå½“å‰ç”¨æˆ·è¿™ä¸ªå¯¹è±¡äº†ã€‚ä¹‹æ‰€ä»¥ä¼šè¿™æ ·ï¼Œå°±æ˜¯å› ä¸º forcePrincipalAsString é»˜è®¤ä¸º falseï¼Œä¸è¿‡è¿™å—å…¶å®ä¸ç”¨æ”¹ï¼Œå°±ç”¨ falseï¼Œè¿™æ ·åœ¨åæœŸè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯çš„æ—¶å€™åè€Œæ–¹ä¾¿å¾ˆå¤šã€‚ æœ€åï¼Œé€šè¿‡ createSuccessAuthentication æ–¹æ³•æ„å»ºä¸€ä¸ªæ–°çš„ UsernamePasswordAuthenticationTokenã€‚ supports æ–¹æ³•å°±æ¯”è¾ƒç®€å•äº†ï¼Œä¸»è¦ç”¨æ¥åˆ¤æ–­å½“å‰çš„ Authentication æ˜¯å¦æ˜¯ UsernamePasswordAuthenticationTokenã€‚ ç”±äº AbstractUserDetailsAuthenticationProvider å·²ç»æŠŠ authenticate å’Œ supports æ–¹æ³•å®ç°äº†ï¼Œæ‰€ä»¥åœ¨ DaoAuthenticationProvider ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ additionalAuthenticationChecks æ–¹æ³•å³å¯ï¼š 123456789101112131415161718public class DaoAuthenticationProvider extends AbstractUserDetailsAuthenticationProvider { @SuppressWarnings(&quot;deprecation&quot;) protected void additionalAuthenticationChecks(UserDetails userDetails, UsernamePasswordAuthenticationToken authentication) throws AuthenticationException { if (authentication.getCredentials() == null) { throw new BadCredentialsException(messages.getMessage( &quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;, &quot;Bad credentials&quot;)); } String presentedPassword = authentication.getCredentials().toString(); if (!passwordEncoder.matches(presentedPassword, userDetails.getPassword())) { throw new BadCredentialsException(messages.getMessage( &quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;, &quot;Bad credentials&quot;)); } }} å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼ŒadditionalAuthenticationChecks æ–¹æ³•ä¸»è¦ç”¨æ¥åšå¯†ç æ¯”å¯¹çš„ï¼Œé€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯è°ƒç”¨ PasswordEncoder çš„ matches æ–¹æ³•åšæ¯”å¯¹ï¼Œå¦‚æœå¯†ç ä¸å¯¹åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸å³å¯ã€‚ æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ç”¨æˆ·å/å¯†ç ç™»å½•ï¼Œæœ€ç»ˆéƒ½ä¼šèµ°åˆ°è¿™ä¸€æ­¥ã€‚ è€Œ AuthenticationProvider éƒ½æ˜¯é€šè¿‡ ProviderManager#authenticate æ–¹æ³•æ¥è°ƒç”¨çš„ã€‚ç”±äºæˆ‘ä»¬çš„ä¸€æ¬¡è®¤è¯å¯èƒ½ä¼šå­˜åœ¨å¤šä¸ª AuthenticationProviderï¼Œæ‰€ä»¥ï¼Œåœ¨ ProviderManager#authenticate æ–¹æ³•ä¸­ä¼šé€ä¸ªéå† AuthenticationProviderï¼Œå¹¶è°ƒç”¨ä»–ä»¬çš„ authenticate æ–¹æ³•åšè®¤è¯ï¼Œæˆ‘ä»¬æ¥ç¨å¾®ç…ä¸€çœ¼ ProviderManager#authenticate æ–¹æ³•ï¼š 123456789101112public Authentication authenticate(Authentication authentication) throws AuthenticationException { for (AuthenticationProvider provider : getProviders()) { result = provider.authenticate(authentication); if (result != null) { copyDetails(authentication, result); break; } } ... ...} å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¼šéå†æ‰€æœ‰çš„ AuthenticationProviderï¼Œå¹¶è°ƒç”¨å®ƒçš„ authenticate æ–¹æ³•è¿›è¡Œè®¤è¯ã€‚ å¥½äº†ï¼Œå¤§è‡´çš„è®¤è¯æµç¨‹è¯´å®Œä¹‹åï¼Œç›¸ä¿¡å¤§å®¶å·²ç»æ˜ç™½äº†æˆ‘ä»¬è¦ä»å“ªé‡Œä¸‹æ‰‹äº†ã€‚ è‡ªå®šä¹‰è®¤è¯æ€è·¯ä¹‹å‰æˆ‘ä»¬é€šè¿‡è‡ªå®šä¹‰è¿‡æ»¤å™¨ï¼Œå°†è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨åŠ å…¥åˆ° Spring Security è¿‡æ»¤å™¨é“¾ä¸­ï¼Œè¿›è€Œå®ç°äº†æ·»åŠ ç™»å½•éªŒè¯ç åŠŸèƒ½ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿè¯´è¿™ç§æ–¹å¼æ˜¯æœ‰å¼Šç«¯çš„ï¼Œå°±æ˜¯ç ´åäº†åŸæœ‰çš„è¿‡æ»¤å™¨é“¾ï¼Œè¯·æ±‚æ¯æ¬¡éƒ½è¦èµ°ä¸€ééªŒè¯ç è¿‡æ»¤å™¨ï¼Œè¿™æ ·ä¸åˆç†ã€‚ ç™»å½•è¯·æ±‚æ˜¯è°ƒç”¨ AbstractUserDetailsAuthenticationProvider#authenticate æ–¹æ³•è¿›è¡Œè®¤è¯çš„ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œåˆä¼šè°ƒç”¨åˆ° DaoAuthenticationProvider#additionalAuthenticationChecks æ–¹æ³•åšè¿›ä¸€æ­¥çš„æ ¡éªŒï¼Œå»æ ¡éªŒç”¨æˆ·ç™»å½•å¯†ç ã€‚æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ª AuthenticationProvider ä»£æ›¿ DaoAuthenticationProviderï¼Œå¹¶é‡å†™å®ƒé‡Œè¾¹çš„ additionalAuthenticationChecks æ–¹æ³•ï¼Œåœ¨é‡å†™çš„è¿‡ç¨‹ä¸­ï¼ŒåŠ å…¥éªŒè¯ç çš„æ ¡éªŒé€»è¾‘å³å¯ã€‚ è¿™æ ·æ—¢ä¸ç ´ååŸæœ‰çš„è¿‡æ»¤å™¨é“¾ï¼Œåˆå®ç°äº†è‡ªå®šä¹‰è®¤è¯åŠŸèƒ½ã€‚å¸¸è§çš„æ‰‹æœºå·ç åŠ¨æ€ç™»å½•ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼æ¥è®¤è¯ã€‚ ä»£ç å®ç°é¦–å…ˆæˆ‘ä»¬éœ€è¦éªŒè¯ç ï¼Œå¦‚ä¸‹ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;com.github.penggle&lt;/groupId&gt; &lt;artifactId&gt;kaptcha&lt;/artifactId&gt; &lt;version&gt;2.3.2&lt;/version&gt;&lt;/dependency&gt; ç„¶åæˆ‘ä»¬æä¾›ä¸€ä¸ªå®ä½“ç±»ç”¨æ¥æè¿°éªŒè¯ç çš„åŸºæœ¬ä¿¡æ¯ï¼š 123456789101112@BeanProducer verifyCode() { Properties properties = new Properties(); properties.setProperty(&quot;kaptcha.image.width&quot;, &quot;150&quot;); properties.setProperty(&quot;kaptcha.image.height&quot;, &quot;50&quot;); properties.setProperty(&quot;kaptcha.textproducer.char.string&quot;, &quot;0123456789&quot;); properties.setProperty(&quot;kaptcha.textproducer.char.length&quot;, &quot;4&quot;); Config config = new Config(properties); DefaultKaptcha defaultKaptcha = new DefaultKaptcha(); defaultKaptcha.setConfig(config); return defaultKaptcha;} è¿™æ®µé…ç½®å¾ˆç®€å•ï¼Œæˆ‘ä»¬å°±æ˜¯æä¾›äº†éªŒè¯ç å›¾ç‰‡çš„å®½é«˜ã€å­—ç¬¦åº“ä»¥åŠç”Ÿæˆçš„éªŒè¯ç å­—ç¬¦é•¿åº¦ã€‚ æ¥ä¸‹æ¥æä¾›ä¸€ä¸ªè¿”å›éªŒè¯ç å›¾ç‰‡çš„æ¥å£ï¼š 123456789101112131415@RestControllerpublic class VerifyCodeController { @Autowired Producer producer; @GetMapping(&quot;/vc.jpg&quot;) public void getVerifyCode(HttpServletResponse resp, HttpSession session) throws IOException { resp.setContentType(&quot;image/jpeg&quot;); String text = producer.createText(); session.setAttribute(&quot;verify_code&quot;, text); BufferedImage image = producer.createImage(text); try(ServletOutputStream out = resp.getOutputStream()) { ImageIO.write(image, &quot;jpg&quot;, out); } }} è¿™é‡Œæˆ‘ä»¬ç”ŸæˆéªŒè¯ç å›¾ç‰‡ï¼Œå¹¶å°†ç”Ÿæˆçš„éªŒè¯ç å­—ç¬¦å­˜å…¥ HttpSession ä¸­ã€‚æ³¨æ„è¿™é‡Œæˆ‘ç”¨åˆ°äº† try-with-resources ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è‡ªå®šä¹‰ä¸€ä¸ª MyAuthenticationProvider ç»§æ‰¿è‡ª DaoAuthenticationProviderï¼Œå¹¶é‡å†™ additionalAuthenticationChecks æ–¹æ³•ï¼š 12345678910111213public class MyAuthenticationProvider extends DaoAuthenticationProvider { @Override protected void additionalAuthenticationChecks(UserDetails userDetails, UsernamePasswordAuthenticationToken authentication) throws AuthenticationException { HttpServletRequest req = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest(); String code = req.getParameter(&quot;code&quot;); String verify_code = (String) req.getSession().getAttribute(&quot;verify_code&quot;); if (code == null || verify_code == null || !code.equals(verify_code)) { throw new AuthenticationServiceException(&quot;éªŒè¯ç é”™è¯¯&quot;); } super.additionalAuthenticationChecks(userDetails, authentication); }} åœ¨ additionalAuthenticationChecks æ–¹æ³•ä¸­ï¼š é¦–å…ˆè·å–å½“å‰è¯·æ±‚ï¼Œæ³¨æ„è¿™ç§è·å–æ–¹å¼ï¼Œåœ¨åŸºäº Spring çš„ web é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥éšæ—¶éšåœ°è·å–åˆ°å½“å‰è¯·æ±‚ï¼Œè·å–æ–¹å¼å°±æ˜¯æˆ‘ä¸Šé¢ç»™å‡ºçš„ä»£ç ã€‚ ä»å½“å‰è¯·æ±‚ä¸­æ‹¿åˆ° code å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·ä¼ æ¥çš„éªŒè¯ç ã€‚ ä» session ä¸­è·å–ç”Ÿæˆçš„éªŒè¯ç å­—ç¬¦ä¸²ã€‚ ä¸¤è€…è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœéªŒè¯ç è¾“å…¥é”™è¯¯ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚ æœ€åé€šè¿‡ super è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ DaoAuthenticationProvider çš„ additionalAuthenticationChecks æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­ä¸»è¦åšå¯†ç çš„æ ¡éªŒã€‚ MyAuthenticationProvider å®šä¹‰å¥½ä¹‹åï¼Œæ¥ä¸‹æ¥ä¸»è¦æ˜¯å¦‚ä½•è®© MyAuthenticationProvider ä»£æ›¿ DaoAuthenticationProviderã€‚ å‰é¢æˆ‘ä»¬è¯´ï¼Œæ‰€æœ‰çš„ AuthenticationProvider éƒ½æ˜¯æ”¾åœ¨ ProviderManager ä¸­ç»Ÿä¸€ç®¡ç†çš„ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦è‡ªå·±æä¾› ProviderManagerï¼Œç„¶åæ³¨å…¥è‡ªå®šä¹‰çš„ MyAuthenticationProviderï¼Œè¿™ä¸€åˆ‡æ“ä½œéƒ½åœ¨ SecurityConfig ä¸­å®Œæˆï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556@Configurationpublic class SecurityConfig extends WebSecurityConfigurerAdapter { @Bean PasswordEncoder passwordEncoder() { return NoOpPasswordEncoder.getInstance(); } @Bean MyAuthenticationProvider myAuthenticationProvider() { MyAuthenticationProvider myAuthenticationProvider = new MyAuthenticationProvider(); myAuthenticationProvider.setPasswordEncoder(passwordEncoder()); myAuthenticationProvider.setUserDetailsService(userDetailsService()); return myAuthenticationProvider; } @Override @Bean protected AuthenticationManager authenticationManager() throws Exception { ProviderManager manager = new ProviderManager(Arrays.asList(myAuthenticationProvider())); return manager; } @Bean @Override protected UserDetailsService userDetailsService() { InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager(); manager.createUser(User.withUsername(&quot;admin&quot;).password(&quot;123&quot;).roles(&quot;admin&quot;).build()); return manager; } @Override protected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .antMatchers(&quot;/vc.jpg&quot;).permitAll() .anyRequest().authenticated() .and() .formLogin() .successHandler((req, resp, auth) -&gt; { resp.setContentType(&quot;application/json;charset=utf-8&quot;); PrintWriter out = resp.getWriter(); out.write(new ObjectMapper().writeValueAsString(RespBean.ok(&quot;success&quot;, auth.getPrincipal()))); out.flush(); out.close(); }) .failureHandler((req, resp, e) -&gt; { resp.setContentType(&quot;application/json;charset=utf-8&quot;); PrintWriter out = resp.getWriter(); out.write(new ObjectMapper().writeValueAsString(RespBean.error(e.getMessage()))); out.flush(); out.close(); }) .permitAll() .and() .csrf().disable(); }} è¿™é‡Œçš„ä»£ç æˆ‘ç¨ä½œè§£é‡Šï¼š æˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ª MyAuthenticationProvider çš„å®ä¾‹ï¼Œåˆ›å»ºè¯¥å®ä¾‹æ—¶ï¼Œéœ€è¦æä¾› UserDetailService å’Œ PasswordEncoder å®ä¾‹ã€‚ é€šè¿‡é‡å†™ authenticationManager æ–¹æ³•æ¥æä¾›ä¸€ä¸ªè‡ªå·±çš„ AuthenticationManagerï¼Œå®é™…ä¸Šå°±æ˜¯ ProviderManagerï¼Œåœ¨åˆ›å»º ProviderManager æ—¶ï¼ŒåŠ å…¥è‡ªå·±çš„ myAuthenticationProviderã€‚ è¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘å°†ç”¨æˆ·ç›´æ¥å­˜åœ¨å†…å­˜ä¸­ï¼Œæä¾›ä¸€ä¸ª UserDetailsService å®ä¾‹å³å¯ã€‚ æœ€åå°±ç®€å•é…ç½®ä¸€ä¸‹å„ç§å›è°ƒå³å¯ï¼Œå¦å¤–è®°å¾—è®¾ç½® /vc.jpg ä»»ä½•äººéƒ½èƒ½è®¿é—®ã€‚ å¥½äº†ï¼Œå¦‚æ­¤ä¹‹åï¼Œåœ¨ä¸éœ€è¦ä¿®æ”¹åŸç”Ÿè¿‡æ»¤å™¨é“¾çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åµŒå…¥äº†è‡ªå·±çš„è®¤è¯é€»è¾‘ã€‚ æµ‹è¯•é¦–å…ˆé€šè¿‡ postman å‘é€è·å–éªŒè¯ç è¯·æ±‚ï¼šhttp://localhost:8080/vc.jpg æˆåŠŸè·å–åˆ°éªŒè¯ç ï¼Œåœ¨å‘é€ç™»é™†è¯·æ±‚çš„æ—¶å€™æºå¸¦éªŒè¯ç ï¼Œè¿”å›å¦‚ä¸‹ï¼š 12345678910111213141516{ &quot;data&quot;: { &quot;password&quot;: null, &quot;username&quot;: &quot;admin&quot;, &quot;authorities&quot;: [ { &quot;authority&quot;: &quot;ROLE_admin&quot; } ], &quot;accountNonExpired&quot;: true, &quot;accountNonLocked&quot;: true, &quot;credentialsNonExpired&quot;: true, &quot;enabled&quot;: true }, &quot;mes&quot;: &quot;success&quot;}","link":"/2022/08/25/09-%E7%AE%80%E6%98%93%E6%90%AD%E5%BB%BA%20Security%20%E5%9F%BA%E4%BA%8E%20%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81%E9%80%BB%E8%BE%91%20%E7%99%BB%E5%BD%95/"},{"title":"Spring Security è‡ªå®šä¹‰è®¤è¯é€»è¾‘åŸºç¡€ä¸Šä¿å­˜ç”¨æˆ·è¯¦ç»†ä¿¡æ¯","text":"1. AuthenticationAuthentication æ¥å£ç”¨æ¥ä¿å­˜æˆ‘ä»¬çš„ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œå®é™…ä¸Šï¼Œå®ƒæ˜¯å¯¹ä¸»ä½“ï¼ˆjava.security.Principalï¼‰åšäº†è¿›ä¸€æ­¥çš„å°è£…ã€‚ æˆ‘ä»¬æ¥çœ‹ä¸‹ Authentication çš„ä¸€ä¸ªå®šä¹‰ï¼š 12345678public interface Authentication extends Principal, Serializable { Collection&lt;? extends GrantedAuthority&gt; getAuthorities(); Object getCredentials(); Object getDetails(); Object getPrincipal(); boolean isAuthenticated(); void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException;} æ¥å£çš„è§£é‡Šå¦‚ä¸‹ï¼š getAuthorities æ–¹æ³•ç”¨æ¥è·å–ç”¨æˆ·çš„æƒé™ã€‚ getCredentials æ–¹æ³•ç”¨æ¥è·å–ç”¨æˆ·å‡­è¯ï¼Œä¸€èˆ¬æ¥è¯´å°±æ˜¯å¯†ç ã€‚ getDetails æ–¹æ³•ç”¨æ¥è·å–ç”¨æˆ·æºå¸¦çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯èƒ½æ˜¯å½“å‰è¯·æ±‚ä¹‹ç±»çš„ä¸œè¥¿ã€‚ getPrincipal æ–¹æ³•ç”¨æ¥è·å–å½“å‰ç”¨æˆ·ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªç”¨æˆ·åï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªç”¨æˆ·å¯¹è±¡ã€‚ isAuthenticated å½“å‰ç”¨æˆ·æ˜¯å¦è®¤è¯æˆåŠŸã€‚ è¿™é‡Œæœ‰ä¸€ä¸ªæ¯”è¾ƒå¥½ç©çš„æ–¹æ³•ï¼Œå«åš getDetailsã€‚å…³äºè¿™ä¸ªæ–¹æ³•ï¼Œæºç çš„è§£é‡Šå¦‚ä¸‹ï¼š Stores additional details about the authentication request. These might be an IP address, certificate serial number etc. ä»è¿™æ®µè§£é‡Šä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¯¥æ–¹æ³•å®é™…ä¸Šå°±æ˜¯ç”¨æ¥å­˜å‚¨æœ‰å…³èº«ä»½è®¤è¯çš„å…¶ä»–ä¿¡æ¯çš„ï¼Œä¾‹å¦‚ IP åœ°å€ã€è¯ä¹¦ä¿¡æ¯ç­‰ç­‰ã€‚ å®é™…ä¸Šï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™é‡Œå­˜å‚¨çš„å°±æ˜¯ç”¨æˆ·ç™»å½•çš„ IP åœ°å€å’Œ sessionIdã€‚æˆ‘ä»¬ä»æºç è§’åº¦æ¥çœ‹ä¸‹ã€‚ 2. æºç åˆ†ææ¾å“¥çš„ SpringSecurity ç³»åˆ—å·²ç»å†™åˆ°ç¬¬ 12 ç¯‡äº†ï¼Œçœ‹äº†å‰é¢çš„æ–‡ç« ï¼Œç›¸ä¿¡å¤§å®¶å·²ç»æ˜ç™½ç”¨æˆ·ç™»å½•å¿…ç»çš„ä¸€ä¸ªè¿‡æ»¤å™¨å°±æ˜¯ UsernamePasswordAuthenticationFilterï¼Œåœ¨è¯¥ç±»çš„ attemptAuthentication æ–¹æ³•ä¸­ï¼Œå¯¹è¯·æ±‚å‚æ•°åšæå–ï¼Œåœ¨ attemptAuthentication æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨åˆ°ä¸€ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯ setDetailsã€‚ æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹ setDetails æ–¹æ³•ï¼š 1234protected void setDetails(HttpServletRequest request, UsernamePasswordAuthenticationToken authRequest) { authRequest.setDetails(authenticationDetailsSource.buildDetails(request));} UsernamePasswordAuthenticationToken æ˜¯ Authentication çš„å…·ä½“å®ç°ï¼Œæ‰€ä»¥è¿™é‡Œå®é™…ä¸Šå°±æ˜¯åœ¨è®¾ç½® detailsï¼Œè‡³äº details çš„å€¼ï¼Œåˆ™æ˜¯é€šè¿‡ authenticationDetailsSource æ¥æ„å»ºçš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ï¼š 1234567891011121314151617public class WebAuthenticationDetailsSource implements AuthenticationDetailsSource&lt;HttpServletRequest, WebAuthenticationDetails&gt; { public WebAuthenticationDetails buildDetails(HttpServletRequest context) { return new WebAuthenticationDetails(context); }}public class WebAuthenticationDetails implements Serializable { private final String remoteAddress; private final String sessionId; public WebAuthenticationDetails(HttpServletRequest request) { this.remoteAddress = request.getRemoteAddr(); HttpSession session = request.getSession(false); this.sessionId = (session != null) ? session.getId() : null; } //çœç•¥å…¶ä»–æ–¹æ³•} é»˜è®¤é€šè¿‡ WebAuthenticationDetailsSource æ¥æ„å»º WebAuthenticationDetailsï¼Œå¹¶å°†ç»“æœè®¾ç½®åˆ° Authentication çš„ details å±æ€§ä¸­å»ã€‚è€Œ WebAuthenticationDetails ä¸­å®šä¹‰çš„å±æ€§ï¼Œå¤§å®¶çœ‹ä¸€ä¸‹åŸºæœ¬ä¸Šå°±æ˜ç™½ï¼Œè¿™å°±æ˜¯ä¿å­˜äº†ç”¨æˆ·ç™»å½•åœ°å€å’Œ sessionIdã€‚ é‚£ä¹ˆçœ‹åˆ°è¿™é‡Œï¼Œå¤§å®¶åŸºæœ¬ä¸Šå°±æ˜ç™½äº†ï¼Œç”¨æˆ·ç™»å½•çš„ IP åœ°å€å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥ç›´æ¥ä» WebAuthenticationDetails ä¸­è·å–åˆ°ã€‚ æˆ‘ä¸¾ä¸€ä¸ªç®€å•ä¾‹å­ï¼Œä¾‹å¦‚æˆ‘ä»¬ç™»å½•æˆåŠŸåï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼éšæ—¶éšåœ°æ‹¿åˆ°ç”¨æˆ· IPï¼š 12345678@Servicepublic class HelloService { public void hello() { Authentication authentication = SecurityContextHolder.getContext().getAuthentication(); WebAuthenticationDetails details = (WebAuthenticationDetails) authentication.getDetails(); System.out.println(details); }} è¿™ä¸ªè·å–è¿‡ç¨‹ä¹‹æ‰€ä»¥æ”¾åœ¨ service æ¥åšï¼Œå°±æ˜¯ä¸ºäº†æ¼”ç¤ºéšæ—¶éšåœ°è¿™ä¸ªç‰¹æ€§ã€‚ç„¶åæˆ‘ä»¬åœ¨ controller ä¸­è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå½“è®¿é—®æ¥å£æ—¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ—¥å¿—ï¼š 1WebAuthenticationDetails@fffc7f0c: RemoteIpAddress: 127.0.0.1; SessionId: 303C7F254DF8B86667A2B20AA0667160 å¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ·çš„ IP åœ°å€å’Œ SessionId éƒ½ç»™å‡ºæ¥äº†ã€‚è¿™ä¸¤ä¸ªå±æ€§åœ¨ WebAuthenticationDetails ä¸­éƒ½æœ‰å¯¹åº”çš„ get æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å•ç‹¬è·å–å±æ€§å€¼ã€‚ 3. å®šåˆ¶å½“ç„¶ï¼ŒWebAuthenticationDetails ä¹Ÿå¯ä»¥è‡ªå·±å®šåˆ¶ï¼Œå› ä¸ºé»˜è®¤å®ƒåªæä¾›äº† IP å’Œ sessionid ä¸¤ä¸ªä¿¡æ¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä¿å­˜å…³äº Http è¯·æ±‚çš„æ›´å¤šä¿¡æ¯ï¼Œå°±å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ WebAuthenticationDetails æ¥å®ç°ã€‚ å¦‚æœæˆ‘ä»¬è¦å®šåˆ¶ WebAuthenticationDetailsï¼Œè¿˜è¦è¿åŒ WebAuthenticationDetailsSource ä¸€èµ·é‡æ–°å®šä¹‰ã€‚ 12345678910111213public class MyAuthenticationProvider extends DaoAuthenticationProvider { @Override protected void additionalAuthenticationChecks(UserDetails userDetails, UsernamePasswordAuthenticationToken authentication) throws AuthenticationException { HttpServletRequest req = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest(); String code = req.getParameter(&quot;code&quot;); String verify_code = (String) req.getSession().getAttribute(&quot;verify_code&quot;); if (code == null || verify_code == null || !code.equals(verify_code)) { throw new AuthenticationServiceException(&quot;éªŒè¯ç é”™è¯¯&quot;); } super.additionalAuthenticationChecks(userDetails, authentication); }} ä¸è¿‡è¿™ä¸ªéªŒè¯æ“ä½œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ”¾åœ¨è‡ªå®šä¹‰çš„ WebAuthenticationDetails ä¸­æ¥åšï¼Œæˆ‘ä»¬å®šä¹‰å¦‚ä¸‹ä¸¤ä¸ªç±»ï¼š 123456789101112131415161718192021222324public class MyWebAuthenticationDetails extends WebAuthenticationDetails { private boolean isPassed; public MyWebAuthenticationDetails(HttpServletRequest req) { super(req); String code = req.getParameter(&quot;code&quot;); String verify_code = (String) req.getSession().getAttribute(&quot;verify_code&quot;); if (code != null &amp;&amp; verify_code != null &amp;&amp; code.equals(verify_code)) { isPassed = true; } } public boolean isPassed() { return isPassed; }}@Componentpublic class MyWebAuthenticationDetailsSource implements AuthenticationDetailsSource&lt;HttpServletRequest,MyWebAuthenticationDetails&gt; { @Override public MyWebAuthenticationDetails buildDetails(HttpServletRequest context) { return new MyWebAuthenticationDetails(context); }} é¦–å…ˆæˆ‘ä»¬å®šä¹‰ MyWebAuthenticationDetailsï¼Œç”±äºå®ƒçš„æ„é€ æ–¹æ³•ä¸­ï¼Œåˆšå¥½å°±æä¾›äº† HttpServletRequest å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨è¯¥å¯¹è±¡è¿›è¡ŒéªŒè¯ç åˆ¤æ–­ï¼Œå¹¶å°†åˆ¤æ–­ç»“æœäº¤ç»™ isPassed å˜é‡ä¿å­˜ã€‚å¦‚æœæˆ‘ä»¬æƒ³æ‰©å±•å±æ€§ï¼Œåªéœ€è¦åœ¨ MyWebAuthenticationDetails ä¸­å†å»å®šä¹‰æ›´å¤šå±æ€§ï¼Œç„¶åä» HttpServletRequest ä¸­æå–å‡ºæ¥è®¾ç½®ç»™å¯¹åº”çš„å±æ€§å³å¯ï¼Œè¿™æ ·ï¼Œåœ¨ç™»å½•æˆåŠŸåå°±å¯ä»¥éšæ—¶éšåœ°è·å–è¿™äº›å±æ€§äº†ã€‚ æœ€ååœ¨ MyWebAuthenticationDetailsSource ä¸­æ„é€  MyWebAuthenticationDetails å¹¶è¿”å›ã€‚ å®šä¹‰å®Œæˆåï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨ MyAuthenticationProvider ä¸­è¿›è¡Œè°ƒç”¨äº†ï¼š 12345678910public class MyAuthenticationProvider extends DaoAuthenticationProvider { @Override protected void additionalAuthenticationChecks(UserDetails userDetails, UsernamePasswordAuthenticationToken authentication) throws AuthenticationException { if (!((MyWebAuthenticationDetails) authentication.getDetails()).isPassed()) { throw new AuthenticationServiceException(&quot;éªŒè¯ç é”™è¯¯&quot;); } super.additionalAuthenticationChecks(userDetails, authentication); }} ç›´æ¥ä» authentication ä¸­è·å–åˆ° details å¹¶è°ƒç”¨ isPassed æ–¹æ³•ï¼Œæœ‰é—®é¢˜å°±æŠ›å‡ºå¼‚å¸¸å³å¯ã€‚ æœ€åçš„é—®é¢˜å°±æ˜¯å¦‚ä½•ç”¨è‡ªå®šä¹‰çš„ MyWebAuthenticationDetailsSource ä»£æ›¿ç³»ç»Ÿé»˜è®¤çš„ WebAuthenticationDetailsSourceï¼Œå¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ SecurityConfig ä¸­ç¨ä½œå®šä¹‰å³å¯ï¼š 1234567891011@AutowiredMyWebAuthenticationDetailsSource myWebAuthenticationDetailsSource;@Overrideprotected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() ... .and() .formLogin() .authenticationDetailsSource(myWebAuthenticationDetailsSource) ...} å°† MyWebAuthenticationDetailsSource æ³¨å…¥åˆ° SecurityConfig ä¸­ï¼Œå¹¶åœ¨ formLogin ä¸­é…ç½® authenticationDetailsSource å³å¯æˆåŠŸä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ WebAuthenticationDetailsã€‚ è¿™æ ·è‡ªå®šä¹‰å®Œæˆåï¼ŒWebAuthenticationDetails ä¸­åŸæœ‰çš„åŠŸèƒ½ä¾ç„¶ä¿ç•™ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨è€åŠæ³•ç»§ç»­è·å–ç”¨æˆ· IP ä»¥åŠ sessionId ç­‰ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š 12345678@Servicepublic class HelloService { public void hello() { Authentication authentication = SecurityContextHolder.getContext().getAuthentication(); MyWebAuthenticationDetails details = (MyWebAuthenticationDetails) authentication.getDetails(); System.out.println(details); }} è¿™é‡Œç±»å‹å¼ºè½¬çš„æ—¶å€™ï¼Œè½¬ä¸º MyWebAuthenticationDetails å³å¯ã€‚","link":"/2022/08/25/10-Security%20%E5%A6%82%E4%BD%95%E5%AD%98%E5%82%A8%E7%94%A8%E6%88%B7%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF/"},{"title":"Spring Security è‡ªåŠ¨è¸¢æ‰å‰ä¸€ä¸ªç™»å½•ç”¨æˆ·","text":"1.éœ€æ±‚åˆ†æåœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯èƒ½åªå…è®¸ä¸€ä¸ªç”¨æˆ·åœ¨ä¸€ä¸ªç»ˆç«¯ä¸Šç™»å½•ï¼Œä¸€èˆ¬æ¥è¯´è¿™å¯èƒ½æ˜¯å‡ºäºå®‰å…¨æ–¹é¢çš„è€ƒè™‘ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›æƒ…å†µæ˜¯å‡ºäºä¸šåŠ¡ä¸Šçš„è€ƒè™‘ï¼Œæ¾å“¥ä¹‹å‰é‡åˆ°çš„éœ€æ±‚å°±æ˜¯ä¸šåŠ¡åŸå› è¦æ±‚ä¸€ä¸ªç”¨æˆ·åªèƒ½åœ¨ä¸€ä¸ªè®¾å¤‡ä¸Šç™»å½•ã€‚ è¦å®ç°ä¸€ä¸ªç”¨æˆ·ä¸å¯ä»¥åŒæ—¶åœ¨ä¸¤å°è®¾å¤‡ä¸Šç™»å½•ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§æ€è·¯ï¼š åæ¥çš„ç™»å½•è‡ªåŠ¨è¸¢æ‰å‰é¢çš„ç™»å½•ï¼Œå°±åƒå¤§å®¶åœ¨æ‰£æ‰£ä¸­çœ‹åˆ°çš„æ•ˆæœã€‚ å¦‚æœç”¨æˆ·å·²ç»ç™»å½•ï¼Œåˆ™ä¸å…è®¸åæ¥è€…ç™»å½•ã€‚ è¿™ç§æ€è·¯éƒ½èƒ½å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œå…·ä½“ä½¿ç”¨å“ªä¸€ä¸ªï¼Œè¿˜è¦çœ‹æˆ‘ä»¬å…·ä½“çš„éœ€æ±‚ã€‚ åœ¨ Spring Security ä¸­ï¼Œè¿™ä¸¤ç§éƒ½å¾ˆå¥½å®ç°ï¼Œä¸€ä¸ªé…ç½®å°±å¯ä»¥æå®šã€‚ 2.å…·ä½“å®ç°2.1 è¸¢æ‰å·²ç»ç™»å½•ç”¨æˆ·æƒ³è¦ç”¨æ–°çš„ç™»å½•è¸¢æ‰æ—§çš„ç™»å½•ï¼Œæˆ‘ä»¬åªéœ€è¦å°†æœ€å¤§ä¼šè¯æ•°è®¾ç½®ä¸º 1 å³å¯ï¼Œé…ç½®å¦‚ä¸‹ï¼š 12345678910111213@Overrideprotected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .anyRequest().authenticated() .and() .formLogin() .loginPage(&quot;/login.html&quot;) .permitAll() .and() .csrf().disable() .sessionManagement() .maximumSessions(1);} maximumSessions è¡¨ç¤ºé…ç½®æœ€å¤§ä¼šè¯æ•°ä¸º 1ï¼Œè¿™æ ·åé¢çš„ç™»å½•å°±ä¼šè‡ªåŠ¨è¸¢æ‰å‰é¢çš„ç™»å½•ã€‚è¿™é‡Œå…¶ä»–çš„é…ç½®éƒ½æ˜¯æˆ‘ä»¬å‰é¢æ–‡ç« è®²è¿‡çš„ï¼Œæˆ‘å°±ä¸å†é‡å¤ä»‹ç»ï¼Œæ–‡æœ«å¯ä»¥ä¸‹è½½æ¡ˆä¾‹å®Œæ•´ä»£ç ã€‚ é…ç½®å®Œæˆåï¼Œåˆ†åˆ«ç”¨ Chrome å’Œ Firefox ä¸¤ä¸ªæµè§ˆå™¨è¿›è¡Œæµ‹è¯•ï¼ˆæˆ–è€…ä½¿ç”¨ Chrome ä¸­çš„å¤šç”¨æˆ·åŠŸèƒ½ï¼‰ã€‚ Chrome ä¸Šç™»å½•æˆåŠŸåï¼Œè®¿é—® /hello æ¥å£ã€‚ Firefox ä¸Šç™»å½•æˆåŠŸåï¼Œè®¿é—® /hello æ¥å£ã€‚ åœ¨ Chrome ä¸Šå†æ¬¡è®¿é—® /hello æ¥å£ï¼Œæ­¤æ—¶ä¼šçœ‹åˆ°å¦‚ä¸‹æç¤ºï¼š 1This session has been expired (possibly due to multiple concurrent logins being attempted as the same user). å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œè¯´è¿™ä¸ª session å·²ç»è¿‡æœŸï¼ŒåŸå› åˆ™æ˜¯ç”±äºä½¿ç”¨åŒä¸€ä¸ªç”¨æˆ·è¿›è¡Œå¹¶å‘ç™»å½•ã€‚ 2.2 ç¦æ­¢æ–°çš„ç™»å½•å¦‚æœç›¸åŒçš„ç”¨æˆ·å·²ç»ç™»å½•äº†ï¼Œä½ ä¸æƒ³è¸¢æ‰ä»–ï¼Œè€Œæ˜¯æƒ³ç¦æ­¢æ–°çš„ç™»å½•æ“ä½œï¼Œé‚£ä¹Ÿå¥½åŠï¼Œé…ç½®æ–¹å¼å¦‚ä¸‹ï¼š 1234567891011121314@Overrideprotected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .anyRequest().authenticated() .and() .formLogin() .loginPage(&quot;/login.html&quot;) .permitAll() .and() .csrf().disable() .sessionManagement() .maximumSessions(1) .maxSessionsPreventsLogin(true);} æˆ‘ä»¬è¿˜éœ€è¦å†æä¾›ä¸€ä¸ª Beanï¼š 1234@BeanHttpSessionEventPublisher httpSessionEventPublisher() { return new HttpSessionEventPublisher();} ä¸ºä»€ä¹ˆè¦åŠ è¿™ä¸ª Bean å‘¢ï¼Ÿå› ä¸ºåœ¨ Spring Security ä¸­ï¼Œå®ƒæ˜¯é€šè¿‡ç›‘å¬ session çš„é”€æ¯äº‹ä»¶ï¼Œæ¥åŠæ—¶çš„æ¸…ç† session çš„è®°å½•ã€‚ç”¨æˆ·ä»ä¸åŒçš„æµè§ˆå™¨ç™»å½•åï¼Œéƒ½ä¼šæœ‰å¯¹åº”çš„ sessionï¼Œå½“ç”¨æˆ·æ³¨é”€ç™»å½•ä¹‹åï¼Œsession å°±ä¼šå¤±æ•ˆï¼Œä½†æ˜¯é»˜è®¤çš„å¤±æ•ˆæ˜¯é€šè¿‡è°ƒç”¨ StandardSession#invalidate æ–¹æ³•æ¥å®ç°çš„ï¼Œè¿™ä¸€ä¸ªå¤±æ•ˆäº‹ä»¶æ— æ³•è¢« Spring å®¹å™¨æ„ŸçŸ¥åˆ°ï¼Œè¿›è€Œå¯¼è‡´å½“ç”¨æˆ·æ³¨é”€ç™»å½•ä¹‹åï¼ŒSpring Security æ²¡æœ‰åŠæ—¶æ¸…ç†ä¼šè¯ä¿¡æ¯è¡¨ï¼Œä»¥ä¸ºç”¨æˆ·è¿˜åœ¨çº¿ï¼Œè¿›è€Œå¯¼è‡´ç”¨æˆ·æ— æ³•é‡æ–°ç™»å½•è¿›æ¥ï¼ˆå°ä¼™ä¼´ä»¬å¯ä»¥è‡ªè¡Œå°è¯•ä¸æ·»åŠ ä¸Šé¢çš„ Beanï¼Œç„¶åè®©ç”¨æˆ·æ³¨é”€ç™»å½•ä¹‹åå†é‡æ–°ç™»å½•ï¼‰ã€‚ ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œæˆ‘ä»¬æä¾›ä¸€ä¸ª HttpSessionEventPublisher ï¼Œè¿™ä¸ªç±»å®ç°äº† HttpSessionListener æ¥å£ï¼Œåœ¨è¯¥ Bean ä¸­ï¼Œå¯ä»¥å°† session åˆ›å»ºä»¥åŠé”€æ¯çš„äº‹ä»¶åŠæ—¶æ„ŸçŸ¥åˆ°ï¼Œå¹¶ä¸”è°ƒç”¨ Spring ä¸­çš„äº‹ä»¶æœºåˆ¶å°†ç›¸å…³çš„åˆ›å»ºå’Œé”€æ¯äº‹ä»¶å‘å¸ƒå‡ºå»ï¼Œè¿›è€Œè¢« Spring Security æ„ŸçŸ¥åˆ°ï¼Œè¯¥ç±»éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š 12345678public void sessionCreated(HttpSessionEvent event) { HttpSessionCreatedEvent e = new HttpSessionCreatedEvent(event.getSession()); getContext(event.getSession().getServletContext()).publishEvent(e);}public void sessionDestroyed(HttpSessionEvent event) { HttpSessionDestroyedEvent e = new HttpSessionDestroyedEvent(event.getSession()); getContext(event.getSession().getServletContext()).publishEvent(e);} 3.å®ç°åŸç†é¦–å…ˆæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ç”¨æˆ·ç™»å½•çš„è¿‡ç¨‹ä¸­ï¼Œä¼šç»è¿‡ UsernamePasswordAuthenticationFilterï¼Œè€Œ UsernamePasswordAuthenticationFilter ä¸­è¿‡æ»¤æ–¹æ³•çš„è°ƒç”¨æ˜¯åœ¨ AbstractAuthenticationProcessingFilter ä¸­è§¦å‘çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ AbstractAuthenticationProcessingFilter#doFilter æ–¹æ³•çš„è°ƒç”¨ï¼š 1234567891011121314151617181920212223242526272829public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException { HttpServletRequest request = (HttpServletRequest) req; HttpServletResponse response = (HttpServletResponse) res; if (!requiresAuthentication(request, response)) { chain.doFilter(request, response); return; } Authentication authResult; try { authResult = attemptAuthentication(request, response); if (authResult == null) { return; } sessionStrategy.onAuthentication(authResult, request, response); } catch (InternalAuthenticationServiceException failed) { unsuccessfulAuthentication(request, response, failed); return; } catch (AuthenticationException failed) { unsuccessfulAuthentication(request, response, failed); return; } // Authentication success if (continueChainBeforeSuccessfulAuthentication) { chain.doFilter(request, response); } successfulAuthentication(request, response, chain, authResult); åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨ attemptAuthentication æ–¹æ³•èµ°å®Œè®¤è¯æµç¨‹ä¹‹åï¼Œå›æ¥ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨ sessionStrategy.onAuthentication æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯ç”¨æ¥å¤„ç† session çš„å¹¶å‘é—®é¢˜çš„ã€‚å…·ä½“åœ¨ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758public class ConcurrentSessionControlAuthenticationStrategy implements MessageSourceAware, SessionAuthenticationStrategy { public void onAuthentication(Authentication authentication, HttpServletRequest request, HttpServletResponse response) { final List&lt;SessionInformation&gt; sessions = sessionRegistry.getAllSessions( authentication.getPrincipal(), false); int sessionCount = sessions.size(); int allowedSessions = getMaximumSessionsForThisUser(authentication); if (sessionCount &lt; allowedSessions) { // They haven't got too many login sessions running at present return; } if (allowedSessions == -1) { // We permit unlimited logins return; } if (sessionCount == allowedSessions) { HttpSession session = request.getSession(false); if (session != null) { // Only permit it though if this request is associated with one of the // already registered sessions for (SessionInformation si : sessions) { if (si.getSessionId().equals(session.getId())) { return; } } } // If the session is null, a new one will be created by the parent class, // exceeding the allowed number } allowableSessionsExceeded(sessions, allowedSessions, sessionRegistry); } protected void allowableSessionsExceeded(List&lt;SessionInformation&gt; sessions, int allowableSessions, SessionRegistry registry) throws SessionAuthenticationException { if (exceptionIfMaximumExceeded || (sessions == null)) { throw new SessionAuthenticationException(messages.getMessage( &quot;ConcurrentSessionControlAuthenticationStrategy.exceededAllowed&quot;, new Object[] {allowableSessions}, &quot;Maximum sessions of {0} for this principal exceeded&quot;)); } // Determine least recently used sessions, and mark them for invalidation sessions.sort(Comparator.comparing(SessionInformation::getLastRequest)); int maximumSessionsExceededBy = sessions.size() - allowableSessions + 1; List&lt;SessionInformation&gt; sessionsToBeExpired = sessions.subList(0, maximumSessionsExceededBy); for (SessionInformation session: sessionsToBeExpired) { session.expireNow(); } }} é¦–å…ˆè°ƒç”¨ sessionRegistry.getAllSessions æ–¹æ³•è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰ sessionï¼Œè¯¥æ–¹æ³•åœ¨è°ƒç”¨æ—¶ï¼Œä¼ é€’ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å½“å‰ç”¨æˆ·çš„ authenticationï¼Œå¦ä¸€ä¸ªå‚æ•° false è¡¨ç¤ºä¸åŒ…å«å·²ç»è¿‡æœŸçš„ sessionï¼ˆåœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œä¼šå°†ç”¨æˆ·çš„ sessionid å­˜èµ·æ¥ï¼Œå…¶ä¸­ key æ˜¯ç”¨æˆ·çš„ä¸»ä½“ï¼ˆprincipalï¼‰ï¼Œvalue åˆ™æ˜¯è¯¥ä¸»é¢˜å¯¹åº”çš„ sessionid ç»„æˆçš„ä¸€ä¸ªé›†åˆï¼‰ã€‚ æ¥ä¸‹æ¥è®¡ç®—å‡ºå½“å‰ç”¨æˆ·å·²ç»æœ‰å‡ ä¸ªæœ‰æ•ˆ session äº†ï¼ŒåŒæ—¶è·å–å…è®¸çš„ session å¹¶å‘æ•°ã€‚ å¦‚æœå½“å‰ session æ•°ï¼ˆsessionCountï¼‰å°äº session å¹¶å‘æ•°ï¼ˆallowedSessionsï¼‰ï¼Œåˆ™ä¸åšä»»ä½•å¤„ç†ï¼›å¦‚æœ allowedSessions çš„å€¼ä¸º -1ï¼Œè¡¨ç¤ºå¯¹ session æ•°é‡ä¸åšä»»ä½•é™åˆ¶ã€‚ å¦‚æœå½“å‰ session æ•°ï¼ˆsessionCountï¼‰ç­‰äº session å¹¶å‘æ•°ï¼ˆallowedSessionsï¼‰ï¼Œé‚£å°±å…ˆçœ‹çœ‹å½“å‰ session æ˜¯å¦ä¸ä¸º nullï¼Œå¹¶ä¸”å·²ç»å­˜åœ¨äº sessions ä¸­äº†ï¼Œå¦‚æœå·²ç»å­˜åœ¨äº†ï¼Œé‚£éƒ½æ˜¯è‡ªå®¶äººï¼Œä¸åšä»»ä½•å¤„ç†ï¼›å¦‚æœå½“å‰ session ä¸º nullï¼Œé‚£ä¹ˆæ„å‘³ç€å°†æœ‰ä¸€ä¸ªæ–°çš„ session è¢«åˆ›å»ºå‡ºæ¥ï¼Œå±Šæ—¶å½“å‰ session æ•°ï¼ˆsessionCountï¼‰å°±ä¼šè¶…è¿‡ session å¹¶å‘æ•°ï¼ˆallowedSessionsï¼‰ã€‚ å¦‚æœå‰é¢çš„ä»£ç ä¸­éƒ½æ²¡èƒ½ return æ‰ï¼Œé‚£ä¹ˆå°†è¿›å…¥ç­–ç•¥åˆ¤æ–­æ–¹æ³• allowableSessionsExceeded ä¸­ã€‚ allowableSessionsExceeded æ–¹æ³•ä¸­ï¼Œé¦–å…ˆä¼šæœ‰ exceptionIfMaximumExceeded å±æ€§ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åœ¨ SecurityConfig ä¸­é…ç½®çš„ maxSessionsPreventsLogin çš„å€¼ï¼Œé»˜è®¤ä¸º falseï¼Œå¦‚æœä¸º trueï¼Œå°±ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆè¿™æ¬¡ç™»å½•å°±å¤±è´¥äº†ï¼ˆå¯¹åº” 2.2 å°èŠ‚çš„æ•ˆæœï¼‰ï¼Œå¦‚æœä¸º falseï¼Œåˆ™å¯¹ sessions æŒ‰ç…§è¯·æ±‚æ—¶é—´è¿›è¡Œæ’åºï¼Œç„¶åå†ä½¿å¤šä½™çš„ session è¿‡æœŸå³å¯","link":"/2022/08/25/11-Spring%20Security%20%E8%87%AA%E5%8A%A8%E8%B8%A2%E6%8E%89%E5%89%8D%E4%B8%80%E4%B8%AA%E7%99%BB%E5%BD%95%E7%94%A8%E6%88%B7/"},{"title":"Hello World","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot; More info: Writing Run server1$ hexo server More info: Server Generate static files1$ hexo generate More info: Generating Deploy to remote sites1$ hexo deploy More info: Deployment","link":"/2022/11/21/hello-world/"}],"tags":[{"name":"spring-security","slug":"spring-security","link":"/tags/spring-security/"},{"name":"spring-boot spring-security","slug":"spring-boot-spring-security","link":"/tags/spring-boot-spring-security/"}],"categories":[{"name":"spring-boot spring-security","slug":"spring-boot-spring-security","link":"/categories/spring-boot-spring-security/"},{"name":"spring-boot spring-security OAuth2","slug":"spring-boot-spring-security-OAuth2","link":"/categories/spring-boot-spring-security-OAuth2/"},{"name":"spring-security","slug":"spring-security","link":"/categories/spring-security/"}],"pages":[]}